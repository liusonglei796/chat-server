# 服务接口契约 (Service Interface Contracts) 详解

本文档深度分析 `internal/service/interfaces.go`，该文件定义了 KamaChat 后端核心业务层的**标准契约**。它是 Controller 层与 Service 实现层之间的协议，使用了 Go 语言的 Interface 特性来实现解耦。

## Part 1: 领域模型与接口分类 (Domain Models & Interface Categories)

该文件不直接定义数据库模型，而是定义了操作这些模型的**行为契约**。根据业务领域，可以划分为以下六大模块。每个模块对应一个核心 Interface。

| 接口名称 (Interface) | 核心职责 (Core Responsibility) | 操作的主要数据实体 (Target Entities) |
| :--- | :--- | :--- |
| **UserService** | 用户账户全生命周期管理，包括认证、资料维护、管理后台操作。 | `User` (用户表), `UserInfo` (Redis缓存) |
| **SessionService** | 聊天会话索引管理，维护“最近联系人/群”列表。 | `Session` (会话表) |
| **GroupService** | 群组管理，包括创建、解散、成员变动、群资料修改。 | `GroupInfo`, `GroupMember` |
| **ContactService** | 社交关系链管理，处理好友申请、拉黑、列表查询。 | `Contact`, `Apply` |
| **MessageService** | 消息数据存取，负责历史记录检索和文件上传。 | `Message` (MySQL/Redis), `OSS/LocalFile` |
| **ChatRoomService** | 实时聊天室辅助，主要用于获取当前房间内的成员列表。 | `GroupMember`, `Redis Set` |

---

## Part 2: 接口方法深度解析 (Interface Function Analysis)

以下是每个接口中核心方法的契约定义与逻辑目标。

### 1. UserService (用户服务)

| 方法名 | 核心目的 (Contract Goal) | 输入/输出 (I/O) |
| :--- | :--- | :--- |
| `Login` | 账号密码登录认证，返回 Token。 | In: `LoginRequest` (Phone, Pwd)<br>Out: `LoginRespond` (Token) |
| `SmsLogin` | 短信验证码登录认证。 | In: `SmsLoginRequest`<br>Out: `LoginRespond` |
| `Register` | 新用户注册。 | In: `RegisterRequest`<br>Out: `RegisterRespond` |
| `UpdateUserInfo` | 用户自行修改昵称、头像等资料。 | In: `UpdateUserInfoRequest` |
| `AbleUsers` / `DisableUsers` | **管理员接口**：批量启用或禁用用户账号。 | In: `uuidList []string` |

### 2. SessionService (会话服务)

| 方法名 | 核心目的 (Contract Goal) | 输入/输出 (I/O) |
| :--- | :--- | :--- |
| `CreateSession` | 创建一个新的会话（幂等）。 | In: `CreateSessionRequest` (SendId, RecvId)<br>Out: `sessionId string` |
| `CheckOpenSessionAllowed` | 预检查是否允许发起会话（查黑名单、封禁状态）。 | In: `sendId, receiveId`<br>Out: `bool` (IsAllowed) |
| `GetUserSessionList` | 获取当前用户的单聊会话列表。 | In: `ownerId`<br>Out: `[]UserSessionListRespond` |
| `GetGroupSessionList` | 获取当前用户的群聊会话列表。 | In: `ownerId`<br>Out: `[]GroupSessionListRespond` |

### 3. ContactService (联系人服务)

| 方法名 | 核心目的 (Contract Goal) | 输入/输出 (I/O) |
| :--- | :--- | :--- |
| `GetUserList` | 获取我的好友列表。 | In: `userId`<br>Out: `[]MyUserListRespond` |
| `ApplyContact` | 申请添加好友。 | In: `ApplyContactRequest` |
| `PassApply` | 通过好友申请（建立双向关系）。 | In: `targetId, applicantId` |
| `BlackContact` | 拉黑好友（阻止消息和新会话）。 | In: `userId, contactId` |

### 4. GroupService (群组服务)

| 方法名 | 核心目的 (Contract Goal) | 输入/输出 (I/O) |
| :--- | :--- | :--- |
| `CreateGroup` | 创建新群组，初始成员仅包含群主。 | In: `CreateGroupRequest` |
| `LoadMyGroup` | 获取我创建的群组列表（Owner视角）。 | In: `ownerId`<br>Out: `[]LoadMyGroupRespond` |
| `EnterGroupDirectly` | 直接将用户加入群组（适用于扫码或无需验证的群）。 | In: `groupId, userId` |

### 5. MessageService (消息服务)

| 方法名 | 核心目的 (Contract Goal) | 输入/输出 (I/O) |
| :--- | :--- | :--- |
| `GetMessageList` | 获取双人聊天历史记录（支持分页或全量）。 | In: `u1, u2`<br>Out: `[]GetMessageListRespond` |
| `GetGroupMessageList` | 获取群聊历史记录。 | In: `groupId`<br>Out: `[]GetGroupMessageListRespond` |
| `UploadAvatar/File` | 处理文件上传流，依赖 Gin 上下文。 | In: `*gin.Context` (Multipart Form) |

---

## Part 3: 实现核心与全局思维 (The Essence of Implementation)

### 1. 接口作为架构边界 (Interface as Architecture Boundary)
`interfaces.go` 是应用中最稳定的文件之一。
*   **依赖倒置 (DIP)**: Controller 层（Handler）只依赖这些 Interface，而不依赖具体的 struct 实现。这使得我们可以在 `NewServices` 中随时替换具体的实现（例如从 MySQL 版切换到 MongoDB 版），而无需修改 Handler 代码。
*   **Mock 测试友好**: 因为 Handler 依赖的是接口，单元测试时可以轻松生成 Mock 对象（如 `MockUserService`），模拟各种返回结果来测试 Controller 逻辑。

### 2. DTO 穿透 (DTO Penetration)
注意接口方法的参数和返回值大量使用了 `internal/dto` 包中的结构体（如 `request.LoginRequest`）。
*   **约束**: 这意味着 Service 接口层与 HTTP 接口层耦合度较高。Service 不仅处理业务，还承担了部分适配 HTTP 请求参数的职责。
*   **优点**: 开发效率高，无需在 Controller 层做 `VO -> DomainModel` 的繁琐转换。
*   **缺点**: 如果未来要支持非 HTTP 协议（如 gRPC），可能需要对 DTO 进行拆分或适配。

### 3. 隐含的 Context 缺失
目前的接口定义中（除 MessageService 外），大部分方法没有包含 `context.Context` 参数。
*   **技术债**: 在 Go 的最佳实践中，所有涉及 I/O（数据库、Redis）的操作都应接受 `context.Context` 以支持超时控制和链路追踪。
*   **重构建议**: 如果要重写，建议将所有方法签名改为 `Login(ctx context.Context, req ...)`。
