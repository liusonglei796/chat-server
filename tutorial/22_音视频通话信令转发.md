# 22. éŸ³è§†é¢‘é€šè¯ä¿¡ä»¤è½¬å‘

> æœ¬æ•™ç¨‹å°†åˆ©ç”¨ç°æœ‰çš„ WebSocket é€šé“ï¼Œå®ç° WebRTC éŸ³è§†é¢‘é€šè¯æ‰€éœ€çš„ä¿¡ä»¤è½¬å‘æœºåˆ¶ã€‚

---

## ğŸ“Œ å­¦ä¹ ç›®æ ‡

- ç†è§£ WebRTC ä¿¡ä»¤æµç¨‹
- å®šä¹‰ä¿¡ä»¤æ¶ˆæ¯æ ¼å¼
- å®ç°ä¿¡ä»¤çš„é€æ˜è½¬å‘
- ç»“åˆæ•°æ®åº“å®ç°é€šè¯è®°å½•
- æŒæ¡éŸ³è§†é¢‘æ¶ˆæ¯ä¸å›æ˜¾çš„è®¾è®¡åŸå› 

---

## 1. WebRTC åŸç†ç®€ä»‹

WebRTC æ”¯æŒæµè§ˆå™¨ç‚¹å¯¹ç‚¹(P2P)ä¼ è¾“éŸ³è§†é¢‘æµï¼Œä½†åœ¨å»ºç«‹ P2P è¿æ¥å‰ï¼ŒåŒæ–¹éœ€è¦äº¤æ¢å…ƒæ•°æ®(SDP, Candidate)ã€‚è¿™ä¸ªäº¤æ¢è¿‡ç¨‹ç§°ä¸º**ä¿¡ä»¤(Signaling)**ã€‚

WebRTC æ ‡å‡†æœªè§„å®šä¿¡ä»¤å®ç°ï¼Œæˆ‘ä»¬ç›´æ¥å¤ç”¨ WebSocketã€‚

### 1.1 ä¿¡ä»¤äº¤äº’æµç¨‹

```mermaid
sequenceDiagram
    participant A as ç”¨æˆ· A
    participant Server as ä¿¡ä»¤æœåŠ¡å™¨
    participant B as ç”¨æˆ· B

    A->>Server: start_call (å‘èµ·é€šè¯)
    Server->>B: start_call (ä»…è½¬å‘ç»™B)
    B->>Server: receive_call (æ¥å¬)
    Server->>A: receive_call (ä»…è½¬å‘ç»™A)
    A->>Server: offer (SDP)
    Server->>B: offer (ä»…è½¬å‘)
    B->>Server: answer (SDP)
    Server->>A: answer (ä»…è½¬å‘)
    A->>Server: candidate (ICE)
    Server->>B: candidate (ä»…è½¬å‘)
    B->>Server: candidate (ICE)
    Server->>A: candidate (ä»…è½¬å‘)
    Note over A,B: P2P è¿æ¥å»ºç«‹ï¼ŒéŸ³è§†é¢‘ä¼ è¾“
```

**å…³é”®è®¾è®¡**ï¼šéŸ³è§†é¢‘ä¿¡ä»¤æ¶ˆæ¯**ä¸å›æ˜¾**ç»™å‘é€è€…ï¼Œé¿å…é‡å¤è§¦å‘é€šè¯äº‹ä»¶ã€‚

---

## 2. ä¿¡ä»¤æ•°æ®æ ¼å¼

> **ä»£ç ä½ç½®**ï¼š`internal/service/chat/channel_server.go`

å½“ `Type=2` (AudioOrVideo) æ—¶ï¼Œæ•°æ®å­˜å‚¨åœ¨ `AVdata` å­—æ®µã€‚

### 2.1 internal/dto/request/av_data_request.go

```go
package request

type AVData struct {
	MessageId string `json:"messageId"`
	Type      string `json:"type"`
}
```

### 2.2 ä¿¡ä»¤ç±»å‹

| type | å«ä¹‰ | messageId | æ˜¯å¦å­˜åº“ | è¯´æ˜ |
|------|------|-----------|---------|------|
| `start_call` | å‘èµ·é€šè¯ | PROXY | âœ… å­˜åº“ | è®°å½•é€šè¯å‘èµ·äº‹ä»¶ |
| `receive_call` | æ¥å¬é€šè¯ | PROXY | âœ… å­˜åº“ | è®°å½•é€šè¯æ¥å¬äº‹ä»¶ |
| `reject_call` | æ‹’ç»é€šè¯ | PROXY | âœ… å­˜åº“ | è®°å½•é€šè¯æ‹’ç»äº‹ä»¶ |
| `offer` | SDP Offer | PROXY | âŒ ä¸å­˜åº“ | ä»…è½¬å‘ |
| `answer` | SDP Answer | PROXY | âŒ ä¸å­˜åº“ | ä»…è½¬å‘ |
| `candidate` | ICE Candidate | PROXY | âŒ ä¸å­˜åº“ | ä»…è½¬å‘ |
| `hangup` | æŒ‚æ–­ | PROXY | âŒ ä¸å­˜åº“ | ä»…è½¬å‘ |

**å­˜åº“æ¡ä»¶**ï¼š
```go
if avData.MessageId == "PROXY" &&
   (avData.Type == "start_call" || avData.Type == "receive_call" || avData.Type == "reject_call") {
    // å­˜å…¥æ•°æ®åº“
}
```

---

## 3. ä¿¡ä»¤å“åº” DTO

### 3.1 internal/dto/respond/av_message_respond.go

```go
package respond

type AVMessageRespond struct {
	SendId     string `json:"send_id"`
	SendName   string `json:"send_name"`
	SendAvatar string `json:"send_avatar"`
	ReceiveId  string `json:"receive_id"`
	Type       int8   `json:"type"`
	Content    string `json:"content"`
	Url        string `json:"url"`
	FileType   string `json:"file_type"`
	FileName   string `json:"file_name"`
	FileSize   string `json:"file_size"`
	CreatedAt  string `json:"created_at"`
	AVdata     string `json:"av_data"`
}
```

---

## 4. ä¿¡ä»¤è½¬å‘å®ç°

### 4.1 internal/service/chat/channel_server.go

> **é‡è¦æ›´æ–°**ï¼š
> - ä½¿ç”¨ `snowflake.GenerateID()` ç”Ÿæˆ int64 UUID
> - ä½¿ç”¨ `sync.Map` ç®¡ç†å®¢æˆ·ç«¯ï¼ˆ`s.Clients.Load()`ï¼‰

```go
// handleAVMessage å¤„ç†éŸ³è§†é¢‘é€šè¯ä¿¡ä»¤
func (s *StandaloneServer) handleAVMessage(req request.ChatMessageRequest) {
	// ååºåˆ—åŒ– AVData
	var avData request.AVData
	if err := json.Unmarshal([]byte(req.AVdata), &avData); err != nil {
		zap.L().Error(err.Error())
		return
	}

	// æ„å»ºæ¶ˆæ¯æ¨¡å‹
	message := model.Message{
		Uuid:       snowflake.GenerateID(), // é›ªèŠ± ID (int64)
		SessionId:  req.SessionId,
		Type:       req.Type,
		Content:    "",
		Url:        "",
		SendId:     req.SendId,
		SendName:   req.SendName,
		SendAvatar: req.SendAvatar,
		ReceiveId:  req.ReceiveId,
		FileSize:   "",
		FileType:   "",
		FileName:   "",
		Status:     message_status_enum.Unsent,
		CreatedAt:  time.Now(),
		AVdata:     req.AVdata,
	}

	// åªæœ‰å…³é”®ä¿¡ä»¤æ‰å­˜åº“
	if avData.MessageId == "PROXY" && 
	   (avData.Type == "start_call" || avData.Type == "receive_call" || avData.Type == "reject_call") {
		message.SendAvatar = normalizePath(message.SendAvatar)
		if res := dao.GormDB.Create(&message); res.Error != nil {
			zap.L().Error(res.Error.Error())
		}
	}

	// ä»…æ”¯æŒå•èŠä¿¡ä»¤è½¬å‘
	if req.ReceiveId[0] == 'U' {
		messageRsp := respond.AVMessageRespond{
			SendId:     message.SendId,
			SendName:   message.SendName,
			SendAvatar: message.SendAvatar,
			ReceiveId:  message.ReceiveId,
			Type:       message.Type,
			Content:    message.Content,
			Url:        message.Url,
			FileSize:   message.FileSize,
			FileName:   message.FileName,
			FileType:   message.FileType,
			CreatedAt:  message.CreatedAt.Format("2006-01-02 15:04:05"),
			AVdata:     message.AVdata,
		}
		jsonMessage, _ := json.Marshal(messageRsp)

		messageBack := &MessageBack{
			Message: jsonMessage,
			Uuid:    message.Uuid,  // int64
		}

		// ä½¿ç”¨ sync.Map æŸ¥æ‰¾æ¥æ”¶è€… (è‡ªåŠ¨å¹¶å‘å®‰å…¨)
		if value, ok := s.Clients.Load(message.ReceiveId); ok {
			receiveClient := value.(*UserConn)
			receiveClient.SendBack <- messageBack
		}
		// âš ï¸ é€šè¯ä¿¡ä»¤ä¸å›æ˜¾ç»™å‘é€è€…
	}
}
```

---

## 5. ä¸ºä»€ä¹ˆéŸ³è§†é¢‘æ¶ˆæ¯ä¸å›æ˜¾?

### 5.1 æ–‡æœ¬æ¶ˆæ¯ vs éŸ³è§†é¢‘æ¶ˆæ¯

| æ¶ˆæ¯ç±»å‹ | æ˜¯å¦å›æ˜¾ | åŸå›  |
|---------|---------|------|
| æ–‡æœ¬æ¶ˆæ¯ | âœ… å›æ˜¾ | å‘é€è€…å¯èƒ½æœ‰å¤šä¸ªè®¾å¤‡åœ¨çº¿ï¼Œéœ€è¦ä¿æŒæ¶ˆæ¯åˆ—è¡¨åŒæ­¥ |
| éŸ³è§†é¢‘ä¿¡ä»¤ | âŒ ä¸å›æ˜¾ | é¿å…å‘é€è€…é‡å¤è§¦å‘é€šè¯äº‹ä»¶ |

### 5.2 å›æ˜¾çš„é—®é¢˜ç¤ºä¾‹

**é”™è¯¯åœºæ™¯**ï¼ˆå¦‚æœå›æ˜¾ï¼‰ï¼š
```
ç”¨æˆ· A ç‚¹å‡»"è§†é¢‘é€šè¯"
   â†“
å‰ç«¯å‘é€ start_call ä¿¡ä»¤
   â†“
æœåŠ¡å™¨è½¬å‘ç»™ B å¹¶å›æ˜¾ç»™ A
   â†“
A æ”¶åˆ°è‡ªå·±å‘é€çš„ start_call
   â†“
âŒ å‰ç«¯è¯¯ä»¥ä¸º B ä¹Ÿåœ¨å‘¼å« A
```

**æ­£ç¡®åœºæ™¯**ï¼ˆä¸å›æ˜¾ï¼‰ï¼š
```
ç”¨æˆ· A ç‚¹å‡»"è§†é¢‘é€šè¯"
   â†“
å‰ç«¯å‘é€ start_call + æœ¬åœ°æ˜¾ç¤º"æ­£åœ¨å‘¼å«..."
   â†“
æœåŠ¡å™¨ä»…è½¬å‘ç»™ B
   â†“
B æ”¶åˆ° start_callï¼Œæ˜¾ç¤ºæ¥ç”µç•Œé¢
   â†“
âœ… æ­£å¸¸é€šè¯æµç¨‹
```

---

## 6. å‰ç«¯å®ç°æ€è·¯

### 6.1 å‘é€ä¿¡ä»¤æ¶ˆæ¯

```javascript
function sendSignal(type, data = {}) {
    const message = {
        type: 2, // AudioOrVideo
        send_id: myUserId,
        send_name: myUserName,
        send_avatar: myAvatar,
        receive_id: remoteUserId,
        session_id: sessionId,
        av_data: JSON.stringify({
            messageId: "PROXY",
            type: type,
            ...data
        })
    };
    ws.send(JSON.stringify(message));
}
```

### 6.2 å¤„ç†æ”¶åˆ°çš„ä¿¡ä»¤

```javascript
ws.onmessage = async (event) => {
    const data = JSON.parse(event.data);
    if (data.type !== 2) return;

    const avData = JSON.parse(data.av_data);

    switch (avData.type) {
        case "start_call":
            await onStartCall(data);
            break;
        case "receive_call":
            await onReceiveCall(data);
            break;
        case "offer":
            await peerConnection.setRemoteDescription(avData.sdp);
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            sendSignal("answer", { sdp: answer });
            break;
        case "answer":
            await peerConnection.setRemoteDescription(avData.sdp);
            break;
        case "candidate":
            await peerConnection.addIceCandidate(avData.candidate);
            break;
        case "reject_call":
            closeCall();
            alert("å¯¹æ–¹æ‹’ç»äº†é€šè¯");
            break;
        case "hangup":
            closeCall();
            break;
    }
};
```

---

## 7. ICE æœåŠ¡å™¨é…ç½®

```javascript
const config = {
    iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        {
            urls: 'turn:your-turn-server.com:3478',
            username: 'username',
            credential: 'password'
        }
    ]
};
```

---

## 8. å…³é”®è®¾è®¡å†³ç­–

| å†³ç­– | è¯´æ˜ |
|-----|------|
| å¤ç”¨ WebSocket | æ— éœ€é¢å¤–å»ºç«‹ä¿¡ä»¤é€šé“ |
| é€‰æ‹©æ€§å­˜åº“ | åªå­˜ start/receive/reject |
| ä¸å›æ˜¾ä¿¡ä»¤ | é¿å…é‡å¤è§¦å‘é€šè¯äº‹ä»¶ |
| ä»…æ”¯æŒå•èŠ | ç¾¤èŠé€šè¯éœ€è¦ SFU æ¶æ„ |

---

## âœ… æ•™ç¨‹å®Œç»“

æ­å–œä½ å®Œæˆäº† **KamaChat** é¡¹ç›®çš„æ‰€æœ‰æ•™ç¨‹ï¼ğŸš€

### ä½ å·²ç»æŒæ¡äº†

- âœ… Go + Gin + GORM + Redis æŠ€æœ¯æ ˆ
- âœ… WebSocket é•¿è¿æ¥ä¸è¯»å†™åˆ†ç¦»
- âœ… å•èŠ/ç¾¤èŠæ¶ˆæ¯å³æ—¶è½¬å‘
- âœ… Channel + Kafka åŒæ¨¡å¼æ¶ˆæ¯é˜Ÿåˆ—
- âœ… é˜¿é‡Œäº‘çŸ­ä¿¡éªŒè¯ç é›†æˆ
- âœ… æ–‡ä»¶ä¸Šä¼ ä¸é™æ€èµ„æºæœåŠ¡
- âœ… HTTPS/WSS å®‰å…¨é…ç½®
- âœ… WebRTC ä¿¡ä»¤è½¬å‘æœºåˆ¶

### æ‰©å±•æ–¹å‘

1. **ç¾¤ç»„éŸ³è§†é¢‘é€šè¯**ï¼šå¼•å…¥ SFU æ¶æ„
2. **å±å¹•å…±äº«**ï¼šä½¿ç”¨ `getDisplayMedia()` API
3. **æ¶ˆæ¯åŠ å¯†**ï¼šç«¯åˆ°ç«¯åŠ å¯†(E2EE)
4. **æ¶ˆæ¯å·²è¯»å›æ‰§**ï¼šå¢åŠ å·²è¯»çŠ¶æ€åŒæ­¥
5. **ç¦»çº¿æ¨é€**ï¼šé›†æˆ FCM/APNs
6. **æ¶ˆæ¯æ’¤å›**ï¼šè½¯åˆ é™¤ + WebSocket é€šçŸ¥

---

## ğŸ“š æ¨èèµ„æº

- [WebRTC å®˜æ–¹æ–‡æ¡£](https://webrtc.org/)
- [MDN WebRTC API](https://developer.mozilla.org/en-US/docs/Web/API/WebRTC_API)
- [coturn TURN æœåŠ¡å™¨](https://github.com/coturn/coturn)
- [Gin æ¡†æ¶æ–‡æ¡£](https://gin-gonic.com/)
- [GORM æ–‡æ¡£](https://gorm.io/)

å¸Œæœ›è¿™å¥—æ•™ç¨‹èƒ½å¸®åŠ©ä½ æ„å»ºå‡ºå±äºè‡ªå·±çš„ IM ç³»ç»Ÿï¼ğŸ‰
