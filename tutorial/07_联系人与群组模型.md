# 07. è”ç³»äººä¸ç¾¤ç»„æ¨¡å‹

> æœ¬æ•™ç¨‹å°†è®¾è®¡è”ç³»äººã€å¥½å‹ç”³è¯·å’Œç¾¤ç»„ç›¸å…³çš„æ•°æ®æ¨¡å‹ã€‚

---

## ğŸ“Œ å­¦ä¹ ç›®æ ‡

- ç†è§£å³æ—¶é€šè®¯ç³»ç»Ÿçš„å…³ç³»æ¨¡å‹
- è®¾è®¡è”ç³»äººå’Œç¾¤ç»„è¡¨ç»“æ„
- æŒæ¡ç¾¤æˆå‘˜å…³è”è¡¨çš„è®¾è®¡

---

## 1. æ¨¡å‹å…³ç³»å›¾

```mermaid
erDiagram
    UserInfo ||--o{ Contact : has
    UserInfo ||--o{ Apply : sends
    UserInfo ||--o{ Apply : receives
    UserInfo ||--o{ GroupMember : joins
    GroupInfo ||--o{ GroupMember : contains
    
    Contact {
        uint id PK
        string user_id
        string contact_id
        int8 contact_type
        int8 status
    }
    
    ContactApply {
        uint id PK
        string uuid
        string applicant_id
        string target_id
        int8 contact_type
        int8 status
    }
    
    GroupInfo {
        uint id PK
        string uuid
        string name
        string owner_id
        int member_cnt
        int8 status
    }
    
    GroupMember {
        uint id PK
        string group_uuid FK
        string user_uuid FK
        int8 role
    }
```

---

## 2. è”ç³»äººæ¨¡å‹

### 2.1 internal/model/user_contact.go

```go
package model

import (
	"gorm.io/gorm"
)

type UserContact struct {
	gorm.Model
	UserId      string `gorm:"column:user_id;index;type:char(20);not null;comment:ç”¨æˆ·å”¯ä¸€id"`
	ContactId   string `gorm:"column:contact_id;index;type:char(20);not null;comment:è”ç³»äººID"`
	ContactType int8   `gorm:"column:contact_type;not null;comment:è”ç³»ç±»å‹ï¼Œ0.ç”¨æˆ·ï¼Œ1.ç¾¤èŠ"`
	Status      int8   `gorm:"column:status;not null;comment:è”ç³»çŠ¶æ€ï¼Œ0.æ­£å¸¸ï¼Œ1.æ‹‰é»‘ï¼Œ2.è¢«æ‹‰é»‘ï¼Œ3.åˆ é™¤å¥½å‹ï¼Œ4.è¢«åˆ é™¤å¥½å‹ï¼Œ5.è¢«ç¦è¨€ï¼Œ6.é€€å‡ºç¾¤èŠï¼Œ7.è¢«è¸¢å‡ºç¾¤èŠ"`
}

func (UserContact) TableName() string {
	return "user_contact"
}
```

```sql
CREATE TABLE `user_contact` (
  `id` bigint unsigned AUTO_INCREMENT,
  `created_at` datetime(3) NULL,
  `updated_at` datetime(3) NULL,
  `deleted_at` datetime(3) NULL,
  `user_id` char(20) NOT NULL COMMENT 'ç”¨æˆ·å”¯ä¸€id',
  `contact_id` char(20) NOT NULL COMMENT 'è”ç³»äººID',
  `contact_type` tinyint NOT NULL COMMENT 'è”ç³»ç±»å‹ï¼Œ0.ç”¨æˆ·ï¼Œ1.ç¾¤èŠ',
  `status` tinyint NOT NULL COMMENT 'è”ç³»çŠ¶æ€ï¼Œ0.æ­£å¸¸ï¼Œ1.æ‹‰é»‘ï¼Œ2.è¢«æ‹‰é»‘ï¼Œ3.åˆ é™¤å¥½å‹ï¼Œ4.è¢«åˆ é™¤å¥½å‹ï¼Œ5.è¢«ç¦è¨€ï¼Œ6.é€€å‡ºç¾¤èŠï¼Œ7.è¢«è¸¢å‡ºç¾¤èŠ',
  PRIMARY KEY (`id`),
  INDEX `idx_user_contact_deleted_at` (`deleted_at`),
  INDEX `idx_user_contact_user_id` (`user_id`),
  INDEX `idx_user_contact_contact_id` (`contact_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç”¨æˆ·è”ç³»äººè¡¨';
```

### 2.2 è”ç³»äººå…³ç³»è¯´æ˜

| å­—æ®µ | è¯´æ˜ |
|-----|------|
| user_id | å½“å‰ç”¨æˆ· ID (å‘èµ·å…³ç³»çš„äºº) |
| contact_id | è”ç³»äºº IDï¼ˆç”¨æˆ·æˆ–ç¾¤ç»„ï¼‰ |
| contact_type | 0=ç”¨æˆ·è”ç³»äººï¼Œ1=ç¾¤ç»„è”ç³»äºº |
| status | å…³ç³»çŠ¶æ€ï¼š0.æ­£å¸¸ï¼Œ1.æ‹‰é»‘ï¼Œ2.è¢«æ‹‰é»‘ï¼Œ3.åˆ é™¤å¥½å‹... |

**æ³¨æ„**ï¼šå¥½å‹å…³ç³»æ˜¯**åŒå‘çš„**ï¼Œæ·»åŠ å¥½å‹æ—¶éœ€è¦åˆ›å»ºä¸¤æ¡è®°å½•ã€‚

---

## 3. å¥½å‹ç”³è¯·æ¨¡å‹

### 3.1 internal/model/contact_apply.go

> **é‡è¦å˜æ›´**ï¼šå­—æ®µåä» `user_id/contacted_id` æ›´æ”¹ä¸º `applicant_id/target_id`ï¼Œè¯­ä¹‰æ›´æ¸…æ™°ã€‚

```go
package model

import (
	"time"

	"gorm.io/gorm"
)

type ContactApply struct {
	gorm.Model
	Uuid        string    `gorm:"column:uuid;uniqueIndex;type:char(20);comment:ç”³è¯·id"`
	ApplicantId string    `gorm:"column:applicant_id;index;type:char(20);not null;comment:ç”³è¯·äººID"`
	TargetId    string    `gorm:"column:target_id;index;type:char(20);not null;comment:ç›®æ ‡ID(ç”¨æˆ·/ç¾¤ç»„)"`
	ContactType int8      `gorm:"column:contact_type;not null;comment:è¢«ç”³è¯·ç±»å‹ï¼Œ0.ç”¨æˆ·ï¼Œ1.ç¾¤èŠ"`
	Status      int8      `gorm:"column:status;not null;comment:ç”³è¯·çŠ¶æ€ï¼Œ0.ç”³è¯·ä¸­ï¼Œ1.é€šè¿‡ï¼Œ2.æ‹’ç»ï¼Œ3.æ‹‰é»‘"`
	Message     string    `gorm:"column:message;type:varchar(100);comment:ç”³è¯·ä¿¡æ¯"`
	LastApplyAt time.Time `gorm:"column:last_apply_at;type:datetime;not null;comment:æœ€åç”³è¯·æ—¶é—´"`
}

func (ContactApply) TableName() string {
	return "contact_apply"
}
```

```sql
CREATE TABLE `contact_apply` (
  `id` bigint unsigned AUTO_INCREMENT,
  `created_at` datetime(3) NULL,
  `updated_at` datetime(3) NULL,
  `deleted_at` datetime(3) NULL,
  `uuid` char(20) DEFAULT NULL COMMENT 'ç”³è¯·id',
  `applicant_id` char(20) NOT NULL COMMENT 'ç”³è¯·äººID',
  `target_id` char(20) NOT NULL COMMENT 'ç›®æ ‡ID(ç”¨æˆ·/ç¾¤ç»„)',
  `contact_type` tinyint NOT NULL COMMENT 'è¢«ç”³è¯·ç±»å‹ï¼Œ0.ç”¨æˆ·ï¼Œ1.ç¾¤èŠ',
  `status` tinyint NOT NULL COMMENT 'ç”³è¯·çŠ¶æ€ï¼Œ0.ç”³è¯·ä¸­ï¼Œ1.é€šè¿‡ï¼Œ2.æ‹’ç»ï¼Œ3.æ‹‰é»‘',
  `message` varchar(100) DEFAULT NULL COMMENT 'ç”³è¯·ä¿¡æ¯',
  `last_apply_at` datetime NOT NULL COMMENT 'æœ€åç”³è¯·æ—¶é—´',
  PRIMARY KEY (`id`),
  INDEX `idx_contact_apply_deleted_at` (`deleted_at`),
  UNIQUE INDEX `idx_contact_apply_uuid` (`uuid`),
  INDEX `idx_contact_apply_applicant_id` (`applicant_id`),
  INDEX `idx_contact_apply_target_id` (`target_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='è”ç³»äººç”³è¯·è¡¨';
```

### 3.2 å­—æ®µå‘½åè¯´æ˜

| æ—§å­—æ®µå | æ–°å­—æ®µå | è¯´æ˜ |
|---------|---------|------|
| user_id | applicant_id | ç”³è¯·äºº IDï¼Œæ›´æ˜ç¡® |
| contacted_id | target_id | ç›®æ ‡ IDï¼ˆç”¨æˆ·æˆ–ç¾¤ç»„ï¼‰ï¼Œæ›´é€šç”¨ |

---

## 4. ç¾¤ç»„æ¨¡å‹

### 4.1 internal/model/group_info.go

```go
package model

import (
	"gorm.io/gorm"
)

type GroupInfo struct {
	gorm.Model
	Uuid      string `gorm:"column:uuid;uniqueIndex;type:char(20);not null;comment:ç¾¤ç»„å”¯ä¸€id"`
	Name      string `gorm:"column:name;type:varchar(20);not null;comment:ç¾¤åç§°"`
	Notice    string `gorm:"column:notice;type:varchar(500);comment:ç¾¤å…¬å‘Š"`
	MemberCnt int    `gorm:"column:member_cnt;default:1;comment:ç¾¤äººæ•°"`
	OwnerId   string `gorm:"column:owner_id;type:char(20);not null;comment:ç¾¤ä¸»uuid"`
	AddMode   int8   `gorm:"column:add_mode;default:0;comment:åŠ ç¾¤æ–¹å¼ï¼Œ0.ç›´æ¥ï¼Œ1.å®¡æ ¸"`
	Avatar    string `gorm:"column:avatar;type:char(255);default:https://cube.elemecdn.com/0/88/03b0d39583f48206768a7534e55bcpng.png;not null;comment:å¤´åƒ"`
	Status    int8   `gorm:"column:status;default:0;comment:çŠ¶æ€ï¼Œ0.æ­£å¸¸ï¼Œ1.ç¦ç”¨ï¼Œ2.è§£æ•£"`
}

func (GroupInfo) TableName() string {
	return "group_info"
}
```

```sql
CREATE TABLE `group_info` (
  `id` bigint unsigned AUTO_INCREMENT,
  `created_at` datetime(3) NULL,
  `updated_at` datetime(3) NULL,
  `deleted_at` datetime(3) NULL,
  `uuid` char(20) NOT NULL COMMENT 'ç¾¤ç»„å”¯ä¸€id',
  `name` varchar(20) NOT NULL COMMENT 'ç¾¤åç§°',
  `notice` varchar(500) DEFAULT NULL COMMENT 'ç¾¤å…¬å‘Š',
  `member_cnt` bigint DEFAULT 1 COMMENT 'ç¾¤äººæ•°',
  `owner_id` char(20) NOT NULL COMMENT 'ç¾¤ä¸»uuid',
  `add_mode` tinyint DEFAULT 0 COMMENT 'åŠ ç¾¤æ–¹å¼ï¼Œ0.ç›´æ¥ï¼Œ1.å®¡æ ¸',
  `avatar` char(255) NOT NULL DEFAULT 'https://cube.elemecdn.com/0/88/03b0d39583f48206768a7534e55bcpng.png' COMMENT 'å¤´åƒ',
  `status` tinyint DEFAULT 0 COMMENT 'çŠ¶æ€ï¼Œ0.æ­£å¸¸ï¼Œ1.ç¦ç”¨ï¼Œ2.è§£æ•£',
  PRIMARY KEY (`id`),
  INDEX `idx_group_info_deleted_at` (`deleted_at`),
  UNIQUE INDEX `idx_group_info_uuid` (`uuid`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç¾¤ç»„ä¿¡æ¯è¡¨';
```

### 4.2 internal/model/group_member.go

> **é‡è¦è®¾è®¡è¯´æ˜**
>
> **å…³è”è¡¨è®¾è®¡**ï¼šä½¿ç”¨ç‹¬ç«‹çš„ `GroupMember` è¡¨å­˜å‚¨ç¾¤æˆå‘˜å…³ç³»ï¼Œè€Œä¸æ˜¯åœ¨ `GroupInfo` ä¸­ä½¿ç”¨ JSON å­—æ®µã€‚

**è®¾è®¡ä¼˜åŠ¿**ï¼š
- âœ… æ”¯æŒå¹¶å‘å®‰å…¨çš„æˆå‘˜å¢åˆ 
- âœ… é«˜æ•ˆæŸ¥è¯¢"æˆ‘åŠ å…¥çš„ç¾¤"ï¼ˆé€šè¿‡ç´¢å¼•ï¼‰
- âœ… å¯ä»¥å­˜å‚¨æˆå‘˜è§’è‰²ç­‰é¢å¤–ä¿¡æ¯
- âœ… ä¾¿äºå®ç°ç¾¤æˆå‘˜ç®¡ç†åŠŸèƒ½ï¼ˆè¸¢äººã€è®¾ç½®ç®¡ç†å‘˜ç­‰ï¼‰

```go
package model

import "gorm.io/gorm"

// GroupMember ç¾¤æˆå‘˜å…³è”è¡¨
type GroupMember struct {
	gorm.Model
	GroupUuid string `gorm:"type:char(20);index;not null;comment:ç¾¤ç»„ID"`
	UserUuid  string `gorm:"type:char(20);index;not null;comment:ç”¨æˆ·ID"`
	Role      int8   `gorm:"default:1;comment:1æ™®é€šæˆå‘˜ 2ç®¡ç†å‘˜ 3ç¾¤ä¸»"`
}

func (GroupMember) TableName() string {
	return "group_member"
}
```

```sql
CREATE TABLE `group_member` (
  `id` bigint unsigned AUTO_INCREMENT,
  `created_at` datetime(3) NULL,
  `updated_at` datetime(3) NULL,
  `deleted_at` datetime(3) NULL,
  `group_uuid` char(20) NOT NULL COMMENT 'ç¾¤ç»„ID',
  `user_uuid` char(20) NOT NULL COMMENT 'ç”¨æˆ·ID',
  `role` tinyint DEFAULT 1 COMMENT '1æ™®é€šæˆå‘˜ 2ç®¡ç†å‘˜ 3ç¾¤ä¸»',
  PRIMARY KEY (`id`),
  INDEX `idx_group_member_deleted_at` (`deleted_at`),
  INDEX `idx_group_member_group_uuid` (`group_uuid`),
  INDEX `idx_group_member_user_uuid` (`user_uuid`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç¾¤æˆå‘˜å…³è”è¡¨';
```

**å­—æ®µè¯´æ˜**ï¼š

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|-----|------|------|
| group_uuid | char(20) | ç¾¤ç»„ UUIDï¼Œå»ºç«‹ç´¢å¼• |
| user_uuid | char(20) | ç”¨æˆ· UUIDï¼Œå»ºç«‹ç´¢å¼• |
| role | int8 | æˆå‘˜è§’è‰²ï¼š1=æ™®é€šæˆå‘˜ï¼Œ2=ç®¡ç†å‘˜ï¼Œ3=ç¾¤ä¸» |

**å¸¸è§æŸ¥è¯¢**ï¼š

```go
// æŸ¥è¯¢æŸä¸ªç¾¤çš„æ‰€æœ‰æˆå‘˜
groupMemberRepo.FindByGroupUuid(groupUuid)

// æŸ¥è¯¢ç”¨æˆ·åŠ å…¥çš„æ‰€æœ‰ç¾¤
groupMemberRepo.FindByUserUuid(userUuid)

// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨ç¾¤ä¸­
groupMemberRepo.FindByGroupAndUser(groupUuid, userUuid)
```

---

## 5. æ•°æ®åº“è‡ªåŠ¨è¿ç§»

æˆ‘ä»¬çš„ `internal/dao/mysql/gorm.go` ä¸­çš„ `Init` å‡½æ•°ä¼šè‡ªåŠ¨å¤„ç†è¿ç§»ï¼š

> **è·¯å¾„å˜æ›´**ï¼šä» `internal/dao/gorm.go` æ”¹ä¸º `internal/dao/mysql/gorm.go`

```go
package dao

import (
	"kama_chat_server/internal/dao/mysql/repository"
	"kama_chat_server/internal/model"
)

// Init åˆå§‹åŒ–æ•°æ®åº“è¿æ¥
func Init() {
	// ... è¿æ¥æ•°æ®åº“ ...

	// è‡ªåŠ¨è¿ç§»æ‰€æœ‰æ¨¡å‹
	err = GormDB.AutoMigrate(
		&model.UserInfo{},
		&model.GroupInfo{},
		&model.UserContact{},
		&model.Session{},
		&model.ContactApply{},
		&model.Message{},
		&model.GroupMember{},
	)
	if err != nil {
		zap.L().Fatal(err.Error())
	}

	// åˆå§‹åŒ–å…¨å±€ Repositories
	Repos = repository.NewRepositories(GormDB)
}
```

åªè¦åœ¨ `model` åŒ…ä¸‹å®šä¹‰å¥½ç»“æ„ä½“ï¼Œå¹¶æ·»åŠ åˆ° `AutoMigrate` åˆ—è¡¨ä¸­ï¼Œé‡å¯æœåŠ¡å³å¯è‡ªåŠ¨å»ºè¡¨ã€‚

---

## 6. è¿è¡Œè¿ç§»

```bash
cd cmd/kama_chat_server
go run main.go
```

éªŒè¯æ–°è¡¨ï¼š
```sql
SHOW TABLES;
```

è¾“å‡ºï¼š
```
+----------------------+
| Tables_in_kama_chat  |
+----------------------+
| contact_apply        |
| group_info           |
| group_member         |
| user_contact         |
| user_info            |
+----------------------+
```

---

## âœ… æœ¬èŠ‚å®Œæˆ

ä½ å·²ç»å®Œæˆäº†ï¼š
- [x] UserContact è”ç³»äººæ¨¡å‹
- [x] ContactApply å¥½å‹ç”³è¯·æ¨¡å‹ï¼ˆä½¿ç”¨ applicant_id/target_idï¼‰
- [x] GroupInfo ç¾¤ç»„æ¨¡å‹
- [x] GroupMember ç¾¤æˆå‘˜å…³è”è¡¨

---

## ğŸ“š ä¸‹ä¸€æ­¥

ç»§ç»­å­¦ä¹  [08_ä¼šè¯ä¸æ¶ˆæ¯æ¨¡å‹.md](08_ä¼šè¯ä¸æ¶ˆæ¯æ¨¡å‹.md)ï¼Œè®¾è®¡ä¼šè¯å’Œæ¶ˆæ¯æ¨¡å‹ã€‚
