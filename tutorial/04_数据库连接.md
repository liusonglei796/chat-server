# 04. æ•°æ®åº“è¿æ¥

> æœ¬æ•™ç¨‹å°†ä½¿ç”¨ GORM + MySQL å®ç°æ•°æ®åº“è¿æ¥å’ŒåŸºç¡€é…ç½®ã€‚

---

## ğŸ“Œ å­¦ä¹ ç›®æ ‡

- äº†è§£ GORM çš„æ ¸å¿ƒç‰¹æ€§
- å®ç°æ•°æ®åº“è¿æ¥æ± é…ç½®
- æŒæ¡æ•°æ®åº“åˆå§‹åŒ–æœ€ä½³å®è·µ
- ç†è§£ Repository æ¨¡å¼

---

## 1. GORM ç®€ä»‹

**GORM** æ˜¯ Go è¯­è¨€ä¸­æœ€æµè¡Œçš„ ORMï¼ˆObject-Relational Mappingï¼‰åº“ï¼š

| ç‰¹æ€§ | è¯´æ˜ |
|-----|------|
| å…¨åŠŸèƒ½ ORM | å…³è”ã€äº‹åŠ¡ã€è¿ç§»ã€é’©å­ç­‰ |
| å¼€å‘å‹å¥½ | é“¾å¼æ“ä½œã€è‡ªåŠ¨è¿ç§» |
| é«˜æ€§èƒ½ | é¢„ç¼–è¯‘ç¼“å­˜ã€è¿æ¥æ±  |
| å¤šæ•°æ®åº“æ”¯æŒ | MySQLã€PostgreSQLã€SQLiteã€SQL Server |

---

## 2. å®‰è£…ä¾èµ–

```bash
go get gorm.io/gorm
go get gorm.io/driver/mysql
```

---

## 3. åˆ›å»ºæ•°æ®åº“

é¦–å…ˆåœ¨ MySQL ä¸­åˆ›å»ºæ•°æ®åº“ï¼š

```sql
CREATE DATABASE kama_chat 
CHARACTER SET utf8mb4 
COLLATE utf8mb4_unicode_ci;
```

> **æ³¨æ„**ï¼šä½¿ç”¨ `utf8mb4` å­—ç¬¦é›†ä»¥æ”¯æŒ emoji è¡¨æƒ…ã€‚

---

## 4. å®ç°æ•°æ®åº“è¿æ¥

### 4.1 internal/dao/mysql/init_mysql.go

> **è·¯å¾„å˜æ›´**ï¼šä» `internal/dao/gorm.go` æ”¹ä¸º `internal/dao/mysql/init_mysql.go`
>
> **åŸå› **ï¼šå°† MySQL ç›¸å…³ä»£ç ç»„ç»‡åœ¨ `mysql` å­ç›®å½•ä¸‹ï¼Œä¸ Redis DAO å±‚ç»“æ„ä¿æŒä¸€è‡´ã€‚

```go
package dao

import (
	"fmt"

	"kama_chat_server/internal/config"
	"kama_chat_server/internal/dao/mysql"
	"kama_chat_server/internal/model"

	"go.uber.org/zap"
	"gorm.io/driver/mysql"
	"gorm.io/gorm"
)

// Init åˆå§‹åŒ–æ•°æ®åº“è¿æ¥å¹¶è¿”å› Repository èšåˆ
// è¯´æ˜ï¼šå½“å‰é¡¹ç›®ä¸å†é€šè¿‡å…¨å±€å˜é‡æš´éœ² db/reposï¼Œè€Œæ˜¯ç”± main è´Ÿè´£æ‹¿åˆ°è¿”å›å€¼å¹¶å‘ä¸‹æ¸¸æ³¨å…¥ã€‚
func Init() *mysql.Repositories {
	conf := config.GetConfig()

	// æ„å»º DSN è¿æ¥å­—ç¬¦ä¸²
	dsn := fmt.Sprintf("%s:%s@tcp(%s:%d)/%s?charset=utf8mb4&parseTime=True&loc=Local",
		conf.MysqlConfig.User,
		conf.MysqlConfig.Password,
		conf.MysqlConfig.Host,
		conf.MysqlConfig.Port,
		conf.MysqlConfig.DatabaseName,
	)

	// å»ºç«‹è¿æ¥
	db, err := gorm.Open(mysql.Open(dsn), &gorm.Config{})
	if err != nil {
		zap.L().Fatal(err.Error())
	}

	// è‡ªåŠ¨è¿ç§»æ•°æ®è¡¨
	// æ³¨æ„ï¼šè¡¨åç”±æ¨¡å‹çš„ TableName() å†³å®šï¼ˆå¦‚ Contact -> user_contactã€Apply -> contact_applyï¼‰ã€‚
	err = db.AutoMigrate(
		&model.UserInfo{},
		&model.GroupInfo{},
		&model.Contact{},
		&model.Session{},
		&model.Apply{},
		&model.Message{},
		&model.GroupMember{},
	)
	if err != nil {
		zap.L().Fatal(err.Error())
	}

	return repository.NewRepositories(db)
}
```

**å…³é”®æ”¹è¿›**ï¼š
1. âœ… æ”¯æŒ TCP è¿æ¥ï¼ˆé€‚ç”¨äºå¤§å¤šæ•°åœºæ™¯ï¼‰
2. âœ… ç§»é™¤äº† Unix Socket ç¤ºä¾‹ï¼ˆç®€åŒ–ä»£ç ï¼‰
3. âœ… æ·»åŠ äº† `GroupMember` æ¨¡å‹çš„è‡ªåŠ¨è¿ç§»
4. âœ… ç§»é™¤äº†æˆåŠŸæ—¥å¿—ï¼ˆä¿æŒç®€æ´ï¼Œç”± main.go è¾“å‡ºï¼‰

---

## 5. æ ¸å¿ƒæ¦‚å¿µè¯¦è§£

### 5.1 DSN æ ¼å¼

```
user:password@tcp(host:port)/database?param1=value1&param2=value2
```

| å‚æ•° | è¯´æ˜ |
|-----|------|
| `charset=utf8mb4` | å­—ç¬¦é›†ï¼Œæ”¯æŒ emoji |
| `parseTime=True` | è‡ªåŠ¨è§£æ MySQL æ—¶é—´ç±»å‹ |
| `loc=Local` | ä½¿ç”¨æœ¬åœ°æ—¶åŒº |

### 5.2 è‡ªåŠ¨è¿ç§» (AutoMigrate)

GORM çš„ `AutoMigrate` åŠŸèƒ½ä¼šè‡ªåŠ¨ï¼š
- åˆ›å»ºç¼ºå¤±çš„è¡¨
- æ·»åŠ ç¼ºå¤±çš„åˆ—
- ä¿®æ”¹åˆ—ç±»å‹ï¼ˆå¦‚æœ‰å¯èƒ½ï¼‰
- **ä¸ä¼š** åˆ é™¤åˆ—ï¼ˆä¸ºäº†å®‰å…¨ï¼‰

### 5.3 Repository æ¨¡å¼

æˆ‘ä»¬åœ¨ `internal/dao/mysql` ä¸­å°è£…äº†æ‰€æœ‰çš„æ•°æ®åº“æ“ä½œï¼ŒMySQL åˆå§‹åŒ–å®Œæˆåä¼šè¿”å› `*mysql.Repositories`ï¼Œç”± `main.go` è´Ÿè´£å‘ä¸‹æ¸¸ï¼ˆService/ChatServer/Handlerï¼‰æ³¨å…¥ã€‚

**Repository æ¥å£ä¸€è§ˆ**ï¼š
- `UserRepository` - ç”¨æˆ·æ•°æ®è®¿é—®
- `GroupRepository` - ç¾¤ç»„æ•°æ®è®¿é—®
- `ContactRepository` - è”ç³»äººæ•°æ®è®¿é—®
- `SessionRepository` - ä¼šè¯æ•°æ®è®¿é—®
- `MessageRepository` - æ¶ˆæ¯æ•°æ®è®¿é—®
- `ApplyRepository` - è”ç³»äºº/å…¥ç¾¤ç”³è¯·æ•°æ®è®¿é—®
- `GroupMemberRepository` - ç¾¤æˆå‘˜æ•°æ®è®¿é—®

**è®¾è®¡ä¼˜åŠ¿**ï¼š
1. **è§£è€¦**ï¼šService å±‚ä¸ç›´æ¥ä¾èµ– GORMï¼Œæ–¹ä¾¿å•å…ƒæµ‹è¯•ï¼ˆå¯ Mock Repositoryï¼‰
2. **å¤ç”¨**ï¼šå¸¸ç”¨çš„æŸ¥è¯¢é€»è¾‘å°è£…åœ¨ Repository ä¸­ï¼Œé¿å…ä»£ç é‡å¤
3. **ç»´æŠ¤æ€§**ï¼šæ•°æ®è®¿é—®é€»è¾‘é›†ä¸­ç®¡ç†ï¼Œæ˜“äºä¿®æ”¹å’Œä¼˜åŒ–
4. **ç±»å‹å®‰å…¨**ï¼šé€šè¿‡æ¥å£å®šä¹‰æ˜ç¡®è¿”å›ç±»å‹ï¼Œå‡å°‘è¿è¡Œæ—¶é”™è¯¯

---

## 6. æ›´æ–° main.go

æ›´æ–° `cmd/kama_chat_server/main.go`ï¼š

```go
package main

import (
	"fmt"
	"log"

	"go.uber.org/zap"
	"kama_chat_server/internal/config"
	dao "kama_chat_server/internal/dao/mysql"
	myredis "kama_chat_server/internal/dao/redis"
	"kama_chat_server/internal/infrastructure/logger"
	"kama_chat_server/internal/service"
)

func main() {
	fmt.Println("KamaChat Server Starting...")

	// 1. åŠ è½½é…ç½®
	cfg := config.GetConfig()

	// 2. åˆå§‹åŒ–æ—¥å¿—
	if err := logger.Init(&cfg.LogConfig, "dev"); err != nil {
		log.Fatalf("init logger failed: %v", err)
	}
	defer logger.Sync()

	// 3. åˆå§‹åŒ–æ•°æ®åº“ï¼ˆæ‹¿åˆ° reposï¼Œç”¨äºä¾èµ–æ³¨å…¥ï¼‰
	repos := dao.Init()
	zap.L().Info("æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ")

	// 4. åˆå§‹åŒ– Redisï¼ˆè¿”å› AsyncCacheServiceï¼Œç”¨äºä¾èµ–æ³¨å…¥ï¼‰
	cacheService := myredis.Init()
	zap.L().Info("Redis åˆå§‹åŒ–æˆåŠŸ")

	// 5. åˆå§‹åŒ– Service å±‚ï¼ˆæ„é€ å‡½æ•°æ³¨å…¥ repos + cacheï¼‰
	_ = service.NewServices(repos, cacheService)

	zap.L().Info("æ‰€æœ‰æœåŠ¡åˆå§‹åŒ–å®Œæˆ")
}
```

**æ³¨æ„å¯¼å…¥è·¯å¾„**ï¼š
- ä½¿ç”¨åˆ«å `dao "kama_chat_server/internal/dao/mysql"` é¿å…åŒ…åå†²çª
- æ—¥å¿—è·¯å¾„å·²æ›´æ–°ä¸º `internal/infrastructure/logger`

---

## 7. è¿è¡Œæµ‹è¯•

```bash
cd cmd/kama_chat_server
go run main.go
```

é¢„æœŸè¾“å‡ºï¼š
```
KamaChat Server Starting...
2024-01-01T10:30:00.123+0800	INFO	logger/logger.go:114	æ—¥å¿—åˆå§‹åŒ–æˆåŠŸ
2024-01-01T10:30:00.124+0800	INFO	main.go:199	æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ
2024-01-01T10:30:00.124+0800	INFO	main.go:205	æ‰€æœ‰æœåŠ¡åˆå§‹åŒ–å®Œæˆ
```

**æ£€æŸ¥æ•°æ®åº“**ï¼š
```sql
USE kama_chat;
SHOW TABLES;
```

åº”è¯¥èƒ½çœ‹åˆ°ä»¥ä¸‹è¡¨ï¼š
- `user_info` - ç”¨æˆ·ä¿¡æ¯è¡¨
- `group_info` - ç¾¤ç»„ä¿¡æ¯è¡¨
- `user_contact` - è”ç³»äºº/ç¾¤å…³ç³»è¡¨ï¼ˆæ¨¡å‹ï¼šContactï¼‰
- `session` - ä¼šè¯è¡¨
- `message` - æ¶ˆæ¯è¡¨
- `contact_apply` - ç”³è¯·è¡¨ï¼ˆæ¨¡å‹ï¼šApplyï¼‰
- `group_member` - ç¾¤æˆå‘˜è¡¨

---

## âœ… æœ¬èŠ‚å®Œæˆ

ä½ å·²ç»å®Œæˆäº†ï¼š
- [x] GORM + MySQL è¿æ¥
- [x] è‡ªåŠ¨è¿ç§»é…ç½®
- [x] Repository æ¨¡å¼åˆå§‹åŒ–

---

## ğŸ“š ä¸‹ä¸€æ­¥

ç»§ç»­å­¦ä¹  [04_2_DAOå±‚ä¸Repositoryæ¨¡å¼.md](04_2_DAOå±‚ä¸Repositoryæ¨¡å¼.md)ï¼Œæ·±å…¥äº†è§£ Repository æ¨¡å¼çš„å®ç°ç»†èŠ‚ã€‚
