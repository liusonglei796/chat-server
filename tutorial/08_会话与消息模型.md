# 08. ä¼šè¯ä¸æ¶ˆæ¯æ¨¡å‹

> æœ¬æ•™ç¨‹å°†è®¾è®¡ä¼šè¯å’Œæ¶ˆæ¯æ¨¡å‹ï¼Œè¿™æ˜¯å³æ—¶é€šè®¯ç³»ç»Ÿçš„æ ¸å¿ƒæ•°æ®ç»“æ„ã€‚

---

## ğŸ“Œ å­¦ä¹ ç›®æ ‡

- ç†è§£ä¼šè¯å’Œæ¶ˆæ¯çš„å…³ç³»
- è®¾è®¡æ”¯æŒå¤šç§æ¶ˆæ¯ç±»å‹çš„æ¨¡å‹
- æŒæ¡æ¶ˆæ¯å­˜å‚¨æœ€ä½³å®è·µ

---

## 1. ä¼šè¯ä¸æ¶ˆæ¯çš„å…³ç³»

```mermaid
erDiagram
    UserInfo ||--o{ Session : creates
    Session ||--o{ Message : contains
    
    Session {
        uint id PK
        string uuid
        string send_id
        string receive_id
        string receive_name
        string avatar
        string last_message
        datetime last_message_at
    }
    
    Message {
        uint id PK
        bigint uuid
        string session_id FK
        string send_id
        string receive_id
        int8 type
        string content
        string url
    }
```

**æ¦‚å¿µè¯´æ˜**ï¼š
- **ä¼šè¯ï¼ˆSessionï¼‰**ï¼šç”¨æˆ·ä¸æŸä¸ªè”ç³»äºº/ç¾¤ç»„çš„èŠå¤©çª—å£
- **æ¶ˆæ¯ï¼ˆMessageï¼‰**ï¼šä¼šè¯ä¸­çš„å…·ä½“æ¶ˆæ¯å†…å®¹

---

## 2. ä¼šè¯æ¨¡å‹

### 2.1 internal/model/session.go

```go
package model

import (
	"database/sql"

	"gorm.io/gorm"
)

type Session struct {
	gorm.Model
	Uuid          string       `gorm:"column:uuid;uniqueIndex;type:char(20);comment:ä¼šè¯uuid"`
	SendId        string       `gorm:"column:send_id;index;type:char(20);not null;comment:åˆ›å»ºä¼šè¯äººid"`
	ReceiveId     string       `gorm:"column:receive_id;index;type:char(20);not null;comment:æ¥å—ä¼šè¯äººid"`
	ReceiveName   string       `gorm:"column:receive_name;type:varchar(20);not null;comment:åç§°"`
	Avatar        string       `gorm:"column:avatar;type:char(255);default:default_avatar.png;not null;comment:å¤´åƒ"`
	LastMessage   string       `gorm:"column:last_message;type:TEXT;comment:æœ€æ–°çš„æ¶ˆæ¯"`
	LastMessageAt sql.NullTime `gorm:"column:last_message_at;type:datetime;comment:æœ€è¿‘æ¥æ”¶æ—¶é—´"`
}

func (Session) TableName() string {
	return "session"
}
```

```sql
CREATE TABLE `session` (
  `id` bigint unsigned AUTO_INCREMENT,
  `created_at` datetime(3) NULL,
  `updated_at` datetime(3) NULL,
  `deleted_at` datetime(3) NULL,
  `uuid` char(20) DEFAULT NULL COMMENT 'ä¼šè¯uuid',
  `send_id` char(20) NOT NULL COMMENT 'åˆ›å»ºä¼šè¯äººid',
  `receive_id` char(20) NOT NULL COMMENT 'æ¥å—ä¼šè¯äººid',
  `receive_name` varchar(20) NOT NULL COMMENT 'åç§°',
  `avatar` char(255) NOT NULL DEFAULT 'default_avatar.png' COMMENT 'å¤´åƒ',
  `last_message` TEXT DEFAULT NULL COMMENT 'æœ€æ–°çš„æ¶ˆæ¯',
  `last_message_at` datetime DEFAULT NULL COMMENT 'æœ€è¿‘æ¥æ”¶æ—¶é—´',
  PRIMARY KEY (`id`),
  INDEX `idx_session_deleted_at` (`deleted_at`),
  UNIQUE INDEX `idx_session_uuid` (`uuid`),
  INDEX `idx_session_send_id` (`send_id`),
  INDEX `idx_session_receive_id` (`receive_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ä¼šè¯è¡¨';
```

### 2.2 ä¼šè¯è®¾è®¡è¯´æ˜

| å­—æ®µ | è¯´æ˜ | ç¤ºä¾‹ |
|-----|------|------|
| send_id | ä¼šè¯åˆ›å»ºè€…ï¼ˆå½“å‰ç”¨æˆ·ï¼‰ | U123... |
| receive_id | èŠå¤©å¯¹è±¡ï¼ˆç”¨æˆ·æˆ–ç¾¤ç»„ï¼‰ | U456...ï¼ˆç”¨æˆ·ï¼‰æˆ– G789...ï¼ˆç¾¤ç»„ï¼‰ |
| receive_name | å¯¹æ–¹æ˜µç§°/ç¾¤åï¼ˆå†—ä½™å­˜å‚¨ï¼‰ | "å¼ ä¸‰" æˆ– "å·¥ä½œç¾¤" |
| avatar | å¯¹æ–¹å¤´åƒï¼ˆå†—ä½™å­˜å‚¨ï¼‰ | avatar.png |
| last_message | æœ€æ–°æ¶ˆæ¯å†…å®¹é¢„è§ˆ | "ä½ å¥½" |
| last_message_at | æœ€åæ¶ˆæ¯æ—¶é—´ï¼ˆç”¨äºæ’åºï¼‰ | 2024-01-01 10:00:00 |

**å†—ä½™å­—æ®µçš„ä½œç”¨**ï¼š
- `receive_name` å’Œ `avatar`ï¼šæ˜¾ç¤ºä¼šè¯åˆ—è¡¨æ—¶æ— éœ€ JOIN ç”¨æˆ·/ç¾¤ç»„è¡¨
- `last_message` å’Œ `last_message_at`ï¼šä¼šè¯åˆ—è¡¨æ’åºå’Œé¢„è§ˆ

**æ³¨æ„**ï¼šæ¯ä¸ªç”¨æˆ·å¯¹åŒä¸€ä¸ªèŠå¤©å¯¹è±¡åªæœ‰ä¸€ä¸ªä¼šè¯è®°å½•ã€‚

---

## 3. æ¶ˆæ¯æ¨¡å‹

### 3.1 internal/model/message.go

> **å½“å‰ä»“åº“çš„çœŸå®å½¢æ€**ï¼š`Uuid` ä½¿ç”¨é›ªèŠ±ç®—æ³•ç”Ÿæˆçš„ `int64`ï¼ˆæ•°æ®åº“ `bigint`ï¼‰ï¼ŒåŒæ—¶ `pkg/util/snowflake` ä¹Ÿæä¾› `GenerateIDString()` ä»¥é¿å…å‰ç«¯ JavaScript ç²¾åº¦ä¸¢å¤±ã€‚

```go
package model

import (
	"database/sql"

	"gorm.io/gorm"
)

type Message struct {
	gorm.Model
	Uuid       int64        `gorm:"column:uuid;uniqueIndex;type:bigint;not null;comment:æ¶ˆæ¯é›ªèŠ±ID"`
	SessionId  string       `gorm:"column:session_id;index;type:char(20);not null;comment:ä¼šè¯uuid"`
	Type       int8         `gorm:"column:type;not null;comment:æ¶ˆæ¯ç±»å‹ï¼Œ0.æ–‡æœ¬ï¼Œ1.è¯­éŸ³ï¼Œ2.æ–‡ä»¶ï¼Œ3.é€šè¯"`
	Content    string       `gorm:"column:content;type:TEXT;comment:æ¶ˆæ¯å†…å®¹"`
	Url        string       `gorm:"column:url;type:char(255);comment:æ¶ˆæ¯url"`
	SendId     string       `gorm:"column:send_id;index;type:char(20);not null;comment:å‘é€è€…uuid"`
	SendName   string       `gorm:"column:send_name;type:varchar(20);not null;comment:å‘é€è€…æ˜µç§°"`
	SendAvatar string       `gorm:"column:send_avatar;type:varchar(255);not null;comment:å‘é€è€…å¤´åƒ"`
    ReceiveId  string       `gorm:"column:receive_id;index;type:char(20);not null;comment:æ¥å—è€…uuid"`
    FileType   string       `gorm:"column:file_type;type:char(50);comment:æ–‡ä»¶ç±»å‹"`
	FileName   string       `gorm:"column:file_name;type:varchar(50);comment:æ–‡ä»¶å"`
	FileSize   string       `gorm:"column:file_size;type:char(20);comment:æ–‡ä»¶å¤§å°"`
	Status     int8         `gorm:"column:status;not null;comment:çŠ¶æ€ï¼Œ0.æœªå‘é€ï¼Œ1.å·²å‘é€"`
	SendAt     sql.NullTime `gorm:"column:send_at;comment:å‘é€æ—¶é—´"`
	AVdata     string       `gorm:"column:av_data;comment:é€šè¯ä¼ é€’æ•°æ®"`
}

func (Message) TableName() string {
	return "message"
}
```

```sql
CREATE TABLE `message` (
  `id` bigint unsigned AUTO_INCREMENT,
  `created_at` datetime(3) NULL,
  `updated_at` datetime(3) NULL,
  `deleted_at` datetime(3) NULL,
  `uuid` bigint NOT NULL COMMENT 'æ¶ˆæ¯é›ªèŠ±ID',
  `session_id` char(20) NOT NULL COMMENT 'ä¼šè¯uuid',
  `type` tinyint NOT NULL COMMENT 'æ¶ˆæ¯ç±»å‹ï¼Œ0.æ–‡æœ¬ï¼Œ1.è¯­éŸ³ï¼Œ2.æ–‡ä»¶ï¼Œ3.é€šè¯',
  `content` TEXT DEFAULT NULL COMMENT 'æ¶ˆæ¯å†…å®¹',
  `url` char(255) DEFAULT NULL COMMENT 'æ¶ˆæ¯url',
  `send_id` char(20) NOT NULL COMMENT 'å‘é€è€…uuid',
  `send_name` varchar(20) NOT NULL COMMENT 'å‘é€è€…æ˜µç§°',
  `send_avatar` varchar(255) NOT NULL COMMENT 'å‘é€è€…å¤´åƒ',
  `receive_id` char(20) NOT NULL COMMENT 'æ¥å—è€…uuid',
    `file_type` char(50) DEFAULT NULL COMMENT 'æ–‡ä»¶ç±»å‹',
  `file_name` varchar(50) DEFAULT NULL COMMENT 'æ–‡ä»¶å',
  `file_size` char(20) DEFAULT NULL COMMENT 'æ–‡ä»¶å¤§å°',
  `status` tinyint NOT NULL COMMENT 'çŠ¶æ€ï¼Œ0.æœªå‘é€ï¼Œ1.å·²å‘é€',
  `send_at` datetime DEFAULT NULL COMMENT 'å‘é€æ—¶é—´',
    `av_data` varchar(255) DEFAULT NULL COMMENT 'é€šè¯ä¼ é€’æ•°æ®',
  PRIMARY KEY (`id`),
  UNIQUE INDEX `idx_message_uuid` (`uuid`),
  INDEX `idx_message_session_id` (`session_id`),
  INDEX `idx_message_send_id` (`send_id`),
  INDEX `idx_message_receive_id` (`receive_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æ¶ˆæ¯è¡¨';
```

### 3.2 æ¶ˆæ¯ç±»å‹æšä¸¾

`pkg/enum/message/message_type_enum/message_type_enum.go`ï¼š

```go
package message_type_enum

const (
    Text = iota
    // è¯­éŸ³
    Voice
    // æ–‡ä»¶
    File
    // é€šè¯
    AudioOrVideo
)
```

### 3.3 æ¶ˆæ¯çŠ¶æ€æšä¸¾

`pkg/enum/message/message_status_enum/message_status_enum.go`ï¼š

```go
package message_status_enum

const (
    // æœªå‘é€
    Unsent = iota
    // å·²å‘é€
    Sent
)
```

---

## 4. æ¶ˆæ¯æ¨¡å‹è®¾è®¡è¯¦è§£

### 4.1 é›ªèŠ±ç®—æ³• ID

æ¶ˆæ¯ä½¿ç”¨é›ªèŠ±ç®—æ³•ç”Ÿæˆå”¯ä¸€ IDï¼Œä¼˜åŠ¿ï¼š
- **æœ‰åºæ€§**ï¼šID æŒ‰æ—¶é—´é€’å¢ï¼Œä¾¿äºæ’åº
- **é«˜æ€§èƒ½**ï¼šæœ¬åœ°ç”Ÿæˆï¼Œæ— éœ€æ•°æ®åº“æŸ¥è¯¢
- **åˆ†å¸ƒå¼**ï¼šæ”¯æŒå¤šèŠ‚ç‚¹åŒæ—¶ç”Ÿæˆ

é…ç½®ä½ç½®ï¼š`configs/config.toml`
```toml
[snowflakeConfig]
machineId = 1  # é›ªèŠ±ç®—æ³•èŠ‚ç‚¹ ID (0-1023)
```

ä½¿ç”¨æ–¹å¼ï¼ˆå½“å‰å®ç°ï¼‰ï¼š

```go
import "kama_chat_server/pkg/util/snowflake"

// å»ºè®®åœ¨ main å¯åŠ¨æ—¶åˆå§‹åŒ–ä¸€æ¬¡
snowflake.Init()

// ç”Ÿæˆ int64 IDï¼ˆè½åº“ bigintï¼‰
messageId := snowflake.GenerateID()

// å¦‚æœè¦è¿”å›ç»™å‰ç«¯ï¼ˆJS å¯èƒ½ä¸¢ç²¾åº¦ï¼‰ï¼Œå»ºè®®è¿”å› string
messageIdStr := snowflake.GenerateIDString()
```

### 4.2 å¤šç§æ¶ˆæ¯ç±»å‹æ”¯æŒ

| ç±»å‹ | Type | ä½¿ç”¨å­—æ®µ |
|-----|------|---------| 
| æ–‡æœ¬ | 0 | content |
| è¯­éŸ³ | 1 | url, file_size |
| æ–‡ä»¶ | 2 | url, file_size, file_type, file_name |
| é€šè¯ | 3 | av_dataï¼ˆJSON æ ¼å¼ï¼‰ |

### 4.3 ä¸ºä»€ä¹ˆå†—ä½™å­˜å‚¨ SendName å’Œ SendAvatar

```go
SendName   string `gorm:"column:send_name"`
SendAvatar string `gorm:"column:send_avatar"`
```

**åŸå› **ï¼š
1. **å‡å°‘å…³è”æŸ¥è¯¢**ï¼šæ˜¾ç¤ºæ¶ˆæ¯æ—¶æ— éœ€ JOIN ç”¨æˆ·è¡¨
2. **å†å²å¿«ç…§**ï¼šä¿ç•™å‘é€æ—¶çš„æ˜µç§°/å¤´åƒï¼Œå³ä½¿åæ¥ç”¨æˆ·ä¿®æ”¹äº†ä¹Ÿä¸å½±å“å†å²æ¶ˆæ¯
3. **æ€§èƒ½ä¼˜åŒ–**ï¼šæ¶ˆæ¯é‡å¤§æ—¶ï¼Œé¿å…é¢‘ç¹æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯

### 4.4 SessionId çš„ä½œç”¨

- å…³è”æ¶ˆæ¯ä¸ä¼šè¯
- æ–¹ä¾¿æŒ‰ä¼šè¯æŸ¥è¯¢æ¶ˆæ¯å†å²
- æ”¯æŒæ¶ˆæ¯åˆ†é¡µåŠ è½½

---

## 5. éŸ³è§†é¢‘æ•°æ®ç»“æ„

### 5.1 AVData JSON ç»“æ„

```go
// internal/dto/request/av_data_request.go
type AVData struct {
    MessageId string `json:"messageId"`
    Type      string `json:"type"`
}
```

---

## 6. æ›´æ–°è¿ç§»å‡½æ•°

æˆ‘ä»¬å·²ç»åœ¨ `internal/dao/mysql/init_mysql.go` ä¸­é…ç½®äº†æ‰€æœ‰æ¨¡å‹çš„è‡ªåŠ¨è¿ç§»ï¼ˆå¹¶ä¸”ä¸å†ä½¿ç”¨å…¨å±€ `GormDB/Repos`ï¼‰ï¼š

```go
package mysql

import (
    "kama_chat_server/internal/dao/mysql/repository"
    "kama_chat_server/internal/model"
)

// Init åˆå§‹åŒ–æ•°æ®åº“è¿æ¥ï¼Œè‡ªåŠ¨è¿ç§»ï¼Œå¹¶è¿”å› Repositories
func Init() *repository.Repositories {
    // ... è¿æ¥æ•°æ®åº“ ...

    err := db.AutoMigrate(
        &model.UserInfo{},
        &model.GroupInfo{},
        &model.Contact{},
        &model.Session{},
        &model.Apply{},
        &model.Message{},
        &model.GroupMember{},
    )
    if err != nil {
        // ... fatal log ...
    }

    return repository.NewRepositories(db)
}
```

åªéœ€è¿è¡Œ `main.go` å³å¯åº”ç”¨æ›´æ”¹ã€‚

---

## 7. å®Œæ•´æšä¸¾ç›®å½•ç»“æ„

```
pkg/enum/
â”œâ”€â”€ contact/
â”‚   â”œâ”€â”€ contact_status_enum/
â”‚   â”‚   â””â”€â”€ contact_status_enum.go    # è”ç³»äººçŠ¶æ€
â”‚   â””â”€â”€ contact_type_enum/
â”‚       â””â”€â”€ contact_type_enum.go      # è”ç³»äººç±»å‹
â”œâ”€â”€ contact_apply/
â”‚   â””â”€â”€ contact_apply_status_enum/
â”‚       â””â”€â”€ contact_apply_status_enum.go  # ç”³è¯·çŠ¶æ€
â”œâ”€â”€ group_info/
â”‚   â”œâ”€â”€ add_mode_enum/
â”‚   â”‚   â””â”€â”€ add_mode_enum.go          # åŠ ç¾¤æ–¹å¼
â”‚   â””â”€â”€ group_status_enum/
â”‚       â””â”€â”€ group_status_enum.go      # ç¾¤ç»„çŠ¶æ€
â”œâ”€â”€ message/
â”‚   â”œâ”€â”€ message_status_enum/
â”‚   â”‚   â””â”€â”€ message_status_enum.go    # æ¶ˆæ¯çŠ¶æ€
â”‚   â””â”€â”€ message_type_enum/
â”‚       â””â”€â”€ message_type_enum.go      # æ¶ˆæ¯ç±»å‹
â””â”€â”€ user_info/
    â””â”€â”€ user_status_enum/
        â””â”€â”€ user_status_enum.go        # ç”¨æˆ·çŠ¶æ€
```

**æšä¸¾å‘½åè§„èŒƒ**ï¼š
- ç›®å½•åä½¿ç”¨ä¸‹åˆ’çº¿åˆ†éš”ï¼š`contact_apply_status_enum`
- æ–‡ä»¶åä¸ç›®å½•åä¸€è‡´
- åŒ…åä¸ç›®å½•åä¸€è‡´
- å¸¸é‡ä½¿ç”¨å¤§é©¼å³°å‘½å

---

## 8. è¿è¡Œè¿ç§»

```bash
cd cmd/kama_chat_server
go run main.go
```

éªŒè¯æ‰€æœ‰è¡¨ï¼š
```sql
USE kama_chat;
SHOW TABLES;
```

é¢„æœŸè¾“å‡ºï¼š
```
+----------------------+
| Tables_in_kama_chat  |
+----------------------+
| contact_apply        |
| group_info           |
| group_member         |
| message              |
| session              |
| user_contact         |
| user_info            |
+----------------------+
```

æŸ¥çœ‹æ¶ˆæ¯è¡¨ç»“æ„ï¼š
```sql
DESCRIBE message;
```

---

## âœ… æœ¬èŠ‚å®Œæˆ

ä½ å·²ç»å®Œæˆäº†ï¼š
- [x] Session ä¼šè¯æ¨¡å‹ï¼ˆå«å†—ä½™å­—æ®µï¼‰
- [x] Message æ¶ˆæ¯æ¨¡å‹ï¼ˆé›ªèŠ± IDï¼‰
- [x] æ¶ˆæ¯ç±»å‹/çŠ¶æ€æšä¸¾
- [x] éŸ³è§†é¢‘æ¶ˆæ¯ç»“æ„

---

## ğŸ“š é˜¶æ®µäºŒå®Œæˆï¼

æ­å–œï¼ä½ å·²ç»å®Œæˆäº† **é˜¶æ®µäºŒï¼šæ•°æ®æ¨¡å‹å±‚**ã€‚

ç»§ç»­å­¦ä¹  [09_Ginæ¡†æ¶æ­å»ºä¸è·¯ç”±.md](09_Ginæ¡†æ¶æ­å»ºä¸è·¯ç”±.md)ï¼Œå¼€å§‹ **é˜¶æ®µä¸‰ï¼šHTTP API æœåŠ¡**ã€‚
