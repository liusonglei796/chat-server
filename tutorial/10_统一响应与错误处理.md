# 10. ç»Ÿä¸€å“åº”ä¸é”™è¯¯å¤„ç†

> æœ¬æ•™ç¨‹å°†å®ç°ç»Ÿä¸€çš„ API å“åº”æ ¼å¼å’Œé”™è¯¯å¤„ç†æœºåˆ¶ã€‚

---

## ğŸ“Œ å­¦ä¹ ç›®æ ‡

- è®¾è®¡ç»Ÿä¸€çš„å“åº”ç»“æ„
- å®ç°ä¸šåŠ¡é”™è¯¯ç 
- æŒæ¡å‚æ•°éªŒè¯å’Œå›½é™…åŒ–é”™è¯¯æç¤º

---

## 1. ä¸ºä»€ä¹ˆéœ€è¦ç»Ÿä¸€å“åº”

**ä¸ç»Ÿä¸€çš„é—®é¢˜**ï¼š
```json
// æ¥å£ A è¿”å›
{"success": true, "data": {...}}

// æ¥å£ B è¿”å›
{"code": 0, "result": {...}}

// æ¥å£ C è¿”å›
{"status": "ok", "payload": {...}}
```

**ç»Ÿä¸€å**ï¼š
```json
{
    "code": 1000,
    "msg": "success",
    "data": {...}
}
```

---

## 2. ä¸šåŠ¡é”™è¯¯ç è®¾è®¡

### 2.1 é”™è¯¯ç è§„èŒƒ

| ç  | è¯´æ˜ |
|---|------|
| 1000 | æˆåŠŸ |
| 1001 | è¯·æ±‚å‚æ•°é”™è¯¯ |
| 1002 | ç”¨æˆ·å·²å­˜åœ¨ |
| 1003 | ç”¨æˆ·ä¸å­˜åœ¨ |
| 1004 | å¯†ç é”™è¯¯ |
| 1005 | æœåŠ¡ç¹å¿™ |
| 1006 | æœªæˆæƒ/è®¤è¯å¤±è´¥ |
| 1008 | èµ„æºä¸å­˜åœ¨ |
| 1010 | æ•°æ®åº“é”™è¯¯ |
| 1011 | ç¼“å­˜é”™è¯¯ |

### 2.2 pkg/errorx/errorx.go

```go
package errorx

import (
	"errors"
	"fmt"
)

// CodeError å¸¦ä¸šåŠ¡é”™è¯¯ç çš„è‡ªå®šä¹‰é”™è¯¯
// å®ç°äº† error æ¥å£ï¼Œæ”¯æŒ %w åŒ…è£…åº•å±‚é”™è¯¯ï¼Œä¸”èƒ½è¢« errors.Is/errors.As è¯†åˆ«
type CodeError struct {
	Code  int    // ä¸šåŠ¡é”™è¯¯ç 
	Msg   string // é”™è¯¯æ¶ˆæ¯
	cause error  // è¢«åŒ…è£…çš„åº•å±‚é”™è¯¯
}

// Error å®ç° error æ¥å£
func (e *CodeError) Error() string {
	if e.cause != nil {
		return fmt.Sprintf("%s: %v", e.Msg, e.cause)
	}
	return e.Msg
}

// Unwrap å®ç° errors.Unwrap æ¥å£ï¼Œæ”¯æŒ errors.Is/errors.As å‘ä¸‹è¿½æº¯
func (e *CodeError) Unwrap() error {
	return e.cause
}

// Is å®ç° errors.Is æ¥å£ï¼Œæ”¯æŒæŒ‰é”™è¯¯ç æ¯”è¾ƒ
func (e *CodeError) Is(target error) bool {
	if t, ok := target.(*CodeError); ok {
		return e.Code == t.Code
	}
	return false
}

// New åˆ›å»ºä¸€ä¸ªæ–°çš„ CodeError
func New(code int, msg string) *CodeError {
	return &CodeError{Code: code, Msg: msg}
}

// Newf åˆ›å»ºä¸€ä¸ªå¸¦æ ¼å¼åŒ–æ¶ˆæ¯çš„ CodeError
func Newf(code int, format string, args ...any) *CodeError {
	return &CodeError{Code: code, Msg: fmt.Sprintf(format, args...)}
}

// Wrap åŒ…è£…åº•å±‚é”™è¯¯ï¼Œæ·»åŠ ä¸šåŠ¡é”™è¯¯ç å’Œæ¶ˆæ¯
// ç”¨æ³•: errorx.Wrap(err, CodeNotFound, "ç”¨æˆ·ä¸å­˜åœ¨")
func Wrap(err error, code int, msg string) *CodeError {
	return &CodeError{Code: code, Msg: msg, cause: err}
}

// Wrapf åŒ…è£…åº•å±‚é”™è¯¯ï¼Œæ”¯æŒæ ¼å¼åŒ–æ¶ˆæ¯
// ç”¨æ³•: errorx.Wrapf(err, CodeNotFound, "ç”¨æˆ· %s ä¸å­˜åœ¨", userId)
func Wrapf(err error, code int, format string, args ...any) *CodeError {
	return &CodeError{Code: code, Msg: fmt.Sprintf(format, args...), cause: err}
}

// WrapWithCode ä»…åŒ…è£…é”™è¯¯å¹¶é™„åŠ é”™è¯¯ç ï¼Œæ¶ˆæ¯æ¥è‡ªåº•å±‚é”™è¯¯
// ç”¨æ³•: errorx.WrapWithCode(err, CodeServerBusy)
func WrapWithCode(err error, code int) *CodeError {
	return &CodeError{Code: code, Msg: err.Error(), cause: err}
}

// GetCode ä»é”™è¯¯ä¸­æå–ä¸šåŠ¡é”™è¯¯ç 
func GetCode(err error) int {
	var codeErr *CodeError
	if errors.As(err, &codeErr) {
		return codeErr.Code
	}
	return CodeServerBusy
}

// GetMsg ä»é”™è¯¯ä¸­æå–æ¶ˆæ¯
func GetMsg(err error) string {
	var codeErr *CodeError
	if errors.As(err, &codeErr) {
		return codeErr.Msg
	}
	return err.Error()
}

// Cause è·å–æœ€åº•å±‚çš„åŸå§‹é”™è¯¯
func Cause(err error) error {
	for err != nil {
		unwrapped := errors.Unwrap(err)
		if unwrapped == nil {
			return err
		}
		err = unwrapped
	}
	return nil
}

// IsNotFound æ£€æŸ¥é”™è¯¯æ˜¯å¦ä¸º"æœªæ‰¾åˆ°"ç±»å‹ï¼ˆåŒ…æ‹¬ gorm.ErrRecordNotFoundï¼‰
func IsNotFound(err error) bool {
	var codeErr *CodeError
	if errors.As(err, &codeErr) && codeErr.Code == CodeNotFound {
		return true
	}
	return err != nil && err.Error() == "record not found"
}

// ä¸šåŠ¡çŠ¶æ€ç å¸¸é‡å®šä¹‰
const (
	CodeSuccess         = 1000 // æˆåŠŸ
	CodeInvalidParam    = 1001 // è¯·æ±‚å‚æ•°é”™è¯¯
	CodeUserExist       = 1002 // ç”¨æˆ·å·²å­˜åœ¨
	CodeUserNotExist    = 1003 // ç”¨æˆ·ä¸å­˜åœ¨
	CodeInvalidPassword = 1004 // å¯†ç é”™è¯¯
	CodeServerBusy      = 1005 // æœåŠ¡ç¹å¿™
	CodeUnauthorized    = 1006 // æœªæˆæƒ/è®¤è¯å¤±è´¥
	CodeNotFound        = 1008 // èµ„æºä¸å­˜åœ¨
	CodeDBError         = 1010 // æ•°æ®åº“é”™è¯¯
	CodeCacheError      = 1011 // ç¼“å­˜é”™è¯¯
)

// é¢„å®šä¹‰å¸¸ç”¨é”™è¯¯å®ä¾‹
var (
	ErrInvalidParam = New(CodeInvalidParam, "è¯·æ±‚å‚æ•°é”™è¯¯")
	ErrServerBusy   = New(CodeServerBusy, "æœåŠ¡ç¹å¿™")
	ErrUnauthorized = New(CodeUnauthorized, "è¯·å…ˆç™»å½•")
	ErrNotFound     = New(CodeNotFound, "èµ„æºä¸å­˜åœ¨")
	ErrDBError      = New(CodeDBError, "æ•°æ®åº“é”™è¯¯")
	ErrCacheError   = New(CodeCacheError, "ç¼“å­˜é”™è¯¯")
)
```

**æ ¸å¿ƒè®¾è®¡**ï¼š
- `Wrap/Wrapf` - åƒ `fmt.Errorf` ä¸€æ ·åŒ…è£…åº•å±‚é”™è¯¯
- `WrapWithCode` - ä»…æ·»åŠ é”™è¯¯ç ï¼Œæ¶ˆæ¯æ¥è‡ªåº•å±‚é”™è¯¯
- `Unwrap()` - æ”¯æŒ `errors.Is/As` å‘ä¸‹è¿½æº¯åŸå§‹é”™è¯¯
- `Is()` - æ”¯æŒæŒ‰é”™è¯¯ç æ¯”è¾ƒï¼Œä¸éœ€è¦å®Œå…¨ç›¸åŒçš„å®ä¾‹
- `GetCode()` - ä»ä»»æ„é”™è¯¯ä¸­æå–ä¸šåŠ¡ç ï¼Œç”¨äº Service å±‚åˆ¤æ–­
- `GetMsg()` - ä»é”™è¯¯ä¸­æå–æ¶ˆæ¯
- `Cause()` - è·å–æœ€åº•å±‚çš„åŸå§‹é”™è¯¯
- `IsNotFound()` - æ£€æŸ¥æ˜¯å¦ä¸º"æœªæ‰¾åˆ°"é”™è¯¯ï¼ˆå…¼å®¹ GORMï¼‰

---

## 3. ç»Ÿä¸€å“åº”ç»“æ„

### 3.1 internal/handler/response.go

> **æ¶æ„å˜æ›´è¯´æ˜**ï¼šå“åº”å¤„ç†ä» `api/v1/` ç§»è‡³ `internal/handler/`

```go
package handler

import (
	"errors"
	"net/http"

	"kama_chat_server/pkg/errorx"

	"github.com/gin-gonic/gin"
	"github.com/go-playground/validator/v10"
	"go.uber.org/zap"
)

// ResponseData ç»Ÿä¸€å“åº”ç»“æ„ä½“ (ç”¨äº Swagger æ–‡æ¡£ç”Ÿæˆ)
type ResponseData struct {
	Code int `json:"code"`           // ä¸šåŠ¡å“åº”çŠ¶æ€ç 
	Msg  any `json:"msg"`            // æç¤ºä¿¡æ¯
	Data any `json:"data,omitempty"` // æ•°æ®
}

// HandleSuccess è¿”å›æˆåŠŸå“åº”
func HandleSuccess(c *gin.Context, data any) {
	c.JSON(http.StatusOK, gin.H{
		"code": errorx.CodeSuccess,
		"msg":  "success",
		"data": data,
	})
}

// HandleError é€šç”¨é”™è¯¯å¤„ç†æ–¹æ³•
// è‡ªåŠ¨è¯†åˆ« errorx.CodeError ç±»å‹çš„ä¸šåŠ¡é”™è¯¯ï¼Œæˆ–è€…å°†ç³»ç»Ÿé”™è¯¯è½¬æ¢ä¸º CodeServerBusy
func HandleError(c *gin.Context, err error) {
	// 1. å°è¯•æ–­è¨€ä¸º *errorx.CodeError ç±»å‹
	var codeErr *errorx.CodeError
	if errors.As(err, &codeErr) {
		// ä¸šåŠ¡é”™è¯¯ï¼šç›´æ¥è¿”å›æºå¸¦çš„é”™è¯¯ç å’Œæ¶ˆæ¯
		c.JSON(http.StatusOK, gin.H{
			"code": codeErr.Code,
			"msg":  codeErr.Msg,
			"data": nil,
		})
		return
	}

	// 2. ç³»ç»Ÿé”™è¯¯æˆ–æœªçŸ¥é”™è¯¯ï¼šè®°å½•æ—¥å¿—å¹¶è¿”å›æœåŠ¡ç¹å¿™
	zap.L().Error("system error",
		zap.String("path", c.Request.URL.Path),
		zap.String("method", c.Request.Method),
		zap.Error(err),
	)
	c.JSON(http.StatusOK, gin.H{
		"code": errorx.ErrServerBusy.Code,
		"msg":  errorx.ErrServerBusy.Msg,
		"data": nil,
	})
}

// HandleParamError å¤„ç†å‚æ•°ç»‘å®šé”™è¯¯ï¼ˆå¸¦ validator ç¿»è¯‘æ”¯æŒï¼‰
// è‡ªåŠ¨è¯†åˆ« validator.ValidationErrors ç±»å‹å¹¶è¿›è¡Œç¿»è¯‘
func HandleParamError(c *gin.Context, err error) {
	// å°è¯•æ–­è¨€ä¸º validator.ValidationErrors ç±»å‹
	var validationErrs validator.ValidationErrors
	if errors.As(err, &validationErrs) {
		// ç¿»è¯‘åå»é™¤ç»“æ„ä½“åå‰ç¼€ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
		translatedErrs := RemoveTopStruct(validationErrs.Translate(Trans))
		c.JSON(http.StatusOK, gin.H{
			"code": errorx.ErrInvalidParam.Code,
			"msg":  translatedErrs,
			"data": nil,
		})
		return
	}

	// é validator é”™è¯¯ï¼ˆå¦‚ JSON æ ¼å¼é”™è¯¯ï¼‰
	zap.L().Error("param bind error", zap.Error(err))
	c.JSON(http.StatusOK, gin.H{
		"code": errorx.ErrInvalidParam.Code,
		"msg":  errorx.ErrInvalidParam.Msg,
		"data": nil,
	})
}
```

---

## 4. å‚æ•°éªŒè¯ä¸å›½é™…åŒ–

### 4.1 internal/handler/validator.go

> **è·¯å¾„å˜æ›´**ï¼šä» `api/v1/validator.go` æ”¹ä¸º `internal/handler/validator.go`

```go
package handler

import (
	"fmt"
	"reflect"
	"strings"

	"github.com/gin-gonic/gin/binding"
	"github.com/go-playground/locales/en"
	"github.com/go-playground/locales/zh"
	ut "github.com/go-playground/universal-translator"
	"github.com/go-playground/validator/v10"
	en_translations "github.com/go-playground/validator/v10/translations/en"
	zh_translations "github.com/go-playground/validator/v10/translations/zh"
)

// Trans å®šä¹‰å…¨å±€ç¿»è¯‘å™¨ (å¯¼å‡ºä¾› response.go ä½¿ç”¨)
var Trans ut.Translator

// InitTrans åˆå§‹åŒ–ç¿»è¯‘å™¨
// locale å‚æ•°æŒ‡å®šéœ€è¦åˆå§‹åŒ–çš„è¯­è¨€ï¼Œä¾‹å¦‚ "zh" æˆ– "en"
func InitTrans(locale string) (err error) {
	// ç¡®ä¿ Validator å·²åˆå§‹åŒ– (Gin v1.9+)
	if binding.Validator == nil {
		binding.Validator = &defaultValidator{validator: validator.New()}
	}

	if v, ok := binding.Validator.Engine().(*validator.Validate); ok {
		// æ³¨å†Œ json tag ä½œä¸ºå­—æ®µå
		v.RegisterTagNameFunc(func(fld reflect.StructField) string {
			name := strings.SplitN(fld.Tag.Get("json"), ",", 2)[0]
			if name == "-" {
				return ""
			}
			return name
		})

		zhT := zh.New()
		enT := en.New()
		uni := ut.New(enT, zhT, enT)

		var ok bool
		Trans, ok = uni.GetTranslator(locale)
		if !ok {
			return fmt.Errorf("uni.GetTranslator(%s) failed", locale)
		}

		// æ³¨å†Œç¿»è¯‘å™¨
		switch locale {
		case "en":
			err = en_translations.RegisterDefaultTranslations(v, Trans)
		case "zh":
			err = zh_translations.RegisterDefaultTranslations(v, Trans)
		default:
			err = en_translations.RegisterDefaultTranslations(v, Trans)
		}
	}
	return
}

// RemoveTopStruct å»é™¤æç¤ºä¿¡æ¯ä¸­çš„ç»“æ„ä½“åç§°
func RemoveTopStruct(fields map[string]string) map[string]string {
	res := make(map[string]string)
	for field, err := range fields {
		res[field[strings.Index(field, ".")+1:]] = err
	}
	return res
}

// defaultValidator å®ç° StructValidator æ¥å£
type defaultValidator struct {
	validator *validator.Validate
}

func (v *defaultValidator) ValidateStruct(obj interface{}) error {
	return v.validator.Struct(obj)
}

func (v *defaultValidator) Engine() interface{} {
	return v.validator
}
```

**å®Œæ•´å®ç°è¯´æ˜**ï¼š
- è‡ªåŠ¨æ³¨å†Œ JSON tag ä½œä¸ºå­—æ®µåï¼ˆå‰ç«¯å‹å¥½ï¼‰
- æ”¯æŒä¸­è‹±æ–‡ç¿»è¯‘
- å…¼å®¹ Gin v1.9+ ç‰ˆæœ¬

---

## 5. è¯·æ±‚ DTO ç¤ºä¾‹

### 5.1 internal/dto/request/register_request.go

```go
package request

type RegisterRequest struct {
    Telephone string `json:"telephone" binding:"required"`
    Password  string `json:"password" binding:"required,min=6"`
    Nickname  string `json:"nickname" binding:"required"`
    SmsCode   string `json:"sms_code" binding:"required,len=6"`
}
```

---

## 6. Handler ä¸­ä½¿ç”¨

### 6.1 internal/handler/user_handler.go

> **è·¯å¾„å˜æ›´**ï¼šä» `api/v1/user_info_controller.go` æ”¹ä¸º `internal/handler/user_handler.go`

```go
package handler

import (
	"kama_chat_server/internal/dto/request"
	"kama_chat_server/internal/service"

	"github.com/gin-gonic/gin"
)

// RegisterHandler æ³¨å†Œ
func RegisterHandler(c *gin.Context) {
	var req request.RegisterRequest
	if err := c.ShouldBindJSON(&req); err != nil {
		HandleParamError(c, err)
		return
	}
	data, err := service.Svc.User.Register(req)
	if err != nil {
		HandleError(c, err)
		return
	}
	HandleSuccess(c, data)
}
```

**ç»Ÿä¸€æ¨¡å¼**ï¼š
```go
func XxxHandler(c *gin.Context) {
    // 1. å‚æ•°ç»‘å®š
    var req request.XxxRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        HandleParamError(c, err)
        return
    }

    // 2. è°ƒç”¨ Service å±‚
    data, err := service.Svc.Xxx.Method(req)
    if err != nil {
        HandleError(c, err)
        return
    }

    // 3. è¿”å›æˆåŠŸ
    HandleSuccess(c, data)
}
```

---

## âœ… æœ¬èŠ‚å®Œæˆ

ä½ å·²ç»å®Œæˆäº†ï¼š
- [x] ä¸šåŠ¡é”™è¯¯ç è®¾è®¡ï¼ˆå« CodeUnauthorizedï¼‰
- [x] ç»Ÿä¸€å“åº”å°è£…
- [x] å‚æ•°éªŒè¯åŠä¸­æ–‡ç¿»è¯‘å™¨
- [x] æ§åˆ¶å™¨ä¸­ä½¿ç”¨ç»Ÿä¸€å“åº”

---

## ğŸ“š ä¸‹ä¸€æ­¥

ç»§ç»­å­¦ä¹  [11_ç”¨æˆ·æ¨¡å—API.md](11_ç”¨æˆ·æ¨¡å—API.md)ï¼Œå®Œå–„ç”¨æˆ·æ³¨å†Œã€ç™»å½•ç­‰å®Œæ•´å®ç°ã€‚
