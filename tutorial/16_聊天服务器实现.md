# 16. èŠå¤©æœåŠ¡å™¨å®ç°

> æœ¬æ•™ç¨‹å°†å®ç°æ ¸å¿ƒçš„ `StandaloneServer` ç»“æ„ï¼Œè´Ÿè´£ç®¡ç†æ‰€æœ‰ WebSocket å®¢æˆ·ç«¯è¿æ¥å’Œæ¶ˆæ¯è½¬å‘ã€‚

---

## ğŸ“Œ å­¦ä¹ ç›®æ ‡

- ç†è§£ StandaloneServer çš„å¹¶å‘ç®¡ç†æœºåˆ¶
- æŒæ¡ Login/Logout/Transmit ä¸‰é€šé“æ¨¡å‹
- å®ç°çº¿ç¨‹å®‰å…¨çš„å®¢æˆ·ç«¯ç®¡ç†ï¼ˆsync.Mapï¼‰
- ç†è§£æ¶ˆæ¯å¤„ç†çš„åˆ†å‘æ¨¡å¼

---

## 1. StandaloneServer ç»“æ„è®¾è®¡

> **ä»£ç ä½ç½®**ï¼š`internal/service/chat/channel_server.go`
>
> **é‡è¦è¯´æ˜**ï¼š
> - ä½¿ç”¨ `sync.Map` ä»£æ›¿ `map + mutex`ï¼Œç®€åŒ–å¹¶å‘ç®¡ç†
> - Channel æœ¬èº«æ˜¯å¹¶å‘å®‰å…¨çš„ï¼Œæ— éœ€é¢å¤–åŠ é”

**Server çš„èŒè´£**ï¼š
1. ç»´æŠ¤åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ (`Clients sync.Map`)
2. å¤„ç†ç”¨æˆ·ä¸Šçº¿ (`Login` channel)
3. å¤„ç†ç”¨æˆ·ä¸‹çº¿ (`Logout` channel)
4. æ¥æ”¶å®¢æˆ·ç«¯æ¶ˆæ¯ (`Transmit` channel)ï¼Œè§£æå¹¶å­˜åº“ã€è½¬å‘

---

## 2. StandaloneServer å®ç°

### 2.1 internal/service/chat/channel_server.go

```go
package chat

import (
	"encoding/json"
	"errors"
	"fmt"
	dao "kama_chat_server/internal/dao/mysql"
	myredis "kama_chat_server/internal/dao/redis"
	"kama_chat_server/internal/dto/request"
	"kama_chat_server/internal/dto/respond"
	"kama_chat_server/internal/model"
	"kama_chat_server/pkg/constants"
	"kama_chat_server/pkg/enum/message/message_status_enum"
	"kama_chat_server/pkg/enum/message/message_type_enum"
	"kama_chat_server/pkg/util/snowflake"
	"sync"
	"time"

	"github.com/gorilla/websocket"
	"github.com/redis/go-redis/v9"
	"go.uber.org/zap"
)

// StandaloneServer å®šä¹‰äº† WebSocket æœåŠ¡çš„æ ¸å¿ƒç»“æ„
type StandaloneServer struct {
	// Clients å­˜å‚¨æ‰€æœ‰åœ¨çº¿å®¢æˆ·ç«¯ï¼Œä½¿ç”¨ sync.Map å®ç°å¹¶å‘å®‰å…¨
	Clients sync.Map
	// Transmit æ¶ˆæ¯è½¬å‘é€šé“
	Transmit chan []byte
	// Login å®¢æˆ·ç«¯ç™»å½•é€šé“
	Login chan *UserConn
	// Logout å®¢æˆ·ç«¯ç™»å‡ºé€šé“
	Logout chan *UserConn
}

// GlobalStandaloneServer å…¨å±€å•ä¾‹
var GlobalStandaloneServer *StandaloneServer

// Init åˆå§‹åŒ– StandaloneServer å•ä¾‹
func Init() {
	if GlobalStandaloneServer == nil {
		GlobalStandaloneServer = &StandaloneServer{
			// sync.Map é›¶å€¼å³å¯ç”¨
			Transmit: make(chan []byte, constants.CHANNEL_SIZE),
			Login:    make(chan *UserConn, constants.CHANNEL_SIZE),
			Logout:   make(chan *UserConn, constants.CHANNEL_SIZE),
		}
	}
}
```

**å­—æ®µè¯´æ˜**ï¼š
- `Clients sync.Map`ï¼šå­˜å‚¨æ‰€æœ‰åœ¨çº¿å®¢æˆ·ç«¯ï¼ŒKey ä¸º UserUUIDï¼ŒValue ä¸º `*UserConn`
- `Transmit`ï¼šæ¥æ”¶æ¶ˆæ¯å¹¶è½¬å‘
- `Login`ï¼šå¤„ç†å®¢æˆ·ç«¯ç™»å½•
- `Logout`ï¼šå¤„ç†å®¢æˆ·ç«¯ç™»å‡º

**ä¸ºä»€ä¹ˆä½¿ç”¨ sync.Map**ï¼š
- å†…ç½®å¹¶å‘å®‰å…¨ï¼Œæ— éœ€æ‰‹åŠ¨åŠ é”/è§£é”
- é€‚åˆè¯»å¤šå†™å°‘çš„åœºæ™¯
- ä»£ç æ›´ç®€æ´ï¼Œå‡å°‘æ­»é”é£é™©

---

## 3. Start æ–¹æ³•ï¼šæ ¸å¿ƒäº‹ä»¶å¾ªç¯

```go
// Start å¯åŠ¨ Channel Server ä¸»å¾ªç¯
func (s *StandaloneServer) Start() {
	defer func() {
		close(s.Transmit)
		close(s.Logout)
		close(s.Login)
	}()
	for {
		select {
		// å¤„ç†å®¢æˆ·ç«¯ç™»å½•
		case client := <-s.Login:
			// sync.Map è‡ªåŠ¨å¤„ç†å¹¶å‘å®‰å…¨
			s.Clients.Store(client.Uuid, client)
			zap.L().Debug(fmt.Sprintf("æ¬¢è¿æ¥åˆ°kamaèŠå¤©æœåŠ¡å™¨ï¼Œäº²çˆ±çš„ç”¨æˆ·%s\n", client.Uuid))
			if err := client.Conn.WriteMessage(websocket.TextMessage, []byte("æ¬¢è¿æ¥åˆ°kamaèŠå¤©æœåŠ¡å™¨")); err != nil {
				zap.L().Error(err.Error())
			}

		// å¤„ç†å®¢æˆ·ç«¯ç™»å‡º
		case client := <-s.Logout:
			s.Clients.Delete(client.Uuid)
			zap.L().Info(fmt.Sprintf("ç”¨æˆ·%sé€€å‡ºç™»å½•\n", client.Uuid))
			if err := client.Conn.WriteMessage(websocket.TextMessage, []byte("å·²é€€å‡ºç™»å½•")); err != nil {
				zap.L().Error(err.Error())
			}

		// å¤„ç†æ¶ˆæ¯è½¬å‘
		case data := <-s.Transmit:
			var chatMessageReq request.ChatMessageRequest
			if err := json.Unmarshal(data, &chatMessageReq); err != nil {
				zap.L().Error(err.Error())
				continue
			}

			// æ ¹æ®æ¶ˆæ¯ç±»å‹åˆ†å‘å¤„ç†
			switch chatMessageReq.Type {
			case message_type_enum.Text:
				s.handleTextMessage(chatMessageReq)
			case message_type_enum.File:
				s.handleFileMessage(chatMessageReq)
			case message_type_enum.AudioOrVideo:
				s.handleAVMessage(chatMessageReq)
			}
		}
	}
}
```

**æ ¸å¿ƒé€»è¾‘**ï¼š
1. **select å¤šè·¯å¤ç”¨**ï¼šç›‘å¬ä¸‰ä¸ªé€šé“
2. **Login é€šé“**ï¼šä½¿ç”¨ `sync.Map.Store()` æ³¨å†Œå®¢æˆ·ç«¯
3. **Logout é€šé“**ï¼šä½¿ç”¨ `sync.Map.Delete()` åˆ é™¤å®¢æˆ·ç«¯
4. **Transmit é€šé“**ï¼šæ ¹æ®æ¶ˆæ¯ç±»å‹åˆ†å‘åˆ°ä¸åŒçš„ handler

---

## 4. å®¢æˆ·ç«¯ç®¡ç†æ–¹æ³•

```go
func (s *StandaloneServer) Close() {
	close(s.Login)
	close(s.Logout)
	close(s.Transmit)
}

// Channel æœ¬èº«æ˜¯å¹¶å‘å®‰å…¨çš„ï¼Œæ— éœ€é¢å¤–åŠ é”
func (s *StandaloneServer) SendClientToLogin(client *UserConn) {
	s.Login <- client
}

func (s *StandaloneServer) SendClientToLogout(client *UserConn) {
	s.Logout <- client
}

func (s *StandaloneServer) SendMessageToTransmit(message []byte) {
	s.Transmit <- message
}

func (s *StandaloneServer) GetClient(userId string) *UserConn {
	value, ok := s.Clients.Load(userId)
	if !ok {
		return nil
	}
	return value.(*UserConn)
}
```

**æ³¨æ„**ï¼šChannel æœ¬èº«æ˜¯å¹¶å‘å®‰å…¨çš„ï¼Œå‘é€å’Œæ¥æ”¶æ“ä½œæ— éœ€é¢å¤–åŠ é”ã€‚

---

## 5. æ¶ˆæ¯è·¯å¾„è§„èŒƒåŒ–

```go
// normalizePath å°†å®Œæ•´ URL è½¬æ¢ä¸ºç›¸å¯¹è·¯å¾„
// ä¾‹å¦‚: https://127.0.0.1:8000/static/xxx -> /static/xxx
func normalizePath(path string) string {
	// ä¿ç•™ elemecdn çš„é»˜è®¤å¤´åƒé“¾æ¥
	if strings.HasPrefix(path, "https://cube.elemecdn.com") {
		return path
	}
	idx := strings.Index(path, "/static/")
	if idx == -1 {
		return path
	}
	return path[idx:]
}
```

**ä½œç”¨**ï¼šé˜²æ­¢ IP å‰ç¼€æ±¡æŸ“æ•°æ®åº“ä¸­çš„é™æ€èµ„æºè·¯å¾„ã€‚

---

## 6. å¹¶å‘å®‰å…¨è®¾è®¡

### 6.1 sync.Map vs mutex + map

| ç‰¹æ€§ | sync.Map | mutex + map |
|-----|----------|-------------|
| å¹¶å‘å®‰å…¨ | âœ… å†…ç½® | âŒ éœ€æ‰‹åŠ¨åŠ é” |
| ä»£ç å¤æ‚åº¦ | ä½ | é«˜ |
| é€‚ç”¨åœºæ™¯ | è¯»å¤šå†™å°‘ | å†™æ“ä½œé¢‘ç¹ |
| æ­»é”é£é™© | æ—  | æœ‰ |

### 6.2 Channel çš„ä½œç”¨

`Server.Start()` é‡‡ç”¨äº†ç»å…¸çš„ **Select è½®è¯¢æ¨¡å¼**ï¼š
- æ‰€æœ‰çŠ¶æ€å˜æ›´é€šè¿‡ Channel ä¼ é€’ç»™ Server ä¸»åç¨‹ç»Ÿä¸€å¤„ç†
- Channel æœ¬èº«å¹¶å‘å®‰å…¨ï¼Œæ— éœ€åŠ é”
- ç¬¦åˆ Go "é€šè¿‡é€šä¿¡å…±äº«å†…å­˜" çš„å“²å­¦

---

## 7. æ¶æ„è¯´æ˜

```
                   +----------------------+
                   |  StandaloneServer    |
                   +----------------------+
                   | Clients (sync.Map)   |
                   +--------+-------------+
                            |
          +-----------------+-----------------+
          |                 |                 |
    Login Channel     Logout Channel    Transmit Channel
          |                 |                 |
     Store Client      Delete Client     Handle Message
          â†“                 â†“                 â†“
    sync.Map.Store   sync.Map.Delete   handleXxxMessage
```

---

## 8. åœ¨ main.go ä¸­å¯åŠ¨ ChatServer

```go
package main

import (
	"fmt"
	"kama_chat_server/internal/config"
	"kama_chat_server/internal/service/chat"
	"kama_chat_server/internal/https_server"
)

func main() {
	// åˆå§‹åŒ–é…ç½®
	conf := config.GetConfig()

	// åˆå§‹åŒ– ChatServer
	chat.Init()

	// æ ¹æ®æ¶ˆæ¯æ¨¡å¼é€‰æ‹©å¯åŠ¨æ–¹å¼
	if conf.KafkaConfig.MessageMode == "channel" {
		go chat.GlobalStandaloneServer.Start()
	} else {
		// Kafka æ¨¡å¼
		chat.InitKafkaServer()
		go chat.GlobalMsgConsumer.Start()
	}

	// å¯åŠ¨ HTTP æœåŠ¡å™¨
	https_server.Init()
	https_server.GE.Run(fmt.Sprintf("%s:%d", conf.MainConfig.Host, conf.MainConfig.Port))
}
```

---

## âœ… æœ¬èŠ‚å®Œæˆ

ä½ å·²ç»å®Œæˆäº†ï¼š
- [x] StandaloneServer ç»“æ„è®¾è®¡ï¼ˆä½¿ç”¨ sync.Mapï¼‰
- [x] Login/Logout/Transmit ä¸‰é€šé“æ¨¡å‹
- [x] çº¿ç¨‹å®‰å…¨çš„å®¢æˆ·ç«¯ç®¡ç†
- [x] æ¶ˆæ¯ç±»å‹åˆ†å‘æ¨¡å¼

---

## ğŸ“š ä¸‹ä¸€æ­¥

ç»§ç»­å­¦ä¹  [17_å•èŠä¸ç¾¤èŠæ¶ˆæ¯å¤„ç†.md](17_å•èŠä¸ç¾¤èŠæ¶ˆæ¯å¤„ç†.md)ï¼Œå®ç° `Transmit` é€šé“çš„å®Œæ•´æ¶ˆæ¯å¤„ç†é€»è¾‘ã€‚
