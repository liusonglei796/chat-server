# 02. é…ç½®ç®¡ç†ç³»ç»Ÿ

> æœ¬æ•™ç¨‹å°†å®ç°é¡¹ç›®çš„é…ç½®ç®¡ç†ï¼Œä½¿ç”¨ TOML æ ¼å¼è¿›è¡Œé…ç½®è§£æã€‚

---

## ğŸ“Œ å­¦ä¹ ç›®æ ‡

- ç†è§£ TOML é…ç½®æ ¼å¼
- å®ç°é…ç½®ç»“æ„ä½“è®¾è®¡
- æŒæ¡å•ä¾‹æ¨¡å¼åŠ è½½é…ç½®

---

## 1. TOML é…ç½®æ ¼å¼ç®€ä»‹

TOMLï¼ˆTom's Obvious, Minimal Languageï¼‰æ˜¯ä¸€ç§ç®€æ´æ˜“è¯»çš„é…ç½®æ–‡ä»¶æ ¼å¼ï¼š

```toml
# è¿™æ˜¯æ³¨é‡Š
[section]
key = "value"
number = 123
boolean = true
```

**ä¼˜åŠ¿**ï¼š
- è¯­æ³•ç®€æ´ï¼Œæ˜“äºé˜…è¯»
- æ”¯æŒåµŒå¥—ç»“æ„
- æœ‰æ˜ç¡®çš„ç±»å‹å®šä¹‰

---

## 2. åˆ›å»ºé…ç½®æ–‡ä»¶

### 2.1 configs/config.toml

```toml
# ä¸»é…ç½®
[mainConfig]
appName = "KamaChat"
host = "0.0.0.0"
port = 8000

# MySQL æ•°æ®åº“é…ç½®
[mysqlConfig]
host = "127.0.0.1"
port = 3306
user = "root"
password = "123456"
databaseName = "kama_chat"

# Redis ç¼“å­˜é…ç½®
[redisConfig]
host = "127.0.0.1"
port = 6379
password = ""
db = 0

# é˜¿é‡Œäº‘çŸ­ä¿¡é…ç½®
[authCodeConfig]
accessKeyID = "your_access_key_id"
accessKeySecret = "your_access_key_secret"
signName = "é˜¿é‡Œäº‘çŸ­ä¿¡æµ‹è¯•"
templateCode = "SMS_154950909"

# æ—¥å¿—é…ç½®
[logConfig]
logPath = "./logs"
fileName = "app.log"
maxSize = 100      # å•ä¸ªæ—¥å¿—æ–‡ä»¶æœ€å¤§å¤§å°(MB)
maxBackups = 5     # ä¿ç•™æ—§æ—¥å¿—æ–‡ä»¶çš„æœ€å¤§ä¸ªæ•°
maxAge = 30        # ä¿ç•™æ—§æ—¥å¿—æ–‡ä»¶çš„æœ€å¤§å¤©æ•°
level = "debug"    # æ—¥å¿—çº§åˆ«: debug, info, warn, error

# Kafka æ¶ˆæ¯é˜Ÿåˆ—é…ç½®
[kafkaConfig]
messageMode = "channel"  # æ¶ˆæ¯æ¨¡å¼: channel æˆ– kafka
hostPort = "127.0.0.1:9092"
loginTopic = "login"
chatTopic = "chat_message"
logoutTopic = "logout"
partition = 0
timeout = 1  # å•ä½ç§’

# é™æ€èµ„æºé…ç½®
[staticSrcConfig]
staticAvatarPath = "./static/avatars"
staticFilePath = "./static/files"

# JWT é…ç½®
[jwtConfig]
secret = "kama-chat-super-secret-key-change-in-production"
accessTokenExpiry = 15      # Access Token æœ‰æ•ˆæœŸï¼ˆåˆ†é’Ÿï¼‰
refreshTokenExpiry = 168    # Refresh Token æœ‰æ•ˆæœŸï¼ˆå°æ—¶ï¼‰ï¼Œ168å°æ—¶ = 7å¤©

# é›ªèŠ±ç®—æ³•é…ç½®
[snowflakeConfig]
machineId = 1  # é›ªèŠ±ç®—æ³•èŠ‚ç‚¹ ID (0-1023)ï¼Œåˆ†å¸ƒå¼éƒ¨ç½²æ—¶æ¯ä¸ªèŠ‚ç‚¹éœ€ä¸åŒ
```

---

## 3. å®ç°é…ç½®è§£æ

### 3.1 internal/config/config.go

```go
package config

import (
    "fmt"
    "time"

    "github.com/BurntSushi/toml"
)

// MainConfig ä¸»é…ç½®
type MainConfig struct {
    AppName string `toml:"appName"`
    Host    string `toml:"host"`
    Port    int    `toml:"port"`
}

// MysqlConfig MySQL é…ç½®
type MysqlConfig struct {
    Host         string `toml:"host"`
    Port         int    `toml:"port"`
    User         string `toml:"user"`
    Password     string `toml:"password"`
    DatabaseName string `toml:"databaseName"`
}

// RedisConfig Redis é…ç½®
type RedisConfig struct {
    Host     string `toml:"host"`
    Port     int    `toml:"port"`
    Password string `toml:"password"`
    Db       int    `toml:"db"`
}

// AuthCodeConfig éªŒè¯ç é…ç½®
type AuthCodeConfig struct {
    AccessKeyID     string `toml:"accessKeyID"`
    AccessKeySecret string `toml:"accessKeySecret"`
    SignName        string `toml:"signName"`
    TemplateCode    string `toml:"templateCode"`
}

// LogConfig æ—¥å¿—é…ç½®
type LogConfig struct {
    LogPath    string `toml:"logPath"`
    FileName   string `toml:"fileName"`   // æ—¥å¿—æ–‡ä»¶å
    MaxSize    int    `toml:"maxSize"`    // å•ä¸ªæ—¥å¿—æ–‡ä»¶æœ€å¤§å¤§å°ï¼ˆMBï¼‰
    MaxBackups int    `toml:"maxBackups"` // ä¿ç•™æ—§æ—¥å¿—æ–‡ä»¶çš„æœ€å¤§ä¸ªæ•°
    MaxAge     int    `toml:"maxAge"`     // ä¿ç•™æ—§æ—¥å¿—æ–‡ä»¶çš„æœ€å¤§å¤©æ•°
    Level      string `toml:"level"`      // æ—¥å¿—çº§åˆ«ï¼šdebug, info, warn, error
}

// KafkaConfig Kafka é…ç½®
type KafkaConfig struct {
    MessageMode string        `toml:"messageMode"`
    HostPort    string        `toml:"hostPort"`
    LoginTopic  string        `toml:"loginTopic"`
    LogoutTopic string        `toml:"logoutTopic"`
    ChatTopic   string        `toml:"chatTopic"`
    Partition   int           `toml:"partition"`
    Timeout     time.Duration `toml:"timeout"`
}

// StaticSrcConfig é™æ€èµ„æºé…ç½®
type StaticSrcConfig struct {
    StaticAvatarPath string `toml:"staticAvatarPath"`
    StaticFilePath   string `toml:"staticFilePath"`
}

// JWTConfig JWT é…ç½®
type JWTConfig struct {
    Secret             string `toml:"secret"`
    AccessTokenExpiry  int    `toml:"accessTokenExpiry"`  // åˆ†é’Ÿ
    RefreshTokenExpiry int    `toml:"refreshTokenExpiry"` // å°æ—¶
}

// SnowflakeConfig é›ªèŠ±ç®—æ³•é…ç½®
type SnowflakeConfig struct {
    MachineID int64 `toml:"machineId"` // é›ªèŠ±ç®—æ³•èŠ‚ç‚¹ ID (0-1023)
}

// Config æ€»é…ç½®ç»“æ„
type Config struct {
    MainConfig      `toml:"mainConfig"`
    MysqlConfig     `toml:"mysqlConfig"`
    RedisConfig     `toml:"redisConfig"`
    AuthCodeConfig  `toml:"authCodeConfig"`
    LogConfig       `toml:"logConfig"`
    KafkaConfig     `toml:"kafkaConfig"`
    StaticSrcConfig `toml:"staticSrcConfig"`
    JWTConfig       `toml:"jwtConfig"`
    SnowflakeConfig `toml:"snowflakeConfig"`
}

// å•ä¾‹æ¨¡å¼ï¼šå…¨å±€é…ç½®å®ä¾‹
var config *Config

// LoadConfig åŠ è½½é…ç½®æ–‡ä»¶ï¼ˆæ”¯æŒå¤šè·¯å¾„æœç´¢ï¼‰
func LoadConfig() error {
    paths := []string{
        "configs/config_local.toml",  // ä¼˜å…ˆæœ¬åœ°é…ç½®
        "configs/config.toml",         // é»˜è®¤é…ç½®
        "../../configs/config_local.toml", // å…¼å®¹ä» cmd/ ç›®å½•å¯åŠ¨
        "../../configs/config.toml",
    }

    for _, path := range paths {
        if _, err := toml.DecodeFile(path, config); err == nil {
            return nil
        }
    }

    return fmt.Errorf("could not find configuration file in any of the search paths")
}

// GetConfig è·å–é…ç½®ï¼ˆå•ä¾‹ï¼‰
func GetConfig() *Config {
    if config == nil {
        config = new(Config)
        _ = LoadConfig()
    }
    return config
}
```

---

## 4. è®¾è®¡è§£æ

### 4.1 ç»“æ„ä½“åµŒå…¥

```go
type Config struct {
    MainConfig      `toml:"mainConfig"`      // åµŒå…¥ï¼Œå¯ç›´æ¥è®¿é—® config.AppName
    MysqlConfig     `toml:"mysqlConfig"`
    // ...
}
```

ä½¿ç”¨ Go çš„**ç»“æ„ä½“åµŒå…¥**ç‰¹æ€§ï¼Œå¯ä»¥ç›´æ¥è®¿é—®åµŒå…¥ç»“æ„ä½“çš„å­—æ®µï¼š

```go
cfg := config.GetConfig()
fmt.Println(cfg.AppName)      // ç›´æ¥è®¿é—® MainConfig çš„å­—æ®µ
fmt.Println(cfg.DatabaseName) // ç›´æ¥è®¿é—® MysqlConfig çš„å­—æ®µ
fmt.Println(cfg.Secret)       // ç›´æ¥è®¿é—® JWTConfig çš„å­—æ®µ
fmt.Println(cfg.MachineID)    // ç›´æ¥è®¿é—® SnowflakeConfig çš„å­—æ®µ
```

### 4.2 å•ä¾‹æ¨¡å¼ä¸é…ç½®åŠ è½½

é…ç½®åªéœ€åŠ è½½ä¸€æ¬¡ï¼Œä½¿ç”¨å•ä¾‹æ¨¡å¼ç¡®ä¿å…¨å±€å”¯ä¸€ï¼š

```go
var config *Config  // åŒ…çº§ç§æœ‰å˜é‡

func GetConfig() *Config {
    if config == nil {
        config = new(Config)
        _ = LoadConfig()  // è‡ªåŠ¨æœç´¢é…ç½®æ–‡ä»¶
    }
    return config
}
```

**å¤šè·¯å¾„æœç´¢ç­–ç•¥**ï¼š
1. ä¼˜å…ˆåŠ è½½ `config_local.toml`ï¼ˆæœ¬åœ°å¼€å‘é…ç½®ï¼Œä¸æäº¤åˆ° Gitï¼‰
2. å¦‚æœä¸å­˜åœ¨ï¼ŒåŠ è½½é»˜è®¤çš„ `config.toml`
3. å…¼å®¹ä»ä¸åŒç›®å½•å¯åŠ¨ï¼ˆé¡¹ç›®æ ¹ç›®å½•æˆ– `cmd/` ç›®å½•ï¼‰

### 4.3 TOML æ ‡ç­¾

```go
type MainConfig struct {
    AppName string `toml:"appName"`  // æ˜ å°„åˆ° TOML ä¸­çš„ appName é”®
}
```

`toml` æ ‡ç­¾ç”¨äºæŒ‡å®š TOML æ–‡ä»¶ä¸­çš„é”®åï¼Œå®ç°å¤§å°å†™çµæ´»æ˜ å°„ã€‚

### 4.4 JWT ä¸é›ªèŠ±ç®—æ³•é…ç½®

é¡¹ç›®æ–°å¢äº†ä¸¤ä¸ªé‡è¦é…ç½®ï¼š

**JWTConfig**ï¼šç”¨äºåŒ Token è®¤è¯æœºåˆ¶
- `Secret`ï¼šJWT ç­¾åå¯†é’¥
- `AccessTokenExpiry`ï¼šçŸ­æœŸ Access Token æœ‰æ•ˆæœŸï¼ˆåˆ†é’Ÿï¼‰
- `RefreshTokenExpiry`ï¼šé•¿æœŸ Refresh Token æœ‰æ•ˆæœŸï¼ˆå°æ—¶ï¼‰

**SnowflakeConfig**ï¼šç”¨äºåˆ†å¸ƒå¼ ID ç”Ÿæˆ
- `MachineID`ï¼šé›ªèŠ±ç®—æ³•èŠ‚ç‚¹ IDï¼ˆ0-1023ï¼‰ï¼Œåˆ†å¸ƒå¼éƒ¨ç½²æ—¶æ¯ä¸ªèŠ‚ç‚¹å¿…é¡»å”¯ä¸€

---

## 5. æ›´æ–° main.go

æ›´æ–° `cmd/kama_chat_server/main.go`ï¼š

```go
package main

import (
    "fmt"
    "log"
    "kama_chat_server/internal/config"
)

func main() {
    fmt.Println("KamaChat Server Starting...")
    
    // 1. åŠ è½½é…ç½®
    cfg := config.GetConfig()
    log.Printf("App: %s, Server: %s:%d", 
        cfg.AppName, 
        cfg.Host, 
        cfg.Port)
    
    // TODO: åç»­æ­¥éª¤
    // 2. åˆå§‹åŒ–æ—¥å¿—
    // 3. åˆå§‹åŒ–æ•°æ®åº“
    // 4. åˆå§‹åŒ– Redis
    // 5. å¯åŠ¨æœåŠ¡
    
    log.Println("Server started successfully!")
}
```

### 5.1 è¿è¡Œæµ‹è¯•

```bash
cd cmd/kama_chat_server
go run main.go
```

é¢„æœŸè¾“å‡ºï¼š
```
KamaChat Server Starting...
Config loaded successfully from configs/config.toml
App: KamaChat, Server: 0.0.0.0:8000
Server started successfully!
```

---

## 6. ç¯å¢ƒåŒºåˆ†ï¼ˆå¯é€‰ï¼‰

### 6.1 å¤šç¯å¢ƒé…ç½®

åˆ›å»ºä¸åŒç¯å¢ƒçš„é…ç½®æ–‡ä»¶ï¼š

```
configs/
â”œâ”€â”€ config.toml         # ç”Ÿäº§ç¯å¢ƒé…ç½®ï¼ˆæäº¤åˆ° Gitï¼‰
â””â”€â”€ config_local.toml   # æœ¬åœ°å¼€å‘é…ç½®ï¼ˆä¸æäº¤åˆ° Gitï¼Œæ·»åŠ åˆ° .gitignoreï¼‰
```

**config_local.toml** ç¤ºä¾‹ï¼ˆç”¨äºæœ¬åœ°å¼€å‘ï¼‰ï¼š

```toml
[mainConfig]
appName = "KamaChat-Dev"
host = "localhost"
port = 8000

[mysqlConfig]
host = "127.0.0.1"
port = 3306
user = "root"
password = "your_local_password"
databaseName = "kama_chat_dev"

[redisConfig]
host = "127.0.0.1"
port = 6379
password = ""
db = 0

[jwtConfig]
secret = "dev-secret-key-not-for-production"
accessTokenExpiry = 60       # å¼€å‘ç¯å¢ƒå¯è®¾ç½®æ›´é•¿çš„è¿‡æœŸæ—¶é—´
refreshTokenExpiry = 720     # 30å¤©

[snowflakeConfig]
machineId = 1
```

**é‡è¦æç¤º**ï¼š
- å°† `config_local.toml` æ·»åŠ åˆ° `.gitignore`ï¼Œé˜²æ­¢æ•æ„Ÿä¿¡æ¯æ³„éœ²
- å›¢é˜Ÿæˆå‘˜å„è‡ªç»´æŠ¤è‡ªå·±çš„ `config_local.toml`
- `config.toml` ä½œä¸ºæ¨¡æ¿æäº¤åˆ°ä»£ç åº“

---

## âœ… æœ¬èŠ‚å®Œæˆ

ä½ å·²ç»å®Œæˆäº†ï¼š
- [x] TOML é…ç½®æ–‡ä»¶åˆ›å»º
- [x] é…ç½®ç»“æ„ä½“è®¾è®¡ï¼ˆå« JWT å’Œé›ªèŠ±ç®—æ³•é…ç½®ï¼‰
- [x] å•ä¾‹æ¨¡å¼é…ç½®åŠ è½½
- [x] è¾…åŠ©æ–¹æ³•å®ç°

---

## ğŸ“š ä¸‹ä¸€æ­¥

ç»§ç»­å­¦ä¹  [03_æ—¥å¿—ç³»ç»Ÿæ­å»º.md](03_æ—¥å¿—ç³»ç»Ÿæ­å»º.md)ï¼Œå®ç°ä¸“ä¸šçš„æ—¥å¿—è®°å½•ç³»ç»Ÿã€‚
