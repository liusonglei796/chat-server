# 01. é¡¹ç›®åˆå§‹åŒ–ä¸ç›®å½•ç»“æ„

> æœ¬æ•™ç¨‹å°†æŒ‡å¯¼ä½ ä»é›¶å¼€å§‹åˆå§‹åŒ– KamaChat é¡¹ç›®ï¼Œå¹¶å»ºç«‹è§„èŒƒçš„ç›®å½•ç»“æ„ã€‚

---

## ğŸ“Œ å­¦ä¹ ç›®æ ‡

- äº†è§£ Go é¡¹ç›®çš„æ ‡å‡†ç›®å½•å¸ƒå±€
- æŒæ¡ Go Modules åˆå§‹åŒ–
- ç†è§£å„ç›®å½•çš„èŒè´£åˆ’åˆ†

---

## 1. åˆ›å»ºé¡¹ç›®

### 1.1 åˆå§‹åŒ– Go Module

```bash
# åˆ›å»ºé¡¹ç›®ç›®å½•
mkdir KamaChat && cd KamaChat

# åˆå§‹åŒ– Go Module
go mod init kama_chat_server
```

`go mod init` ä¼šåˆ›å»º `go.mod` æ–‡ä»¶ï¼Œè¿™æ˜¯ Go é¡¹ç›®çš„ä¾èµ–ç®¡ç†æ ¸å¿ƒã€‚

### 1.2 go.mod æ–‡ä»¶è¯´æ˜

```go
module kama_chat_server

go 1.20
```

- `module kama_chat_server`ï¼šå®šä¹‰æ¨¡å—åç§°ï¼Œåç»­å¯¼å…¥åŒ…æ—¶ä½¿ç”¨
- `go 1.20`ï¼šæŒ‡å®š Go è¯­è¨€ç‰ˆæœ¬

---

## 2. ç›®å½•ç»“æ„è®¾è®¡

### 2.1 åˆ›å»ºç›®å½•

```bash
# åˆ›å»ºå®Œæ•´çš„ç›®å½•ç»“æ„
mkdir -p cmd/kama_chat_server
mkdir -p configs
mkdir -p tutorial
mkdir -p internal/{config,dao/mysql/repository,dao/redis,dto/request,dto/respond,https_server,model,router,handler}
mkdir -p internal/service/{chat,contact,group,message,session,user}
mkdir -p internal/infrastructure/{logger,middleware,sms}
mkdir -p pkg/{aes,constants,enum,errorx,util/random,util/jwt,util/snowflake}
mkdir -p test
mkdir -p static/{avatars,files}
```

### 2.2 ç›®å½•èŒè´£è¯´æ˜

```
KamaChat/
â”œâ”€â”€ cmd/                    # åº”ç”¨å…¥å£
â”‚   â””â”€â”€ kama_chat_server/   # ä¸»æœåŠ¡å…¥å£
â”‚       â””â”€â”€ main.go         # main å‡½æ•°
â”‚
â”œâ”€â”€ configs/                # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ config.toml         # é»˜è®¤é…ç½®
â”‚   â””â”€â”€ config_local.toml   # æœ¬åœ°å¼€å‘é…ç½®ï¼ˆä¸æäº¤åˆ° Gitï¼‰
â”‚
â”œâ”€â”€ tutorial/               # æ•™å­¦æ–‡æ¡£
â”‚   â”œâ”€â”€ README.md           # æ•™ç¨‹ç´¢å¼•
â”‚   â””â”€â”€ *.md                # å„ç« èŠ‚æ•™ç¨‹
â”‚
â”œâ”€â”€ internal/               # å†…éƒ¨æ¨¡å—ï¼ˆä¸å¯è¢«å¤–éƒ¨å¯¼å…¥ï¼‰
â”‚   â”œâ”€â”€ config/             # é…ç½®è§£æ
â”‚   â”‚   â””â”€â”€ config.go       # é…ç½®ç»“æ„ä½“å®šä¹‰ä¸åŠ è½½
â”‚   â”‚
â”‚   â”œâ”€â”€ dao/                # æ•°æ®è®¿é—®å±‚ï¼ˆDAOï¼‰
â”‚   â”‚   â”œâ”€â”€ mysql/          # MySQL æ•°æ®è®¿é—®
â”‚   â”‚   â”‚   â”œâ”€â”€ gorm.go     # GORM æ•°æ®åº“åˆå§‹åŒ–
â”‚   â”‚   â”‚   â””â”€â”€ repository/ # Repository æ¨¡å¼å®ç°
â”‚   â”‚   â”‚       â”œâ”€â”€ interfaces.go            # Repository æ¥å£å®šä¹‰
â”‚   â”‚   â”‚       â”œâ”€â”€ user_repository.go       # ç”¨æˆ· Repository
â”‚   â”‚   â”‚       â”œâ”€â”€ contact_repository.go    # è”ç³»äºº Repository
â”‚   â”‚   â”‚       â”œâ”€â”€ group_repository.go      # ç¾¤ç»„ Repository
â”‚   â”‚   â”‚       â”œâ”€â”€ message_repository.go    # æ¶ˆæ¯ Repository
â”‚   â”‚   â”‚       â””â”€â”€ ...                      # å…¶ä»– Repository
â”‚   â”‚   â””â”€â”€ redis/          # Redis æ•°æ®è®¿é—®
â”‚   â”‚       â”œâ”€â”€ init_redis.go     # Redis è¿æ¥åˆå§‹åŒ–
â”‚   â”‚       â”œâ”€â”€ interface.go      # CacheService/AsyncCacheService æ¥å£
â”‚   â”‚       â””â”€â”€ impl.go           # RedisCache å…·ä½“å®ç°
â”‚   â”‚
â”‚   â”œâ”€â”€ dto/                # æ•°æ®ä¼ è¾“å¯¹è±¡ï¼ˆDTOï¼‰
â”‚   â”‚   â”œâ”€â”€ request/        # è¯·æ±‚ DTOï¼ˆæ¥æ”¶å‰ç«¯å‚æ•°ï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ login_request.go
â”‚   â”‚   â”‚   â”œâ”€â”€ register_request.go
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â””â”€â”€ respond/        # å“åº” DTOï¼ˆè¿”å›ç»™å‰ç«¯ï¼‰
â”‚   â”‚       â”œâ”€â”€ login_respond.go
â”‚   â”‚       â”œâ”€â”€ user_info_respond.go
â”‚   â”‚       â””â”€â”€ ...
â”‚   â”‚
â”‚   â”œâ”€â”€ handler/            # HTTP Handler å±‚ï¼ˆå¤„ç†è¯·æ±‚ï¼‰
â”‚   â”‚   â”œâ”€â”€ auth_handler.go     # è®¤è¯ç›¸å…³ Handlerï¼ˆToken åˆ·æ–°ï¼‰
â”‚   â”‚   â”œâ”€â”€ user_handler.go     # ç”¨æˆ·ç›¸å…³ Handler
â”‚   â”‚   â”œâ”€â”€ contact_handler.go  # è”ç³»äººç›¸å…³ Handler
â”‚   â”‚   â”œâ”€â”€ group_handler.go    # ç¾¤ç»„ç›¸å…³ Handler
â”‚   â”‚   â”œâ”€â”€ message_handler.go  # æ¶ˆæ¯ç›¸å…³ Handler
â”‚   â”‚   â”œâ”€â”€ session_handler.go  # ä¼šè¯ç›¸å…³ Handler
â”‚   â”‚   â”œâ”€â”€ ws_handler.go       # WebSocket Handler
â”‚   â”‚   â”œâ”€â”€ response.go         # ç»Ÿä¸€å“åº”å°è£…
â”‚   â”‚   â””â”€â”€ validator.go        # å‚æ•°éªŒè¯
â”‚   â”‚
â”‚   â”œâ”€â”€ https_server/       # HTTPS æœåŠ¡å™¨é…ç½®
â”‚   â”‚   â””â”€â”€ https_server.go # Gin è·¯ç”±åˆå§‹åŒ–ä¸é…ç½®
â”‚   â”‚
â”‚   â”œâ”€â”€ infrastructure/     # åŸºç¡€è®¾æ–½å±‚
â”‚   â”‚   â”œâ”€â”€ logger/         # æ—¥å¿—æ¨¡å—
â”‚   â”‚   â”‚   â””â”€â”€ logger.go   # Zap æ—¥å¿—åˆå§‹åŒ–
â”‚   â”‚   â”œâ”€â”€ middleware/     # ä¸­é—´ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ https_middleware.go # HTTP ä¸­é—´ä»¶
â”‚   â”‚   â”‚   â””â”€â”€ jwt_middleware.go   # JWT è®¤è¯ä¸­é—´ä»¶
â”‚   â”‚   â””â”€â”€ sms/            # çŸ­ä¿¡æœåŠ¡
â”‚   â”‚       â””â”€â”€ auth_code_service.go # é˜¿é‡Œäº‘çŸ­ä¿¡æœåŠ¡å°è£…
â”‚   â”‚
â”‚   â”œâ”€â”€ model/              # æ•°æ®æ¨¡å‹ï¼ˆORM å®ä½“ï¼‰
â”‚   â”‚   â”œâ”€â”€ user_info.go    # ç”¨æˆ·ä¿¡æ¯æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ user_contact.go # è”ç³»äººæ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ group_info.go   # ç¾¤ç»„ä¿¡æ¯æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ group_member.go # ç¾¤ç»„æˆå‘˜æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ message.go      # æ¶ˆæ¯æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ session.go      # ä¼šè¯æ¨¡å‹
â”‚   â”‚   â””â”€â”€ contact_apply.go # è”ç³»äººç”³è¯·æ¨¡å‹
â”‚   â”‚
â”‚   â”œâ”€â”€ router/             # è·¯ç”±æ³¨å†Œ
â”‚   â”‚   â””â”€â”€ router.go       # è·¯ç”±è§„åˆ™å®šä¹‰
â”‚   â”‚
â”‚   â””â”€â”€ service/            # ä¸šåŠ¡æœåŠ¡å±‚ï¼ˆæ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼‰
â”‚       â”œâ”€â”€ interfaces.go   # â­ Service æ¥å£å®šä¹‰ + Services èšåˆ + NewServices æ„é€ å…¥å£
â”‚       â”œâ”€â”€ chat/           # èŠå¤©æœåŠ¡ï¼ˆWebSocket + MQï¼‰
â”‚       â”‚   â”œâ”€â”€ server.go           # ChatServer èšåˆï¼ˆé€‰æ‹© broker + ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼‰
â”‚       â”‚   â”œâ”€â”€ ws_gateway.go       # WebSocket è¿æ¥ç”Ÿå‘½å‘¨æœŸï¼ˆä¾èµ–æ³¨å…¥ brokerï¼‰
â”‚       â”‚   â”œâ”€â”€ channel_broker.go   # Channel æ¨¡å¼ brokerï¼ˆå•æœºï¼‰
â”‚       â”‚   â”œâ”€â”€ kafka_broker.go     # Kafka æ¨¡å¼ brokerï¼ˆåˆ†å¸ƒå¼ï¼‰
â”‚       â”‚   â””â”€â”€ kafka_client.go     # Kafka å®¢æˆ·ç«¯å°è£…
â”‚       â”œâ”€â”€ user/           # ç”¨æˆ·æœåŠ¡
â”‚       â”œâ”€â”€ contact/        # è”ç³»äººæœåŠ¡
â”‚       â”œâ”€â”€ group/          # ç¾¤ç»„æœåŠ¡
â”‚       â”œâ”€â”€ message/        # æ¶ˆæ¯æœåŠ¡
â”‚       â””â”€â”€ session/        # ä¼šè¯æœåŠ¡
â”‚
â”œâ”€â”€ pkg/                    # å…¬å…±åŒ…/å·¥å…·ï¼ˆå¯è¢«å¤–éƒ¨å¯¼å…¥ï¼‰
â”‚   â”œâ”€â”€ aes/                # AES åŠ å¯†å·¥å…·
â”‚   â”‚   â””â”€â”€ aes.go
â”‚   â”œâ”€â”€ constants/          # å¸¸é‡å®šä¹‰
â”‚   â”‚   â””â”€â”€ constants.go
â”‚   â”œâ”€â”€ enum/               # æšä¸¾å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ user_info/      # ç”¨æˆ·ç›¸å…³æšä¸¾
â”‚   â”‚   â”œâ”€â”€ message/        # æ¶ˆæ¯ç›¸å…³æšä¸¾
â”‚   â”‚   â”œâ”€â”€ contact/        # è”ç³»äººç›¸å…³æšä¸¾
â”‚   â”‚   â””â”€â”€ group_info/     # ç¾¤ç»„ç›¸å…³æšä¸¾
â”‚   â”œâ”€â”€ errorx/             # é”™è¯¯å¤„ç†
â”‚   â”‚   â””â”€â”€ errorx.go
â”‚   â””â”€â”€ util/               # é€šç”¨å·¥å…·å‡½æ•°
â”‚       â”œâ”€â”€ random/         # éšæœºæ•°å·¥å…·
â”‚       â”‚   â””â”€â”€ random_int.go
â”‚       â”œâ”€â”€ jwt/            # JWT å·¥å…·
â”‚       â”‚   â””â”€â”€ jwt.go      # JWT Token ç”Ÿæˆä¸è§£æ
â”‚       â””â”€â”€ snowflake/      # é›ªèŠ±ç®—æ³•
â”‚           â””â”€â”€ snowflake.go # åˆ†å¸ƒå¼ ID ç”Ÿæˆå™¨
â”‚
â”œâ”€â”€ static/                 # é™æ€èµ„æº
â”‚   â”œâ”€â”€ avatars/            # ç”¨æˆ·å¤´åƒ
â”‚   â””â”€â”€ files/              # ä¸Šä¼ æ–‡ä»¶
â”‚
â”œâ”€â”€ test/                   # æµ‹è¯•æ–‡ä»¶
â”‚
â”œâ”€â”€ go.mod                  # Go æ¨¡å—å®šä¹‰
â”œâ”€â”€ go.sum                  # ä¾èµ–æ ¡éªŒ
â”œâ”€â”€ docker-compose.yml      # Docker Compose é…ç½®
â””â”€â”€ README.md               # é¡¹ç›®è¯´æ˜
```

---

## 3. æ ¸å¿ƒæ¦‚å¿µè§£é‡Š

### 3.1 internal ç›®å½•

`internal` æ˜¯ Go è¯­è¨€çš„ç‰¹æ®Šç›®å½•ï¼š
- è¯¥ç›®å½•ä¸‹çš„ä»£ç **åªèƒ½è¢«åŒä¸€æ¨¡å—å†…çš„ä»£ç å¯¼å…¥**
- å¤–éƒ¨é¡¹ç›®æ— æ³•å¯¼å…¥ `internal` ä¸­çš„åŒ…
- ç”¨äºå­˜æ”¾å†…éƒ¨å®ç°ï¼Œéšè—å®ç°ç»†èŠ‚

```go
// âœ… å¯ä»¥åœ¨ cmd/kama_chat_server/main.go ä¸­å¯¼å…¥
import "kama_chat_server/internal/config"

// âŒ å¤–éƒ¨é¡¹ç›®æ— æ³•å¯¼å…¥
// import "kama_chat_server/internal/config"  // ç¼–è¯‘é”™è¯¯
```

### 3.2 pkg ç›®å½•

`pkg` ç›®å½•ç”¨äºå­˜æ”¾å¯è¢«å¤–éƒ¨é¡¹ç›®ä½¿ç”¨çš„å…¬å…±ä»£ç ï¼š
- å·¥å…·å‡½æ•°ï¼ˆ`util/`ï¼‰
- é€šç”¨å¸¸é‡ï¼ˆ`constants/`ï¼‰
- åŠ å¯†å·¥å…·ï¼ˆ`aes/`ï¼‰
- JWT å·¥å…·ï¼ˆ`util/jwt/`ï¼‰
- é›ªèŠ±ç®—æ³•ï¼ˆ`util/snowflake/`ï¼‰

### 3.3 åˆ†å±‚æ¶æ„

KamaChat é‡‡ç”¨ç»å…¸çš„åˆ†å±‚æ¶æ„æ¨¡å¼ï¼š

| å±‚çº§ | ç›®å½• | èŒè´£ | ç¤ºä¾‹ |
|-----|------|------|-----|
| **Handler å±‚** | `internal/handler` | å¤„ç† HTTP è¯·æ±‚/å“åº” | è§£æå‚æ•°ã€è°ƒç”¨ Serviceã€è¿”å› JSON |
| **Service å±‚** | `internal/service` | ä¸šåŠ¡é€»è¾‘å¤„ç† | ç”¨æˆ·æ³¨å†Œé€»è¾‘ã€æ¶ˆæ¯å¤„ç†ã€æƒé™æ ¡éªŒ |
| **Repository å±‚** | `internal/dao/mysql/repository` | æ•°æ®è®¿é—®æŠ½è±¡ | å®šä¹‰æ¥å£ã€éšè— ORM ç»†èŠ‚ |
| **DAO å±‚** | `internal/dao/mysql` | æ•°æ®åº“æ“ä½œ | GORMã€Redis æ“ä½œ |
| **Infrastructure å±‚** | `internal/infrastructure` | åŸºç¡€è®¾æ–½ | æ—¥å¿—ã€ä¸­é—´ä»¶ã€çŸ­ä¿¡ |

**è°ƒç”¨é“¾**ï¼šHandler â†’ Service â†’ Repository â†’ DAO â†’ Database

**ä¾èµ–æ³¨å…¥ï¼ˆDIï¼‰**ï¼š
Service å±‚é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥ Repository æ¥å£ä¾èµ–ï¼Œè€Œä¸æ˜¯ç›´æ¥è®¿é—®å…¨å±€å˜é‡ï¼š

```go
// internal/service/interfaces.go - NewServices ä½œä¸ºä¾èµ–æ³¨å…¥å…¥å£ï¼ˆç¤ºæ„ï¼‰
func NewServices(repos *repository.Repositories, cacheService myredis.AsyncCacheService) *Services {
    sessionSvc := session.NewSessionService(repos, cacheService)
    userSvc := user.NewUserService(repos, cacheService)
    // ...

    return &Services{
        User:    userSvc,
        Session: sessionSvc,
        // ...
    }
}
```

**è®¾è®¡ä¼˜åŠ¿**ï¼š
- **å•ä¸€èŒè´£**ï¼šæ¯å±‚åªè´Ÿè´£è‡ªå·±çš„äº‹æƒ…
- **ä¾èµ–å€’ç½®**ï¼šService å±‚ä¾èµ– Repository æ¥å£ï¼Œè€Œä¸æ˜¯å…·ä½“å®ç°
- **æ˜“äºæµ‹è¯•**ï¼šå¯ä»¥ Mock Repository æ¥å£è¿›è¡Œå•å…ƒæµ‹è¯•
- **æ˜“äºæ›¿æ¢**ï¼šæ›¿æ¢æ•°æ®åº“åªéœ€ä¿®æ”¹ Repository å®ç°

---

## 4. å®‰è£…æ ¸å¿ƒä¾èµ–

```bash
# Web æ¡†æ¶
go get github.com/gin-gonic/gin

# ORMï¼ˆæ•°æ®åº“ï¼‰
go get gorm.io/gorm
go get gorm.io/driver/mysql

# Redis
go get github.com/redis/go-redis/v9

# WebSocket
go get github.com/gorilla/websocket

# æ—¥å¿—
go get go.uber.org/zap
go get gopkg.in/natefinch/lumberjack.v2

# é…ç½®è§£æ
go get github.com/BurntSushi/toml

# Kafkaï¼ˆå¯é€‰ï¼Œç”¨äºæ¶ˆæ¯é˜Ÿåˆ—ï¼‰
go get github.com/segmentio/kafka-go

# åŠ å¯†
go get golang.org/x/crypto

# JWT
go get github.com/golang-jwt/jwt/v5
```

è¿è¡Œ `go mod tidy` æ•´ç†ä¾èµ–ï¼š

```bash
go mod tidy
```

---

## 5. åˆ›å»ºå…¥å£æ–‡ä»¶

### 5.1 main.go éª¨æ¶

åˆ›å»º `cmd/kama_chat_server/main.go`ï¼š

```go
package main

import (
    "fmt"
    "log"
)

func main() {
    fmt.Println("KamaChat Server Starting...")
    
    // TODO: åç»­æ­¥éª¤å°†é€æ­¥æ·»åŠ ä»¥ä¸‹åŠŸèƒ½
    // 1. åŠ è½½é…ç½®
    // 2. åˆå§‹åŒ–æ—¥å¿—
    // 3. åˆå§‹åŒ–æ•°æ®åº“
    // 4. åˆå§‹åŒ– Redis
    // 5. åˆå§‹åŒ– HTTPS æœåŠ¡å™¨
    // 6. å¯åŠ¨èŠå¤©æœåŠ¡
    
    log.Println("Server started successfully!")
}
```

### 5.2 è¿è¡Œæµ‹è¯•

```bash
cd cmd/kama_chat_server
go run main.go
```

è¾“å‡ºï¼š
```
KamaChat Server Starting...
Server started successfully!
```

---

## 6. åˆ›å»º .gitignore

åˆ›å»º `.gitignore` æ–‡ä»¶ï¼š

```gitignore
# ç¼–è¯‘è¾“å‡º
*.exe
*.exe~
*.dll
*.so
*.dylib
*.test
*.out

# ä¾èµ–ç¼“å­˜
vendor/

# IDE
.idea/
.vscode/
*.swp
*.swo

# æ—¥å¿—
logs/
*.log

# é…ç½®ï¼ˆåŒ…å«æ•æ„Ÿä¿¡æ¯ï¼‰
configs/config_local.toml

# é™æ€æ–‡ä»¶
static/avatars/*
static/files/*
!static/avatars/.gitkeep
!static/files/.gitkeep

# ç³»ç»Ÿæ–‡ä»¶
.DS_Store
Thumbs.db
```

---

## âœ… æœ¬èŠ‚å®Œæˆ

ä½ å·²ç»å®Œæˆäº†ï¼š
- [x] Go Module åˆå§‹åŒ–
- [x] é¡¹ç›®ç›®å½•ç»“æ„åˆ›å»º
- [x] æ ¸å¿ƒä¾èµ–å®‰è£…
- [x] å…¥å£æ–‡ä»¶åˆ›å»º

---

## ğŸ“š ä¸‹ä¸€æ­¥

ç»§ç»­å­¦ä¹  [02_é…ç½®ç®¡ç†ç³»ç»Ÿ.md](02_é…ç½®ç®¡ç†ç³»ç»Ÿ.md)ï¼Œå®ç°é¡¹ç›®é…ç½®çš„åŠ è½½å’Œè§£æã€‚
