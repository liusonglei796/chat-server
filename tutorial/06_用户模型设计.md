# 06. ç”¨æˆ·æ¨¡å‹è®¾è®¡

> æœ¬æ•™ç¨‹å°†è®¾è®¡ç”¨æˆ·ä¿¡æ¯æ¨¡å‹ï¼Œå¹¶ä½¿ç”¨ GORM å®ç°æ•°æ®åº“è¿ç§»ã€‚

---

## ğŸ“Œ å­¦ä¹ ç›®æ ‡

- ç†è§£ GORM æ¨¡å‹å®šä¹‰è§„èŒƒ
- æŒæ¡æ•°æ®åº“å­—æ®µæ ‡ç­¾é…ç½®
- ç†è§£è‡ªåŠ¨è¿ç§»æœºåˆ¶
- **æŒæ¡å¯†ç å®‰å…¨åŠ å¯†æœ€ä½³å®è·µ**

---

## 1. ç”¨æˆ·è¡¨è®¾è®¡

### 1.1 éœ€æ±‚åˆ†æ

ç”¨æˆ·è¡¨éœ€è¦å­˜å‚¨ä»¥ä¸‹ä¿¡æ¯ï¼š

| å­—æ®µ              | ç±»å‹           | è¯´æ˜            |
| --------------- | ------------ | ------------- |
| uuid            | char(20)     | ç”¨æˆ·å”¯ä¸€æ ‡è¯†        |
| nickname        | varchar(20)  | æ˜µç§°            |
| telephone       | char(11)     | æ‰‹æœºå·ï¼ˆç™»å½•å‡­è¯ï¼‰     |
| email           | char(30)     | é‚®ç®±            |
| avatar          | char(255)    | å¤´åƒ URL        |
| gender          | tinyint      | æ€§åˆ«ï¼ˆ0-ç”·ï¼Œ1-å¥³ï¼‰   |
| signature       | varchar(100) | ä¸ªæ€§ç­¾å          |
| password        | varchar(100) | å¯†ç ï¼ˆbcrypt å“ˆå¸Œï¼‰ |
| birthday        | char(8)      | ç”Ÿæ—¥ï¼ˆYYYYMMDDï¼‰  |
| last_online_at  | datetime     | æœ€ååœ¨çº¿æ—¶é—´        |
| last_offline_at | datetime     | æœ€åç¦»çº¿æ—¶é—´        |
| is_admin        | tinyint      | æ˜¯å¦ç®¡ç†å‘˜         |
| status          | tinyint      | çŠ¶æ€ï¼ˆ0-æ­£å¸¸ï¼Œ1-ç¦ç”¨ï¼‰ |

> **å®‰å…¨æç¤º**ï¼š`password` å­—æ®µä½¿ç”¨ `varchar(100)` å­˜å‚¨ bcrypt å“ˆå¸Œå€¼ï¼ˆå›ºå®š 60 å­—ç¬¦ï¼‰ï¼Œè€Œéæ˜æ–‡å¯†ç ã€‚

---

## 2. å®ç°ç”¨æˆ·æ¨¡å‹

### 2.1 internal/model/user_info.go

```go
package model

import (
    "database/sql"

    "golang.org/x/crypto/bcrypt"
    "gorm.io/gorm"
)

// UserInfo ç”¨æˆ·ä¿¡æ¯æ¨¡å‹
type UserInfo struct {
    gorm.Model                           // å†…åµŒ ID, CreatedAt, UpdatedAt, DeletedAt
    Uuid          string       `gorm:"column:uuid;uniqueIndex;type:char(20);comment:ç”¨æˆ·å”¯ä¸€id"`
    Nickname      string       `gorm:"column:nickname;type:varchar(20);not null;comment:æ˜µç§°"`
    Telephone     string       `gorm:"column:telephone;index;not null;type:char(11);comment:ç”µè¯"`
    Email         string       `gorm:"column:email;type:char(30);comment:é‚®ç®±"`
    Avatar        string       `gorm:"column:avatar;type:char(255);default:https://cube.elemecdn.com/0/88/03b0d39583f48206768a7534e55bcpng.png;not null;comment:å¤´åƒ"`
    Gender        int8         `gorm:"column:gender;comment:æ€§åˆ«ï¼Œ0.ç”·ï¼Œ1.å¥³"`
    Signature     string       `gorm:"column:signature;type:varchar(100);comment:ä¸ªæ€§ç­¾å"`
    Password      string       `gorm:"column:password;type:varchar(100);not null;comment:å¯†ç "`
    Birthday      string       `gorm:"column:birthday;type:char(8);comment:ç”Ÿæ—¥"`
    LastOnlineAt  sql.NullTime `gorm:"column:last_online_at;type:datetime;comment:ä¸Šæ¬¡ç™»å½•æ—¶é—´"`
    LastOfflineAt sql.NullTime `gorm:"column:last_offline_at;type:datetime;comment:æœ€è¿‘ç¦»çº¿æ—¶é—´"`
    IsAdmin       int8         `gorm:"column:is_admin;not null;comment:æ˜¯å¦æ˜¯ç®¡ç†å‘˜ï¼Œ0.ä¸æ˜¯ï¼Œ1.æ˜¯"`
    Status        int8         `gorm:"column:status;index;not null;comment:çŠ¶æ€ï¼Œ0.æ­£å¸¸ï¼Œ1.ç¦ç”¨"`
    RawPassword   string       `gorm:"-" json:"-"` // ä¸å­˜åº“ï¼Œä»…ç”¨äºæ¥æ”¶æ˜æ–‡å¯†ç 
}

// TableName æŒ‡å®šè¡¨å
func (UserInfo) TableName() string {
    return "user_info"
}

// BeforeSave åœ¨åˆ›å»ºå’Œæ›´æ–°å‰è‡ªåŠ¨åŠ å¯†å¯†ç 
func (u *UserInfo) BeforeSave(tx *gorm.DB) (err error) {
    if u.RawPassword != "" {
        hash, err := bcrypt.GenerateFromPassword([]byte(u.RawPassword), bcrypt.DefaultCost)
        if err != nil {
            return err
        }
        u.Password = string(hash)
        u.RawPassword = "" // æ¸…ç©ºæ˜æ–‡
    }
    return nil
}

// CheckPassword æ ¡éªŒå¯†ç æ˜¯å¦æ­£ç¡®
func (u *UserInfo) CheckPassword(plaintext string) bool {
    err := bcrypt.CompareHashAndPassword([]byte(u.Password), []byte(plaintext))
    return err == nil
}
```

å¯¹åº”çš„å»ºè¡¨ SQLï¼ˆç¤ºæ„ï¼Œå®é™…ä»¥ AutoMigrate ç»“æœä¸ºå‡†ï¼‰ï¼š

```sql
CREATE TABLE `user_info` (
  `id` bigint unsigned AUTO_INCREMENT,
  `created_at` datetime(3) NULL,
  `updated_at` datetime(3) NULL,
  `deleted_at` datetime(3) NULL,
  `uuid` char(20) DEFAULT NULL COMMENT 'ç”¨æˆ·å”¯ä¸€id',
  `nickname` varchar(20) NOT NULL COMMENT 'æ˜µç§°',
  `telephone` char(11) NOT NULL COMMENT 'ç”µè¯',
  `email` char(30) DEFAULT NULL COMMENT 'é‚®ç®±',
  `avatar` char(255) NOT NULL DEFAULT 'https://cube.elemecdn.com/0/88/03b0d39583f48206768a7534e55bcpng.png' COMMENT 'å¤´åƒ',
  `gender` tinyint DEFAULT NULL COMMENT 'æ€§åˆ«ï¼Œ0.ç”·ï¼Œ1.å¥³',
  `signature` varchar(100) DEFAULT NULL COMMENT 'ä¸ªæ€§ç­¾å',
  `password` varchar(100) NOT NULL COMMENT 'å¯†ç ',
  `birthday` char(8) DEFAULT NULL COMMENT 'ç”Ÿæ—¥',
  `last_online_at` datetime DEFAULT NULL COMMENT 'ä¸Šæ¬¡ç™»å½•æ—¶é—´',
  `last_offline_at` datetime DEFAULT NULL COMMENT 'æœ€è¿‘ç¦»çº¿æ—¶é—´',
  `is_admin` tinyint NOT NULL COMMENT 'æ˜¯å¦æ˜¯ç®¡ç†å‘˜ï¼Œ0.ä¸æ˜¯ï¼Œ1.æ˜¯',
  `status` tinyint NOT NULL COMMENT 'çŠ¶æ€ï¼Œ0.æ­£å¸¸ï¼Œ1.ç¦ç”¨',
  PRIMARY KEY (`id`),
  INDEX `idx_user_info_deleted_at` (`deleted_at`),
  UNIQUE INDEX `idx_user_info_uuid` (`uuid`),
  INDEX `idx_user_info_telephone` (`telephone`),
  INDEX `idx_user_info_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç”¨æˆ·ä¿¡æ¯è¡¨';
```

---

## 3. å¯†ç å®‰å…¨è®¾è®¡

### 3.1 ä¸ºä»€ä¹ˆä¸èƒ½å­˜å‚¨æ˜æ–‡å¯†ç ï¼Ÿ

å¦‚æœæ•°æ®åº“æ³„éœ²ï¼Œæ‰€æœ‰ç”¨æˆ·å¯†ç å°†ç›´æ¥æš´éœ²ã€‚ä½¿ç”¨ bcrypt å•å‘å“ˆå¸Œå¯ä»¥ï¼š
- å³ä½¿æ•°æ®åº“æ³„éœ²ï¼Œæ”»å‡»è€…ä¹Ÿæ— æ³•ç›´æ¥è·å–å¯†ç 
- bcrypt å†…ç½®ç›å€¼ï¼ˆsaltï¼‰ï¼Œé˜²æ­¢å½©è™¹è¡¨æ”»å‡»
- å¯é…ç½®çš„è®¡ç®—æˆæœ¬ï¼ˆcostï¼‰ï¼Œéšç¡¬ä»¶å‡çº§å¯å¢åŠ éš¾åº¦

### 3.2 RawPassword ä¸ Password åˆ†ç¦»

| å­—æ®µ | ç”¨é€” | æ˜¯å¦å­˜åº“ |
|-----|------|---------| 
| `RawPassword` | æ¥æ”¶å‰ç«¯ä¼ æ¥çš„æ˜æ–‡å¯†ç  | âŒ `gorm:"-"` |
| `Password` | å­˜å‚¨ bcrypt å“ˆå¸Œå€¼ | âœ… `varchar(100)` |

**å·¥ä½œæµç¨‹**ï¼š
1. Service å±‚èµ‹å€¼ `user.RawPassword = req.Password`
2. GORM è°ƒç”¨ `BeforeSave` Hook
3. Hook å°† `RawPassword` åŠ å¯†åèµ‹å€¼ç»™ `Password`
4. æ•°æ®åº“å­˜å‚¨çš„æ˜¯å“ˆå¸Œå€¼

### 3.3 å¯†ç æ ¡éªŒ

```go
// ç™»å½•æ—¶æ ¡éªŒå¯†ç 
if !user.CheckPassword(req.Password) {
    return nil, errors.New("å¯†ç é”™è¯¯")
}
```

---

## 4. GORM æ ‡ç­¾è¯¦è§£

### 4.1 å¸¸ç”¨æ ‡ç­¾

| æ ‡ç­¾ | è¯´æ˜ | ç¤ºä¾‹ |
|-----|------|------|
| `column` | æŒ‡å®šåˆ—å | `gorm:"column:uuid"` |
| `type` | æŒ‡å®šæ•°æ®ç±»å‹ | `gorm:"type:varchar(20)"` |
| `not null` | éç©ºçº¦æŸ | `gorm:"not null"` |
| `default` | é»˜è®¤å€¼ | `gorm:"default:0"` |
| `index` | æ™®é€šç´¢å¼• | `gorm:"index"` |
| `uniqueIndex` | å”¯ä¸€ç´¢å¼• | `gorm:"uniqueIndex"` |
| `comment` | å­—æ®µæ³¨é‡Š | `gorm:"comment:ç”¨æˆ·ID"` |
| `-` | å¿½ç•¥è¯¥å­—æ®µ | `gorm:"-"` |

### 4.2 gorm.Model

å†…åµŒ `gorm.Model` ä¼šè‡ªåŠ¨æ·»åŠ å››ä¸ªå­—æ®µï¼š
- `ID`ï¼šè‡ªå¢ä¸»é”®
- `CreatedAt`ï¼šåˆ›å»ºæ—¶é—´
- `UpdatedAt`ï¼šæ›´æ–°æ—¶é—´
- `DeletedAt`ï¼šè½¯åˆ é™¤æ—¶é—´


---

## 5. UUID ç”Ÿæˆ

### 5.1 pkg/util/random/random_int.go

> **è·¯å¾„å˜æ›´**ï¼šä» `pkg/util/random/random.go` æ”¹ä¸º `pkg/util/random/random_int.go`

é¡¹ç›®ä¸­å·²å°è£…å¥½çš„éšæœºæ•°ç”Ÿæˆå·¥å…·ï¼š

```go
package random

import (
	"crypto/rand"
	"math/big"
	"time"
)

// GetRandomInt ç”ŸæˆæŒ‡å®šä½æ•°çš„å®‰å…¨éšæœºæ•°å­—ï¼ˆç”¨äºéªŒè¯ç ï¼‰
func GetRandomInt(length int) int {
	// è®¡ç®—èŒƒå›´ï¼šä¾‹å¦‚ length=6 æ—¶ï¼ŒèŒƒå›´æ˜¯ 100000-999999
	min := int64(1)
	for i := 1; i < length; i++ {
		min *= 10
	}
	max := min * 10

	// ç”Ÿæˆ [min, max) èŒƒå›´çš„éšæœºæ•°
	rangeSize := big.NewInt(max - min)
	n, err := rand.Int(rand.Reader, rangeSize)
	if err != nil {
		return int(min) // fallback
	}
	return int(n.Int64() + min)
}

// GetNowAndLenRandomString ç”Ÿæˆå¸¦æ—¶é—´æˆ³å‰ç¼€çš„éšæœºå­—ç¬¦ä¸²ï¼ˆç”¨äº UUIDï¼‰
// æ ¼å¼: YYMMDD + å­—æ¯æ•°å­—æ··åˆ
// ç¤ºä¾‹: 241230AbCdE1234567
func GetNowAndLenRandomString(length int) string {
	result := make([]byte, length)
	const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"
	charsetLen := big.NewInt(int64(len(charset)))
	for i := range result {
		n, err := rand.Int(rand.Reader, charsetLen)
		if err != nil {
			result[i] = 'x'
			continue
		}
		result[i] = charset[n.Int64()]
	}
	return time.Now().Format("060102") + string(result)
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```go
import "kama_chat_server/pkg/util/random"

// ç”Ÿæˆç”¨æˆ· UUIDï¼ˆ20ä½ï¼šU + 6ä½æ—¥æœŸ + 13ä½éšæœºï¼‰
uuid := "U" + random.GetNowAndLenRandomString(13)
// ç¤ºä¾‹è¾“å‡º: U241230AbCdE1234567

// ç”Ÿæˆ6ä½æ•°å­—éªŒè¯ç 
code := random.GetRandomInt(6)
// ç¤ºä¾‹è¾“å‡º: 123456
```

**UUID å‘½åè§„èŒƒ**ï¼š

| ç±»å‹ | å‰ç¼€ | æ ¼å¼ | ç¤ºä¾‹ |
|-----|-----|------|------|
| ç”¨æˆ· | U | U + å¹´æœˆæ—¥ + 13ä½éšæœº | U241230AbCdE1234567 |
| ç¾¤ç»„ | G | G + å¹´æœˆæ—¥ + 13ä½éšæœº | G241230XyZ9876543 |
| æ¶ˆæ¯ | M | M + å¹´æœˆæ—¥ + 11ä½éšæœº | M241230kLmN0123 |
| ä¼šè¯ | S | S + å¹´æœˆæ—¥ + 11ä½éšæœº | S241230pQrS4567 |

---

## 6. æ•°æ®åº“è¿ç§»

æˆ‘ä»¬åœ¨ `internal/dao/mysql/init_mysql.go` çš„ `Init` å‡½æ•°ä¸­é…ç½®äº†è‡ªåŠ¨è¿ç§»ï¼Œå¹¶ä¸” **ä¸å†ä½¿ç”¨å…¨å±€ `GormDB/Repos`**ï¼š

> **å½“å‰ä»“åº“çš„çœŸå®å½¢æ€**ï¼š`dao.Init()` è¿”å› `*repository.Repositories`ï¼Œç”± `cmd/kama_chat_server/main.go` ä½œä¸ºç»„åˆæ ¹æ³¨å…¥åˆ° Service å±‚ã€‚

```go
package mysql

import (
    "kama_chat_server/internal/dao/mysql/repository"
    "kama_chat_server/internal/model"
)

// Init åˆå§‹åŒ–æ•°æ®åº“è¿æ¥ï¼Œè‡ªåŠ¨è¿ç§»ï¼Œå¹¶è¿”å› Repositories
func Init() *repository.Repositories {
    // ... è¿æ¥æ•°æ®åº“ ...

    // è‡ªåŠ¨è¿ç§»
    err := db.AutoMigrate(
        &model.UserInfo{},
        &model.GroupInfo{},
        &model.Contact{},
        &model.Session{},
        &model.Apply{},
        &model.Message{},
        &model.GroupMember{},
    )
    if err != nil {
        // ... fatal log ...
    }

    return repository.NewRepositories(db)
}
```

åªè¦å°†æ¨¡å‹ç»“æ„ä½“æŒ‡é’ˆä¼ é€’ç»™ `AutoMigrate`ï¼ŒGORM å°±ä¼šåœ¨å¯åŠ¨æ—¶è‡ªåŠ¨åŒæ­¥æ•°æ®åº“è¡¨ç»“æ„ã€‚

---

## 7. è¿è¡ŒéªŒè¯

```bash
cd cmd/kama_chat_server
go run main.go
```

æŸ¥çœ‹ MySQL æ•°æ®åº“ï¼š
```sql
DESCRIBE user_info;
```

ä½ å°†çœ‹åˆ° `user_info` è¡¨å·²ç»åˆ›å»ºæˆåŠŸï¼ŒåŒ…å«æ‰€æœ‰å®šä¹‰å¥½çš„å­—æ®µã€‚

---

## âœ… æœ¬èŠ‚å®Œæˆ

ä½ å·²ç»å®Œæˆäº†ï¼š
- [x] UserInfo æ¨¡å‹å®šä¹‰
- [x] GORM æ ‡ç­¾é…ç½®
- [x] äº†è§£ UUID ç”Ÿæˆå·¥å…·
- [x] äº†è§£éªŒè¯ç ç”Ÿæˆå·¥å…·
- [x] éªŒè¯æ•°æ®åº“è‡ªåŠ¨è¿ç§»

---

## ğŸ“š ä¸‹ä¸€æ­¥

ç»§ç»­å­¦ä¹  [07_è”ç³»äººä¸ç¾¤ç»„æ¨¡å‹.md](07_è”ç³»äººä¸ç¾¤ç»„æ¨¡å‹.md)ï¼Œè®¾è®¡è”ç³»äººã€ç”³è¯·å’Œç¾¤ç»„æ¨¡å‹ã€‚
