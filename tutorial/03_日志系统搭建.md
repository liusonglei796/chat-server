# 03. æ—¥å¿—ç³»ç»Ÿæ­å»º

> æœ¬æ•™ç¨‹å°†ä½¿ç”¨ Zap + Lumberjack æ„å»ºä¸€ä¸ªç”Ÿäº§çº§çš„æ—¥å¿—ç³»ç»Ÿï¼Œæ”¯æŒæ—¥å¿—åˆ†çº§ã€æ–‡ä»¶è½®è½¬å’Œç»“æ„åŒ–è¾“å‡ºã€‚

---

## ğŸ“Œ å­¦ä¹ ç›®æ ‡

- ç†è§£ Zap æ—¥å¿—åº“çš„ä¼˜åŠ¿
- å®ç°æ—¥å¿—æ–‡ä»¶è½®è½¬
- é…ç½®ä¸åŒçº§åˆ«çš„æ—¥å¿—è¾“å‡º
- é›†æˆ Gin è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶

---

## 1. ä¸ºä»€ä¹ˆé€‰æ‹© Zap

| ç‰¹æ€§ | Zap | æ ‡å‡†åº“ log |
|-----|-----|-----------|
| æ€§èƒ½ | æé«˜ï¼ˆé›¶åˆ†é…ï¼‰ | ä¸€èˆ¬ |
| ç»“æ„åŒ–æ—¥å¿— | âœ… åŸç”Ÿæ”¯æŒ | âŒ |
| æ—¥å¿—çº§åˆ« | âœ… Debug/Info/Warn/Error | âŒ |
| è‡ªå®šä¹‰è¾“å‡º | âœ… å¤šç§ Encoder | æœ‰é™ |

**Zap** æ˜¯ Uber å¼€æºçš„é«˜æ€§èƒ½æ—¥å¿—åº“ï¼Œç‰¹åˆ«é€‚åˆé«˜å¹¶å‘åœºæ™¯ã€‚

---

## 2. å®‰è£…ä¾èµ–

```bash
go get go.uber.org/zap
go get gopkg.in/natefinch/lumberjack.v2
```

- **Zap**ï¼šé«˜æ€§èƒ½ç»“æ„åŒ–æ—¥å¿—
- **Lumberjack**ï¼šæ—¥å¿—æ–‡ä»¶è½®è½¬ï¼ˆæŒ‰å¤§å°/æ—¶é—´åˆ‡å‰²ï¼‰

> **æ³¨æ„**ï¼šä½¿ç”¨ `gopkg.in/natefinch/lumberjack.v2` è€Œä¸æ˜¯ `github.com/natefinch/lumberjack`

---

## 3. å®ç°æ—¥å¿—æ¨¡å—

### 3.1 internal/infrastructure/logger/logger.go

> **é‡è¦å˜æ›´**ï¼šæ—¥å¿—æ¨¡å—ä» `pkg/logger/` ç§»åŠ¨åˆ° `internal/infrastructure/logger/`
>
> **åŸå› **ï¼šæ—¥å¿—æ˜¯åŸºç¡€è®¾æ–½å±‚ç»„ä»¶ï¼Œä¸”ä¸é¡¹ç›®é…ç½®ç´§å¯†è€¦åˆï¼Œä¸åº”ä½œä¸ºå…¬å…±åŒ…æš´éœ²ã€‚

```go
package logger

import (
	"errors"
	"fmt"
	"net"
	"net/http"
	"net/http/httputil"
	"os"
	"runtime/debug"
	"strings"
	"time"

	"kama_chat_server/internal/config"

	"github.com/gin-gonic/gin"
	"go.uber.org/zap"
	"go.uber.org/zap/zapcore"
	"gopkg.in/natefinch/lumberjack.v2"
)

// Init åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ
func Init(cfg *config.LogConfig, mode string) error {
	if cfg == nil {
		return fmt.Errorf("logger.Init received nil config")
	}

	// è®¾ç½®é»˜è®¤å€¼
	if cfg.FileName == "" {
		cfg.FileName = cfg.LogPath + "/app.log"
	}
	if cfg.MaxSize == 0 {
		cfg.MaxSize = 100
	}
	if cfg.MaxBackups == 0 {
		cfg.MaxBackups = 5
	}
	if cfg.MaxAge == 0 {
		cfg.MaxAge = 30
	}
	if cfg.Level == "" {
		cfg.Level = "info"
	}

	// é…ç½®æ—¥å¿—æ–‡ä»¶è½®è½¬
	writeSyncer := getLogWriter(
		cfg.FileName,
		cfg.MaxSize,
		cfg.MaxBackups,
		cfg.MaxAge,
	)
	encoder := getEncoder()

	var level zapcore.Level
	if err := level.UnmarshalText([]byte(cfg.Level)); err != nil {
		return err
	}

	var core zapcore.Core
	if mode == "dev" || mode == gin.DebugMode {
		// å¼€å‘æ¨¡å¼ï¼šåŒæ—¶è¾“å‡ºåˆ°æ–‡ä»¶å’Œæ§åˆ¶å°
		consoleEncoder := zapcore.NewConsoleEncoder(zap.NewDevelopmentEncoderConfig())
		fileCore := zapcore.NewCore(encoder, writeSyncer, level)
		consoleCore := zapcore.NewCore(consoleEncoder, zapcore.Lock(os.Stdout), zapcore.DebugLevel)
		core = zapcore.NewTee(fileCore, consoleCore)
	} else {
		// ç”Ÿäº§æ¨¡å¼ï¼šä»…è¾“å‡ºåˆ°æ–‡ä»¶
		core = zapcore.NewCore(encoder, writeSyncer, level)
	}

	lg := zap.New(core, zap.AddCaller())
	zap.ReplaceGlobals(lg)
	return nil
}

// getLogWriter è·å–æ—¥å¿—å†™å…¥å™¨ï¼ˆæ”¯æŒæ—¥å¿—è½®è½¬ï¼‰
func getLogWriter(filename string, maxSize int, maxBackups int, maxAge int) zapcore.WriteSyncer {
	lumberjackLogger := &lumberjack.Logger{
		Filename:   filename,
		MaxSize:    maxSize,
		MaxBackups: maxBackups,
		MaxAge:     maxAge,
	}
	return zapcore.AddSync(lumberjackLogger)
}

// getEncoder è·å–æ—¥å¿—ç¼–ç å™¨
func getEncoder() zapcore.Encoder {
	encoderConfig := zap.NewDevelopmentEncoderConfig()
	encoderConfig.TimeKey = "time"
	encoderConfig.EncodeTime = zapcore.ISO8601TimeEncoder
	encoderConfig.EncodeLevel = zapcore.CapitalLevelEncoder
	return zapcore.NewJSONEncoder(encoderConfig)
}

// Sync åˆ·æ–°æ—¥å¿—ç¼“å†²åŒºï¼ˆç¨‹åºé€€å‡ºå‰è°ƒç”¨ï¼‰
func Sync() {
	_ = zap.L().Sync()
}
```

---

## 4. Gin è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶

é¡¹ç›®è¿˜å®ç°äº† Gin ä¸“ç”¨çš„æ—¥å¿—ä¸­é—´ä»¶ï¼Œç”¨äºè®°å½• HTTP è¯·æ±‚ï¼š

### 4.1 GinLogger ä¸­é—´ä»¶

```go
// GinLogger è®°å½• HTTP è¯·æ±‚æ—¥å¿—
func GinLogger() gin.HandlerFunc {
	return func(c *gin.Context) {
		// è¯·æ±‚å‰ï¼šè®°å½•å¼€å§‹æ—¶é—´
		start := time.Now()

		// æ‰§è¡Œåç»­ä¸­é—´ä»¶å’Œ Controller
		c.Next()

		// è¯·æ±‚åï¼šè®¡ç®—è€—æ—¶å¹¶è®°å½•æ—¥å¿—
		cost := time.Since(start)

		zap.L().Info("http request",
			zap.Int("status", c.Writer.Status()),
			zap.String("method", c.Request.Method),
			zap.String("path", c.Request.URL.Path),
			zap.String("query", c.Request.URL.RawQuery),
			zap.String("ClientIP", c.ClientIP()),
			zap.String("user-agent", c.Request.UserAgent()),
			zap.Duration("cost", cost),
			zap.String("errors", c.Errors.ByType(gin.ErrorTypePrivate).String()),
		)
	}
}
```

### 4.2 GinRecovery ä¸­é—´ä»¶

```go
// GinRecovery æ•è· panic å¹¶æ¢å¤
func GinRecovery(stack bool) gin.HandlerFunc {
	return func(c *gin.Context) {
		defer func() {
			if rec := recover(); rec != nil {
				// æ£€æŸ¥æ˜¯å¦æ˜¯ broken pipeï¼ˆå®¢æˆ·ç«¯æ–­å¼€è¿æ¥ï¼‰
				var brokenPipe bool
				if err, ok := rec.(error); ok {
					brokenPipe = isBrokenPipeError(err)
				}

				// è·å–è¯·æ±‚ä¿¡æ¯ç”¨äºæ—¥å¿—
				httpRequest, _ := httputil.DumpRequest(c.Request, false)
				requestStr := string(httpRequest)

				fields := []zap.Field{
					zap.Any("error", rec),
					zap.String("request", requestStr),
				}

				if brokenPipe {
					zap.L().Error("broken pipe",
						append(fields, zap.String("path", c.Request.URL.Path))...,
					)
					c.Error(rec.(error))
					c.Abort()
					return
				}

				// å…¶ä»– panicï¼Œæ ¹æ®å‚æ•°å†³å®šæ˜¯å¦æ‰“å°å †æ ˆ
				if stack {
					fields = append(fields, zap.String("stack", string(debug.Stack())))
				}
				zap.L().Error("[Recovery from panic]", fields...)
				c.AbortWithStatus(http.StatusInternalServerError)
			}
		}()
		c.Next()
	}
}
```

---

## 5. æ ¸å¿ƒæ¦‚å¿µè¯¦è§£

### 5.1 Lumberjack æ—¥å¿—è½®è½¬

```go
lumberjackLogger := &lumberjack.Logger{
    Filename:   "logs/app.log",
    MaxSize:    100,  // å•ä¸ªæ–‡ä»¶æœ€å¤§ 100MB
    MaxBackups: 5,    // ä¿ç•™ 5 ä¸ªæ—§æ–‡ä»¶
    MaxAge:     30,   // ä¿ç•™ 30 å¤©
    Compress:   true, // å‹ç¼©æ—§æ–‡ä»¶ä¸º .gz
}
```

**å·¥ä½œæµç¨‹**ï¼š
1. æ—¥å¿—å†™å…¥ `app.log`
2. å½“æ–‡ä»¶è¾¾åˆ° 100MBï¼Œé‡å‘½åä¸º `app-2024-01-01T10-00-00.log`
3. åˆ›å»ºæ–°çš„ `app.log` ç»§ç»­å†™å…¥
4. è¶…è¿‡ 5 ä¸ªå¤‡ä»½æ–‡ä»¶æ—¶ï¼Œåˆ é™¤æœ€æ—§çš„
5. è¶…è¿‡ 30 å¤©çš„æ–‡ä»¶ä¹Ÿä¼šè¢«åˆ é™¤

### 5.2 Zap Core æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Logger    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚     Tee     â”‚  <- å¤šè·¯è¾“å‡º
â”œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     â”‚       â”‚
â–¼     â–¼       â–¼
File  Console  ...
```

`zapcore.NewTee` å…è®¸å°†æ—¥å¿—åŒæ—¶è¾“å‡ºåˆ°å¤šä¸ªç›®æ ‡ã€‚

### 5.3 æ—¥å¿—çº§åˆ«

```
Debug < Info < Warn < Error < DPanic < Panic < Fatal
```

è®¾ç½®çº§åˆ«ä¸º `Info` æ—¶ï¼Œ`Debug` æ—¥å¿—ä¸ä¼šè¾“å‡ºã€‚

---

## 6. ä½¿ç”¨æ–¹æ³•

### 6.1 åŸºæœ¬ä½¿ç”¨

```go
import "go.uber.org/zap"

// ä½¿ç”¨å…¨å±€ Logger
zap.L().Info("User logged in", 
    zap.String("userId", "U123456"),
    zap.String("ip", "192.168.1.1"),
)

zap.L().Error("Failed to save message",
    zap.Error(err),
    zap.String("messageId", "M789"),
)
```

### 6.2 è¾“å‡ºç¤ºä¾‹

**æ§åˆ¶å°è¾“å‡º**ï¼š
```
2024-01-01T10:30:00.123+0800	info	main.go:25	User logged in	{"userId": "U123456", "ip": "192.168.1.1"}
```

**æ—¥å¿—æ–‡ä»¶ï¼ˆJSON æ ¼å¼ï¼‰**ï¼š
```json
{"time":"2024-01-01T10:30:00.123+0800","level":"info","caller":"main.go:25","msg":"User logged in","userId":"U123456","ip":"192.168.1.1"}
```

---

## 7. æ›´æ–° main.go

æ›´æ–° `cmd/kama_chat_server/main.go`ï¼Œä½¿ç”¨æ–°çš„æ—¥å¿—è·¯å¾„ï¼š

```go
package main

import (
	"fmt"
	"log"

	"go.uber.org/zap"
	"kama_chat_server/internal/config"
	"kama_chat_server/internal/infrastructure/logger"
)

func main() {
	fmt.Println("KamaChat Server Starting...")

	// 1. åŠ è½½é…ç½®
	cfg := config.GetConfig()

	// 2. åˆå§‹åŒ–æ—¥å¿—
	if err := logger.Init(&cfg.LogConfig, "dev"); err != nil {
		log.Fatalf("init logger failed: %v", err)
	}
	defer logger.Sync()

	zap.L().Info("é…ç½®åŠ è½½æˆåŠŸ",
		zap.String("app", cfg.AppName),
		zap.Int("port", cfg.Port),
	)

	// TODO: åç»­æ­¥éª¤
	// 3. åˆå§‹åŒ–æ•°æ®åº“
	// 4. åˆå§‹åŒ– Redis
	// 5. å¯åŠ¨æœåŠ¡

	zap.L().Info("æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ")
}
```

---

## 8. åœ¨ Gin ä¸­é›†æˆä¸­é—´ä»¶

```go
// internal/https_server/https_server.go
import "kama_chat_server/internal/infrastructure/logger"

func Init() *gin.Engine {
	engine := gin.New()
	
	// ä½¿ç”¨è‡ªå®šä¹‰æ—¥å¿—ä¸­é—´ä»¶æ›¿ä»£ gin.Logger()
	engine.Use(logger.GinLogger())
	
	// ä½¿ç”¨è‡ªå®šä¹‰æ¢å¤ä¸­é—´ä»¶ï¼ˆå¸¦å †æ ˆä¿¡æ¯ï¼‰
	engine.Use(logger.GinRecovery(true))
	
	return engine
}
```

---

## 9. æœ€ä½³å®è·µ

### 9.1 ä½¿ç”¨ç»“æ„åŒ–å­—æ®µ

```go
// âœ… æ¨èï¼šç»“æ„åŒ–å­—æ®µ
zap.L().Info("Request processed",
    zap.String("method", "POST"),
    zap.String("path", "/api/user"),
    zap.Int("status", 200),
    zap.Duration("latency", time.Since(start)),
)

// âŒ ä¸æ¨èï¼šå­—ç¬¦ä¸²æ‹¼æ¥
zap.L().Info(fmt.Sprintf("Request %s %s processed in %v", method, path, latency))
```

### 9.2 é”™è¯¯æ—¥å¿—åŒ…å«å †æ ˆ

```go
if err != nil {
    zap.L().Error("Database query failed",
        zap.Error(err),  // è‡ªåŠ¨è®°å½•é”™è¯¯ä¿¡æ¯
        zap.String("query", sql),
    )
}
```

### 9.3 æ•æ„Ÿä¿¡æ¯è„±æ•

```go
// ä¸è¦è®°å½•å¯†ç ç­‰æ•æ„Ÿä¿¡æ¯
zap.L().Info("User registered",
    zap.String("telephone", "138****8000"),  // è„±æ•
)
```

---

## âœ… æœ¬èŠ‚å®Œæˆ

ä½ å·²ç»å®Œæˆäº†ï¼š
- [x] Zap + Lumberjack æ—¥å¿—ç³»ç»Ÿ
- [x] æ—¥å¿—æ–‡ä»¶è½®è½¬é…ç½®
- [x] å¤šè·¯è¾“å‡ºï¼ˆæ–‡ä»¶ + æ§åˆ¶å°ï¼‰
- [x] æ—¥å¿—çº§åˆ«æ§åˆ¶
- [x] Gin è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶
- [x] Panic æ¢å¤ä¸­é—´ä»¶

---

## ğŸ“š ä¸‹ä¸€æ­¥

ç»§ç»­å­¦ä¹  [04_æ•°æ®åº“è¿æ¥.md](04_æ•°æ®åº“è¿æ¥.md)ï¼Œå®ç° GORM + MySQL æ•°æ®åº“é›†æˆã€‚
