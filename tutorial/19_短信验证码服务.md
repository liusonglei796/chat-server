# 19. çŸ­ä¿¡éªŒè¯ç æœåŠ¡

> æœ¬æ•™ç¨‹å°†é›†æˆé˜¿é‡Œäº‘çŸ­ä¿¡æœåŠ¡ï¼ˆDysmsapiï¼‰ï¼Œå®ç°çœŸå®çš„éªŒè¯ç å‘é€åŠŸèƒ½ï¼Œå¹¶æ”¯æŒæœ¬åœ° Mock æ¨¡å¼ä¾¿äºå¼€å‘è°ƒè¯•ã€‚

---

## ğŸ“Œ å­¦ä¹ ç›®æ ‡

- ç”³è¯·é˜¿é‡Œäº‘çŸ­ä¿¡æœåŠ¡èµ„è´¨
- é›†æˆé˜¿é‡Œäº‘ Go SDK
- ç†è§£ `SmsService` æ¥å£ä¸ä¾èµ–æ³¨å…¥è®¾è®¡
- å®ç°éªŒè¯ç å‘é€å·¥å…·ç±»
- æŒæ¡ Redis é˜²é‡å¤å‘é€æœºåˆ¶ä¸å¤±è´¥å›æ»š
- ä½¿ç”¨æœ¬åœ° Mock æ¨¡å¼è¿›è¡Œå¼€å‘æµ‹è¯•

---

## 1. å‡†å¤‡å·¥ä½œ

1. æ³¨å†Œå¹¶ç™»å½•é˜¿é‡Œäº‘æ§åˆ¶å°
2. æœç´¢ "çŸ­ä¿¡æœåŠ¡"
3. ç”³è¯· **ç­¾å** (SignName) å’Œ **æ¨¡æ¿** (TemplateCode)
   - æ¨¡æ¿ç¤ºä¾‹ï¼š`æ‚¨çš„éªŒè¯ç ä¸º ${code}ï¼Œè¯·åœ¨5åˆ†é’Ÿå†…ä½¿ç”¨ã€‚`
4. è·å– AccessKey ID å’Œ AccessKey Secret

---

## 2. å®‰è£… SDK

```bash
go get github.com/alibabacloud-go/darabonba-openapi/v2/client
go get github.com/alibabacloud-go/dysmsapi-20170525/v4/client
go get github.com/alibabacloud-go/tea-utils/v2/service
go get github.com/alibabacloud-go/tea/tea
```

---

## 3. é…ç½®æ–‡ä»¶

### 3.1 configs/config.toml

```toml
[authCodeConfig]
accessKeyID = "your-access-key-id"
accessKeySecret = "your-access-key-secret"
signName = "é˜¿é‡Œäº‘çŸ­ä¿¡æµ‹è¯•"      # ä½ çš„çŸ­ä¿¡ç­¾å
templateCode = "SMS_154950909"   # ä½ çš„æ¨¡æ¿Code
```

### 3.2 internal/config/config.go

```go
type AuthCodeConfig struct {
	AccessKeyID     string `toml:"accessKeyID"`
	AccessKeySecret string `toml:"accessKeySecret"`
	SignName        string `toml:"signName"`
	TemplateCode    string `toml:"templateCode"`
}

type Config struct {
	// ...
	AuthCodeConfig AuthCodeConfig `toml:"authCodeConfig"`
}
```

---

## 4. SmsService æ¥å£è®¾è®¡

### 4.1 internal/infrastructure/sms/auth_code_service.go

```go
package sms

import (
	"context"
	"fmt"
	"os"
	"strconv"
	"strings"
	"time"

	openapi "github.com/alibabacloud-go/darabonba-openapi/v2/client"
	dysmsapi20170525 "github.com/alibabacloud-go/dysmsapi-20170525/v4/client"
	util "github.com/alibabacloud-go/tea-utils/v2/service"
	"github.com/alibabacloud-go/tea/tea"
	"go.uber.org/zap"

	"kama_chat_server/internal/config"
	myredis "kama_chat_server/internal/dao/redis"
	"kama_chat_server/pkg/errorx"
	"kama_chat_server/pkg/util/random"
)

// SmsService çŸ­ä¿¡æœåŠ¡æ¥å£
// æŠ½è±¡çŸ­ä¿¡å‘é€æ“ä½œï¼Œæ”¯æŒå¤šç§å®ç°ï¼ˆé˜¿é‡Œäº‘ã€æœ¬åœ° mock ç­‰ï¼‰
type SmsService interface {
	SendVerificationCode(telephone string) error
}

// GlobalSmsService å…¨å±€çŸ­ä¿¡æœåŠ¡å®ä¾‹
var GlobalSmsService SmsService
```

---

## 5. Mock æ¨¡å¼å®ç°

ä¾¿äºæœ¬åœ°å¼€å‘è°ƒè¯•ï¼Œä¸è°ƒç”¨çœŸå®çŸ­ä¿¡ APIï¼š

```go
// localSmsService æœ¬åœ° Mock å®ç°
type localSmsService struct {
	cache myredis.CacheService
}

func (s *localSmsService) SendVerificationCode(telephone string) error {
	key := "auth_code_" + telephone
	code, err := s.cache.Get(context.Background(), key)
	if err != nil {
		zap.L().Error("ç¼“å­˜é¢‘ç‡æ£€æŸ¥å¼‚å¸¸", zap.Error(err))
		return errorx.ErrServerBusy
	}
	if code != "" {
		return errorx.New(errorx.CodeInvalidParam, "ç›®å‰è¿˜ä¸èƒ½å‘é€éªŒè¯ç ï¼Œè¯·ç¨åé‡è¯•")
	}

	code = strconv.Itoa(random.GetRandomInt(6))
	fmt.Printf("ã€MockSMSã€‘æ‰‹æœºå·: %s, éªŒè¯ç : %s\n", telephone, code)

	if err := s.cache.Set(context.Background(), key, code, time.Minute); err != nil {
		return errorx.ErrServerBusy
	}
	return nil
}

// shouldUseMock åˆ¤æ–­æ˜¯å¦ä½¿ç”¨ Mock æ¨¡å¼
func shouldUseMock(auth config.AuthCodeConfig) bool {
	mode := strings.ToLower(strings.TrimSpace(os.Getenv("KAMACHAT_SMS_MODE")))
	if mode == "mock" || mode == "local" || mode == "test" {
		return true
	}
	// æœªé…ç½®çœŸå® AK æ—¶é»˜è®¤èµ° mock
	ak := strings.TrimSpace(auth.AccessKeyID)
	if ak == "" || strings.Contains(strings.ToLower(ak), "your accesskey") {
		return true
	}
	return false
}
```

---

## 6. é˜¿é‡Œäº‘å®ç°

```go
// aliyunSmsService é˜¿é‡Œäº‘çŸ­ä¿¡æœåŠ¡å®ç°
type aliyunSmsService struct {
	client *dysmsapi20170525.Client
	cache  myredis.CacheService
}

// SendVerificationCode å‘é€éªŒè¯ç æ ¸å¿ƒé€»è¾‘
func (s *aliyunSmsService) SendVerificationCode(telephone string) error {
	// 1. å®‰å…¨æ£€æŸ¥
	if s.client == nil {
		return errorx.New(errorx.CodeServerBusy, "çŸ­ä¿¡æœåŠ¡æœªåˆå§‹åŒ–")
	}

	// 2. é¢‘ç‡é™åˆ¶æ£€æŸ¥
	key := "auth_code_" + telephone
	code, err := s.cache.Get(context.Background(), key)
	if err != nil {
		zap.L().Error("ç¼“å­˜é¢‘ç‡æ£€æŸ¥å¼‚å¸¸", zap.Error(err))
		return errorx.ErrServerBusy
	}
	if code != "" {
		return errorx.New(errorx.CodeInvalidParam, "ç›®å‰è¿˜ä¸èƒ½å‘é€éªŒè¯ç ï¼Œè¯·ç¨åé‡è¯•")
	}

	// 3. ç”Ÿæˆ 6 ä½éªŒè¯ç 
	code = strconv.Itoa(random.GetRandomInt(6))
	fmt.Printf("ã€Debugã€‘æ‰‹æœºå·: %s, éªŒè¯ç : %s\n", telephone, code)

	// 4. é¢„å­˜ Redisï¼ˆå…ˆå ä½ï¼Œåå‘é€ï¼‰
	if err := s.cache.Set(context.Background(), key, code, time.Minute); err != nil {
		return errorx.ErrServerBusy
	}

	// 5. é…ç½®åŠ è½½ä¸å…œåº•
	authConfig := config.GetConfig().AuthCodeConfig
	signName := authConfig.SignName
	if signName == "" {
		signName = "é˜¿é‡Œäº‘çŸ­ä¿¡æµ‹è¯•"
	}
	templateCode := authConfig.TemplateCode
	if templateCode == "" {
		templateCode = "SMS_154950909"
	}

	// 6. æ„é€ å‘é€è¯·æ±‚
	sendSmsRequest := &dysmsapi20170525.SendSmsRequest{
		SignName:      tea.String(signName),
		TemplateCode:  tea.String(templateCode),
		PhoneNumbers:  tea.String(telephone),
		TemplateParam: tea.String("{\"code\":\"" + code + "\"}"),
	}

	// 7. æ‰§è¡Œå‘é€
	runtime := &util.RuntimeOptions{}
	rsp, err := s.client.SendSmsWithOptions(sendSmsRequest, runtime)

	// 8. å¤±è´¥å›æ»š
	if err != nil {
		zap.L().Error("è°ƒç”¨é˜¿é‡Œäº‘çŸ­ä¿¡æ¥å£å¤±è´¥", zap.Error(err))
		// ã€å…³é”®ã€‘åˆ é™¤ Redis å ä½ Keyï¼Œå…è®¸ç”¨æˆ·é‡è¯•
		_ = s.cache.Delete(context.Background(), key)
		return errorx.ErrServerBusy
	}

	zap.L().Info("çŸ­ä¿¡å‘é€æˆåŠŸ", zap.String("response", *util.ToJSONString(rsp)))
	return nil
}
```

---

## 7. åˆå§‹åŒ–å‡½æ•°

```go
// Init åˆå§‹åŒ–çŸ­ä¿¡æœåŠ¡
func Init(cacheService myredis.CacheService) error {
	authCfg := config.GetConfig().AuthCodeConfig
	
	// è‡ªåŠ¨åˆ¤æ–­ä½¿ç”¨ Mock è¿˜æ˜¯çœŸå®æœåŠ¡
	if shouldUseMock(authCfg) {
		GlobalSmsService = &localSmsService{cache: cacheService}
		zap.L().Warn("SMS Service ä½¿ç”¨æœ¬åœ° Mock æ¨¡å¼")
		return nil
	}

	// åˆå§‹åŒ–é˜¿é‡Œäº‘å®¢æˆ·ç«¯
	conf := &openapi.Config{
		AccessKeyId:     tea.String(authCfg.AccessKeyID),
		AccessKeySecret: tea.String(authCfg.AccessKeySecret),
	}
	conf.Endpoint = tea.String("dysmsapi.aliyuncs.com")
	client, err := dysmsapi20170525.NewClient(conf)
	if err != nil {
		return err
	}

	GlobalSmsService = &aliyunSmsService{client: client, cache: cacheService}
	return nil
}
```

---

## 8. åœ¨ main.go ä¸­åˆå§‹åŒ–

```go
import "kama_chat_server/internal/infrastructure/sms"

func main() {
	// åˆå§‹åŒ– SMS æœåŠ¡ï¼ˆä¼ å…¥ç¼“å­˜æœåŠ¡å®ä¾‹ï¼‰
	if err := sms.Init(cacheService); err != nil {
		zap.L().Warn("SMS service init failed", zap.Error(err))
	}
	// ...
}
```

---

## 9. é›†æˆåˆ°ç”¨æˆ·æœåŠ¡

### 9.1 internal/service/user/service.go

```go
// SendSmsCode å‘é€çŸ­ä¿¡éªŒè¯ç 
func (u *userInfoService) SendSmsCode(telephone string) error {
	return sms.GlobalSmsService.SendVerificationCode(telephone)
}
```

### 9.2 internal/handler/user_handler.go

```go
func SendSmsCodeHandler(c *gin.Context) {
	var req request.SendSmsCodeRequest
	if err := c.ShouldBindJSON(&req); err != nil {
		HandleParamError(c, err)
		return
	}
	if err := service.Svc.User.SendSmsCode(req.Telephone); err != nil {
		HandleError(c, err)
		return
	}
	HandleSuccess(c, nil)
}
```

---

## 10. éªŒè¯ç éªŒè¯é€»è¾‘

```go
// éªŒè¯éªŒè¯ç 
key := "auth_code_" + telephone
storedCode, err := cacheService.Get(context.Background(), key)
if err != nil {
	return errorx.ErrServerBusy
}
if storedCode != reqCode {
	return errorx.New(errorx.CodeInvalidParam, "éªŒè¯ç ä¸æ­£ç¡®ï¼Œè¯·é‡è¯•")
}

// éªŒè¯æˆåŠŸï¼Œåˆ é™¤éªŒè¯ç 
cacheService.Delete(context.Background(), key)
```

---

## 11. æµ‹è¯•éªŒè¯ç åŠŸèƒ½

### 11.1 å‘é€éªŒè¯ç 

```bash
curl -X POST http://localhost:8000/user/sendSmsCode \
  -H "Content-Type: application/json" \
  -d '{"telephone": "13800138000"}'
```

### 11.2 Mock æ¨¡å¼è¾“å‡º

```
ã€MockSMSã€‘æ‰‹æœºå·: 13800138000, éªŒè¯ç : 123456
```

### 11.3 é‡å¤å‘é€ï¼ˆé˜²åˆ·æµ‹è¯•ï¼‰

```json
{
    "code": 1001,
    "msg": "ç›®å‰è¿˜ä¸èƒ½å‘é€éªŒè¯ç ï¼Œè¯·ç¨åé‡è¯•æˆ–è¾“å…¥å·²å‘é€çš„éªŒè¯ç ",
    "data": null
}
```

---

## 12. ç¯å¢ƒå˜é‡æ§åˆ¶

é€šè¿‡ç¯å¢ƒå˜é‡å¼ºåˆ¶ä½¿ç”¨ Mock æ¨¡å¼ï¼š

```bash
export KAMACHAT_SMS_MODE=mock
```

æ”¯æŒçš„å€¼ï¼š`mock`ã€`local`ã€`test`

---

## âœ… æœ¬èŠ‚å®Œæˆ

ä½ å·²ç»å®Œæˆäº†ï¼š
- [x] é˜¿é‡Œäº‘ SMS SDK v4 é›†æˆ
- [x] SmsService æ¥å£æŠ½è±¡
- [x] ä¾èµ–æ³¨å…¥è®¾è®¡æ¨¡å¼
- [x] æœ¬åœ° Mock æ¨¡å¼æ”¯æŒ
- [x] Redis é˜²é‡å¤å‘é€
- [x] å¤±è´¥å›æ»šæœºåˆ¶
- [x] é…ç½®åŒ–ç­¾åå’Œæ¨¡æ¿

---

## ğŸ“š ä¸‹ä¸€æ­¥

ç»§ç»­å­¦ä¹  [20_æ–‡ä»¶ä¸Šä¼ ä¸é™æ€èµ„æº.md](20_æ–‡ä»¶ä¸Šä¼ ä¸é™æ€èµ„æº.md)ï¼Œå®ç°å¤´åƒå’Œæ–‡ä»¶çš„ä¸Šä¼ ä¸‹è½½ã€‚
