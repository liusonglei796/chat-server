# 19. çŸ­ä¿¡éªŒè¯ç æœåŠ¡

> æœ¬æ•™ç¨‹å°†é›†æˆé˜¿é‡Œäº‘çŸ­ä¿¡æœåŠ¡ï¼ˆDysmsapiï¼‰ï¼Œå®ç°çœŸå®çš„éªŒè¯ç å‘é€åŠŸèƒ½ã€‚

---

## ğŸ“Œ å­¦ä¹ ç›®æ ‡

- ç”³è¯·é˜¿é‡Œäº‘çŸ­ä¿¡æœåŠ¡èµ„è´¨
- é›†æˆé˜¿é‡Œäº‘ Go SDK
- å®ç°éªŒè¯ç å‘é€å·¥å…·ç±»
- ç†è§£ Redis é˜²é‡å¤å‘é€æœºåˆ¶ä¸å¤±è´¥å›æ»š

---

## 1. å‡†å¤‡å·¥ä½œ

1. æ³¨å†Œå¹¶ç™»å½•é˜¿é‡Œäº‘æ§åˆ¶å°
2. æœç´¢ "çŸ­ä¿¡æœåŠ¡"
3. ç”³è¯· **ç­¾å** (SignName) å’Œ **æ¨¡æ¿** (TemplateCode)
   - æ¨¡æ¿ç¤ºä¾‹ï¼š`æ‚¨çš„éªŒè¯ç ä¸º ${code}ï¼Œè¯·åœ¨5åˆ†é’Ÿå†…ä½¿ç”¨ã€‚`
4. è·å– AccessKey ID å’Œ AccessKey Secret

---

## 2. å®‰è£… SDK

```bash
go get github.com/alibabacloud-go/darabonba-openapi/v2/client
go get github.com/alibabacloud-go/dysmsapi-20170525/v4/client
go get github.com/alibabacloud-go/tea-utils/v2/service
go get github.com/alibabacloud-go/tea/tea
```

---

## 3. é…ç½®æ–‡ä»¶

### 3.1 configs/config.toml

```toml
[authCodeConfig]
accessKeyID = "your-access-key-id"
accessKeySecret = "your-access-key-secret"
signName = "é˜¿é‡Œäº‘çŸ­ä¿¡æµ‹è¯•"      # ä½ çš„çŸ­ä¿¡ç­¾å
templateCode = "SMS_154950909"   # ä½ çš„æ¨¡æ¿Code
```

### 3.2 internal/config/config.go

```go
type AuthCodeConfig struct {
	AccessKeyID     string `toml:"accessKeyID"`
	AccessKeySecret string `toml:"accessKeySecret"`
	SignName        string `toml:"signName"`
	TemplateCode    string `toml:"templateCode"`
}

type Config struct {
	// ...
	AuthCodeConfig AuthCodeConfig `toml:"authCodeConfig"`
}
```

---

## 4. å®ç°çŸ­ä¿¡æœåŠ¡

### 4.1 internal/infrastructure/sms/auth_code_service.go

```go
package sms

import (
	"fmt"
	"strconv"
	"time"

	openapi "github.com/alibabacloud-go/darabonba-openapi/v2/client"
	dysmsapi20170525 "github.com/alibabacloud-go/dysmsapi-20170525/v4/client"
	util "github.com/alibabacloud-go/tea-utils/v2/service"
	"github.com/alibabacloud-go/tea/tea"
	"go.uber.org/zap"

	"kama_chat_server/internal/config"
	"kama_chat_server/internal/dao/redis"
	"kama_chat_server/pkg/errorx"
	"kama_chat_server/pkg/util/random"
)

var smsClient *dysmsapi20170525.Client

// Init åˆå§‹åŒ–é˜¿é‡Œäº‘ SMS Client
func Init() error {
	cfgPath := config.GetConfig().AuthCodeConfig
	conf := &openapi.Config{
		AccessKeyId:     tea.String(cfgPath.AccessKeyID),
		AccessKeySecret: tea.String(cfgPath.AccessKeySecret),
	}
	conf.Endpoint = tea.String("dysmsapi.aliyuncs.com")
	client, err := dysmsapi20170525.NewClient(conf)
	if err != nil {
		zap.L().Error("Aliyun SMS Client Init Failed", zap.Error(err))
		return err
	}
	smsClient = client
	return nil
}

// VerificationCode å‘é€éªŒè¯ç 
func VerificationCode(telephone string) error {
	// 1. æ£€æŸ¥å®¢æˆ·ç«¯æ˜¯å¦åˆå§‹åŒ–
	if smsClient == nil {
		zap.L().Error("çŸ­ä¿¡æœåŠ¡è°ƒç”¨å¤±è´¥ï¼šsmsClient æœªåˆå§‹åŒ–")
		return errorx.New(errorx.CodeServerBusy, "çŸ­ä¿¡æœåŠ¡æœªåˆå§‹åŒ–")
	}

	// 2. é¢‘ç‡é™åˆ¶æ£€æŸ¥
	key := "auth_code_" + telephone
	code, err := redis.GetKey(key)
	if err != nil {
		zap.L().Error("Redis é¢‘ç‡æ£€æŸ¥å¼‚å¸¸", zap.Error(err))
		return errorx.ErrServerBusy
	}

	if code != "" {
		return errorx.New(errorx.CodeInvalidParam, "ç›®å‰è¿˜ä¸èƒ½å‘é€éªŒè¯ç ï¼Œè¯·ç¨åé‡è¯•æˆ–è¾“å…¥å·²å‘é€çš„éªŒè¯ç ")
	}

	// 3. ç”Ÿæˆ 6 ä½éªŒè¯ç 
	code = strconv.Itoa(random.GetRandomInt(6))
	fmt.Printf("ã€Debugã€‘æ‰‹æœºå·: %s, éªŒè¯ç : %s\n", telephone, code)

	// 4. é¢„å­˜ Redisï¼ˆå…ˆå ä½ï¼Œåå‘é€ï¼‰
	if err := redis.SetKeyEx(key, code, time.Minute); err != nil {
		zap.L().Error("Redis å†™å…¥éªŒè¯ç å¤±è´¥", zap.Error(err))
		return errorx.ErrServerBusy
	}

	// 5. é…ç½®åŠ è½½ä¸å…œåº•
	authConfig := config.GetConfig().AuthCodeConfig
	signName := authConfig.SignName
	if signName == "" {
		signName = "é˜¿é‡Œäº‘çŸ­ä¿¡æµ‹è¯•"
	}
	templateCode := authConfig.TemplateCode
	if templateCode == "" {
		templateCode = "SMS_154950909"
	}

	// 6. æ„é€ å‘é€è¯·æ±‚
	sendSmsRequest := &dysmsapi20170525.SendSmsRequest{
		SignName:      tea.String(signName),
		TemplateCode:  tea.String(templateCode),
		PhoneNumbers:  tea.String(telephone),
		TemplateParam: tea.String("{\"code\":\"" + code + "\"}"),
	}

	// 7. æ‰§è¡Œå‘é€
	runtime := &util.RuntimeOptions{}
	rsp, err := smsClient.SendSmsWithOptions(sendSmsRequest, runtime)

	// 8. å¤±è´¥å›æ»š
	if err != nil {
		zap.L().Error("è°ƒç”¨é˜¿é‡Œäº‘çŸ­ä¿¡æ¥å£å¤±è´¥", zap.Error(err))
		// ã€å…³é”®ã€‘åˆ é™¤ Redis å ä½ Keyï¼Œå…è®¸ç”¨æˆ·é‡è¯•
		_ = redis.DelKeyIfExists(key)
		return errorx.ErrServerBusy
	}

	zap.L().Info("çŸ­ä¿¡å‘é€æˆåŠŸ", zap.String("response", *util.ToJSONString(rsp)))
	return nil
}
```

**æ ¸å¿ƒè®¾è®¡**ï¼š
- **Init å‡½æ•°**ï¼šåº”ç”¨å¯åŠ¨æ—¶åˆå§‹åŒ– SMS å®¢æˆ·ç«¯
- **å¤±è´¥å›æ»š**ï¼šå‘é€å¤±è´¥æ—¶åˆ é™¤ Redis å ä½ Keyï¼Œå…è®¸ç”¨æˆ·é‡è¯•
- **é…ç½®å…œåº•**ï¼šæœªé…ç½®ç­¾å/æ¨¡æ¿æ—¶ä½¿ç”¨æµ‹è¯•é»˜è®¤å€¼

---

## 5. åœ¨ main.go ä¸­åˆå§‹åŒ–

```go
import "kama_chat_server/internal/infrastructure/sms"

func main() {
	// åˆå§‹åŒ– SMS æœåŠ¡
	if err := sms.Init(); err != nil {
		zap.L().Warn("SMS service init failed, SMS disabled", zap.Error(err))
	}
	// ...
}
```

---

## 6. é›†æˆåˆ°ç”¨æˆ·æœåŠ¡

### 6.1 internal/service/user/service.go

```go
// SendSmsCode å‘é€çŸ­ä¿¡éªŒè¯ç 
func (u *userInfoService) SendSmsCode(telephone string) error {
	return sms.VerificationCode(telephone)
}
```

### 6.2 internal/handler/user_handler.go

```go
func SendSmsCodeHandler(c *gin.Context) {
	var req request.SendSmsCodeRequest
	if err := c.ShouldBindJSON(&req); err != nil {
		HandleParamError(c, err)
		return
	}
	if err := service.Svc.User.SendSmsCode(req.Telephone); err != nil {
		HandleError(c, err)
		return
	}
	HandleSuccess(c, nil)
}
```

---

## 7. éªŒè¯ç éªŒè¯é€»è¾‘

```go
// éªŒè¯éªŒè¯ç 
key := "auth_code_" + telephone
storedCode, err := redis.GetKey(key)
if err != nil {
	return errorx.ErrServerBusy
}
if storedCode != reqCode {
	return errorx.New(errorx.CodeInvalidParam, "éªŒè¯ç ä¸æ­£ç¡®ï¼Œè¯·é‡è¯•")
}

// éªŒè¯æˆåŠŸï¼Œåˆ é™¤éªŒè¯ç 
redis.DelKeyIfExists(key)
```

---

## 8. æµ‹è¯•éªŒè¯ç åŠŸèƒ½

### 8.1 å‘é€éªŒè¯ç 

```bash
curl -X POST http://localhost:8000/user/sendSmsCode \
  -H "Content-Type: application/json" \
  -d '{"telephone": "13800138000"}'
```

### 8.2 é‡å¤å‘é€ï¼ˆé˜²åˆ·æµ‹è¯•ï¼‰

```json
{
    "code": 1001,
    "msg": "ç›®å‰è¿˜ä¸èƒ½å‘é€éªŒè¯ç ï¼Œè¯·ç¨åé‡è¯•æˆ–è¾“å…¥å·²å‘é€çš„éªŒè¯ç ",
    "data": null
}
```

---

## âœ… æœ¬èŠ‚å®Œæˆ

ä½ å·²ç»å®Œæˆäº†ï¼š
- [x] é˜¿é‡Œäº‘ SMS SDK v4 é›†æˆ
- [x] `Init()` å‡½æ•°åˆå§‹åŒ–
- [x] é…ç½®åŒ–ç­¾åå’Œæ¨¡æ¿
- [x] Redis é˜²é‡å¤å‘é€
- [x] å¤±è´¥å›æ»šæœºåˆ¶

---

## ğŸ“š ä¸‹ä¸€æ­¥

ç»§ç»­å­¦ä¹  [20_æ–‡ä»¶ä¸Šä¼ ä¸é™æ€èµ„æº.md](20_æ–‡ä»¶ä¸Šä¼ ä¸é™æ€èµ„æº.md)ï¼Œå®ç°å¤´åƒå’Œæ–‡ä»¶çš„ä¸Šä¼ ä¸‹è½½ã€‚
