# 17. å•èŠä¸ç¾¤èŠæ¶ˆæ¯å¤„ç†

> æœ¬æ•™ç¨‹å°†å®Œå–„æ¶ˆæ¯å¤„ç†é€»è¾‘ï¼Œå®ç°å•èŠå’Œç¾¤èŠçš„æ¶ˆæ¯è§£æã€æŒä¹…åŒ–å­˜å‚¨ä»¥åŠåœ¨çº¿è½¬å‘ã€‚

---

## ğŸ“Œ å­¦ä¹ ç›®æ ‡

- å®ç°æ¶ˆæ¯è¯·æ±‚ DTO è§£æ
- æ¶ˆæ¯æŒä¹…åŒ–åˆ° MySQLï¼ˆä½¿ç”¨é›ªèŠ± IDï¼‰
- å®ç°å•èŠç‚¹å¯¹ç‚¹è½¬å‘
- å®ç°ç¾¤èŠå¹¿æ’­è½¬å‘ï¼ˆæŸ¥è¯¢ GroupMember è¡¨ï¼‰
- ç†è§£åœ¨çº¿å›æ˜¾ä¸ Redis ç¼“å­˜ç­–ç•¥

---

## 1. æ¶ˆæ¯ä¸šåŠ¡æµç¨‹

```mermaid
sequenceDiagram
    participant Sender as å‘é€è€…
    participant Server as èŠå¤©æœåŠ¡å™¨
    participant DB as MySQL (Messageè¡¨)
    participant Redis as Redis (æ¶ˆæ¯ç¼“å­˜)
    participant Receiver as æ¥æ”¶è€…

    Sender->>Server: å‘é€ WebSocket æ¶ˆæ¯ (JSON)
    Server->>Server: 1. Unmarshal è§£æè¯·æ±‚
    Server->>DB: 2. Create æ¶ˆæ¯å­˜åº“ (Snowflake ID)

    alt å•èŠ (ReceiveId = U...)
        Server->>Receiver: 3. åˆ¤æ–­åœ¨çº¿ -> è½¬å‘
        Server->>Sender: 4. å›æ˜¾æ¶ˆæ¯ (ä¿æŒå¤šç«¯åŒæ­¥)
    else ç¾¤èŠ (ReceiveId = G...)
        Server->>DB: æŸ¥è¯¢ GroupMember è¡¨è·å–æˆå‘˜
        Server->>Receiver: 5. éå†æˆå‘˜ -> åœ¨çº¿å¹¿æ’­
    end

    Server->>Redis: 6. å¼‚æ­¥æ›´æ–°æ¶ˆæ¯åˆ—è¡¨ç¼“å­˜
```

---

## 2. ä»£ç ä½ç½®è¯´æ˜

> **ä»£ç ä½ç½®**ï¼š`internal/service/chat/channel_server.go`
>
> **é‡è¦å˜æ›´**ï¼š
> - æ¶ˆæ¯ UUID ä½¿ç”¨é›ªèŠ±ç®—æ³•ç”Ÿæˆçš„ `int64` ç±»å‹
> - ä½¿ç”¨ `sync.Map` ç®¡ç†åœ¨çº¿å®¢æˆ·ç«¯
> - Redis æ›´æ–°é‡‡ç”¨å¼‚æ­¥ goroutine

---

## 3. æ–‡æœ¬æ¶ˆæ¯å¤„ç†

### 3.1 handleTextMessage æ–¹æ³•

```go
// handleTextMessage å¤„ç†æ–‡æœ¬æ¶ˆæ¯
func (s *StandaloneServer) handleTextMessage(req request.ChatMessageRequest) {
	// 1. æ„å»ºæ•°æ®åº“æ¨¡å‹å¯¹è±¡
	message := model.Message{
		Uuid:       snowflake.GenerateID(),     // é›ªèŠ±ç®—æ³•ç”Ÿæˆå”¯ä¸€ID (int64)
		SessionId:  req.SessionId,
		Type:       req.Type,
		Content:    req.Content,
		Url:        "",
		SendId:     req.SendId,
		SendName:   req.SendName,
		SendAvatar: req.SendAvatar,
		ReceiveId:  req.ReceiveId,
		FileSize:   "0B",
		FileType:   "",
		FileName:   "",
		Status:     message_status_enum.Unsent,
		CreatedAt:  time.Now(),
		AVdata:     "",
	}
	// è§„èŒƒåŒ–å¤´åƒè·¯å¾„
	message.SendAvatar = normalizePath(message.SendAvatar)

	// 2. å­˜å…¥ MySQL æ•°æ®åº“
	if res := dao.GormDB.Create(&message); res.Error != nil {
		zap.L().Error(res.Error.Error())
	}

	// 3. æ ¹æ® ReceiveId å‰ç¼€åˆ¤æ–­å•èŠ/ç¾¤èŠ
	if message.ReceiveId[0] == 'U' {
		s.sendToUser(message, req.SendAvatar)
	} else if message.ReceiveId[0] == 'G' {
		s.sendToGroup(message, req.SendAvatar)
	}
}
```

---

## 4. å•èŠæ¶ˆæ¯è½¬å‘

### 4.1 sendToUser æ–¹æ³•

```go
// sendToUser å‘é€æ¶ˆæ¯ç»™å•ä¸ªç”¨æˆ·
func (s *StandaloneServer) sendToUser(message model.Message, originalAvatar string) {
	// 1. æ„é€ è¿”å›ç»™å‰ç«¯çš„å“åº”ä½“
	messageRsp := respond.GetMessageListRespond{
		SendId:     message.SendId,
		SendName:   message.SendName,
		SendAvatar: originalAvatar,
		ReceiveId:  message.ReceiveId,
		Type:       message.Type,
		Content:    message.Content,
		Url:        message.Url,
		FileSize:   message.FileSize,
		FileName:   message.FileName,
		FileType:   message.FileType,
		CreatedAt:  message.CreatedAt.Format("2006-01-02 15:04:05"),
	}

	// 2. åºåˆ—åŒ–ä¸º JSON
	jsonMessage, err := json.Marshal(messageRsp)
	if err != nil {
		zap.L().Error(err.Error())
	}

	// 3. å°è£…ä¸º MessageBack å¯¹è±¡
	messageBack := &MessageBack{
		Message: jsonMessage,
		Uuid:    message.Uuid,  // é›ªèŠ± ID (int64)
	}

	// 4. æ¶ˆæ¯æŠ•é€’ (sync.Map è‡ªåŠ¨å¤„ç†å¹¶å‘å®‰å…¨)
	// ç»™æ¥æ”¶è€…å‘
	if value, ok := s.Clients.Load(message.ReceiveId); ok {
		receiveClient := value.(*UserConn)
		receiveClient.SendBack <- messageBack
	}
	// ç»™å‘é€è€…å›æ˜¾
	if value, ok := s.Clients.Load(message.SendId); ok {
		sendClient := value.(*UserConn)
		sendClient.SendBack <- messageBack
	}

	// 5. å¼‚æ­¥æ›´æ–° Redis ç¼“å­˜
	go s.updateRedisUser(message, messageRsp)
}
```

**å•èŠæ¶ˆæ¯æµç¨‹**ï¼š
```
1. æ„å»º Message å¯¹è±¡ â†’ å­˜å…¥ MySQL
   â†“
2. æ„å»º GetMessageListRespond å“åº”
   â†“
3. æ£€æŸ¥æ¥æ”¶è€…æ˜¯å¦åœ¨çº¿ â†’ å‘é€åˆ° receiveClient.SendBack
   â†“
4. å‘é€å›æ˜¾ç»™å‘é€è€… â†’ å‘é€åˆ° sendClient.SendBack
   â†“
5. å¼‚æ­¥æ›´æ–° Redis ç¼“å­˜ï¼šmessage_list_{sendId}_{receiveId}
```

**ä¸ºä»€ä¹ˆè¦å›æ˜¾**ï¼š
- å‘é€è€…å¯èƒ½æœ‰å¤šä¸ªè®¾å¤‡åœ¨çº¿ï¼ˆæ‰‹æœº+ç”µè„‘ï¼‰
- ä¿è¯æ‰€æœ‰è®¾å¤‡çš„æ¶ˆæ¯åˆ—è¡¨åŒæ­¥

---

## 5. ç¾¤èŠæ¶ˆæ¯å¹¿æ’­

### 5.1 sendToGroup æ–¹æ³•

```go
// sendToGroup å‘é€æ¶ˆæ¯ç»™ç¾¤ç»„
func (s *StandaloneServer) sendToGroup(message model.Message, originalAvatar string) {
	// 1. æ„é€ ç¾¤èŠå“åº”ä½“
	messageRsp := respond.GetGroupMessageListRespond{
		SendId:     message.SendId,
		SendName:   message.SendName,
		SendAvatar: originalAvatar,
		ReceiveId:  message.ReceiveId,
		Type:       message.Type,
		Content:    message.Content,
		Url:        message.Url,
		FileSize:   message.FileSize,
		FileName:   message.FileName,
		FileType:   message.FileType,
		CreatedAt:  message.CreatedAt.Format("2006-01-02 15:04:05"),
	}

	// 2. åºåˆ—åŒ–
	jsonMessage, _ := json.Marshal(messageRsp)
	messageBack := &MessageBack{
		Message: jsonMessage,
		Uuid:    message.Uuid,
	}

	// 3. æŸ¥è¯¢ç¾¤æˆå‘˜åˆ—è¡¨
	var groupMembers []model.GroupMember
	if res := dao.GormDB.Where("group_uuid = ?", message.ReceiveId).Find(&groupMembers); res.Error != nil {
		zap.L().Error(res.Error.Error())
	}

	// 4. åˆ†å‘æ¶ˆæ¯ (sync.Map è‡ªåŠ¨å¤„ç†å¹¶å‘å®‰å…¨)
	for _, gm := range groupMembers {
		if gm.UserUuid != message.SendId {
			// ç»™å…¶ä»–æˆå‘˜æ¨é€
			if value, ok := s.Clients.Load(gm.UserUuid); ok {
				receiveClient := value.(*UserConn)
				receiveClient.SendBack <- messageBack
			}
		} else {
			// ç»™è‡ªå·±(å‘é€è€…)æ¨é€å›æ˜¾
			if value, ok := s.Clients.Load(message.SendId); ok {
				sendClient := value.(*UserConn)
				sendClient.SendBack <- messageBack
			}
		}
	}

	// 5. å¼‚æ­¥æ›´æ–° Redis ç¼“å­˜
	go s.updateRedisGroup(message, messageRsp)
}
```

**ç¾¤èŠæ¶ˆæ¯æµç¨‹**ï¼š
```
1. æ„å»º Message å¯¹è±¡ â†’ å­˜å…¥ MySQL
   â†“
2. æŸ¥è¯¢ GroupMember è¡¨è·å–æ‰€æœ‰æˆå‘˜
   â†“
3. éå†æˆå‘˜åˆ—è¡¨ï¼š
   - æˆå‘˜åœ¨çº¿ â†’ å‘é€åˆ° client.SendBack
   - æˆå‘˜ç¦»çº¿ â†’ è·³è¿‡ï¼ˆä¸‹æ¬¡ç™»å½•ä»æ•°æ®åº“æ‹‰å–ï¼‰
   â†“
4. å¼‚æ­¥æ›´æ–° Redis ç¼“å­˜ï¼šgroup_messagelist_{groupId}
```

---

## 6. æ–‡ä»¶ä¸éŸ³è§†é¢‘æ¶ˆæ¯

### 6.1 æ–‡ä»¶æ¶ˆæ¯

```go
func (s *StandaloneServer) handleFileMessage(req request.ChatMessageRequest) {
	message := model.Message{
		Uuid:       snowflake.GenerateID(),
		// ...
		Content:    "",        // æ–‡ä»¶æ¶ˆæ¯å†…å®¹ä¸ºç©º
		Url:        req.Url,   // å­˜å‚¨æ–‡ä»¶é“¾æ¥
		FileSize:   req.FileSize,
		FileType:   req.FileType,
		FileName:   req.FileName,
	}
	// å­˜åº“ + è½¬å‘é€»è¾‘åŒæ–‡æœ¬æ¶ˆæ¯
}
```

### 6.2 éŸ³è§†é¢‘æ¶ˆæ¯

```go
func (s *StandaloneServer) handleAVMessage(req request.ChatMessageRequest) {
	var avData request.AVData
	json.Unmarshal([]byte(req.AVdata), &avData)

	message := model.Message{
		Uuid:   snowflake.GenerateID(),
		AVdata: req.AVdata,
		// ...
	}

	// åªæœ‰ç‰¹å®šä¿¡ä»¤ç±»å‹ä¼šå…¥åº“
	if avData.MessageId == "PROXY" && (avData.Type == "start_call" || avData.Type == "receive_call" || avData.Type == "reject_call") {
		dao.GormDB.Create(&message)
	}

	// è½¬å‘é€»è¾‘ï¼ˆä¸å›æ˜¾ç»™å‘é€è€…ï¼‰
	// ...
}
```

---

## 7. Redis ç¼“å­˜ç­–ç•¥

### 7.1 å¼‚æ­¥æ›´æ–°ç¼“å­˜

```go
// updateRedisUser æ›´æ–°ç”¨æˆ·é—´èŠå¤©è®°å½•çš„ Redis ç¼“å­˜
func (s *StandaloneServer) updateRedisUser(message model.Message, rsp respond.GetMessageListRespond) {
	key := "message_list_" + message.SendId + "_" + message.ReceiveId
	rspString, err := myredis.GetKeyNilIsErr(key)
	if err == nil {
		var list []respond.GetMessageListRespond
		if json.Unmarshal([]byte(rspString), &list) == nil {
			list = append(list, rsp)
			if rspByte, err := json.Marshal(list); err == nil {
				myredis.SetKeyEx(key, string(rspByte), time.Minute*constants.REDIS_TIMEOUT)
			}
		}
	} else if !errors.Is(err, redis.Nil) {
		zap.L().Error(err.Error())
	}
}
```

**ç¼“å­˜é”®è§„èŒƒ**ï¼š
- å•èŠï¼š`message_list_{sendId}_{receiveId}`
- ç¾¤èŠï¼š`group_messagelist_{groupId}`

---

## 8. æµ‹è¯•æ¶ˆæ¯æ”¶å‘

### 8.1 æµ‹è¯•å•èŠ

```json
{
    "type": 0,
    "content": "Hello B",
    "sendId": "U_AAAA",
    "sendName": "å¼ ä¸‰",
    "sendAvatar": "/static/avatars/xxx.jpg",
    "receiveId": "U_BBBB",
    "sessionId": "S_xxxx"
}
```

### 8.2 æµ‹è¯•ç¾¤èŠ

```json
{
    "type": 0,
    "content": "Hello Group",
    "sendId": "U_AAAA",
    "sendName": "å¼ ä¸‰",
    "sendAvatar": "/static/avatars/xxx.jpg",
    "receiveId": "G_CCCC",
    "sessionId": "S_yyyy"
}
```

---

## âœ… æœ¬èŠ‚å®Œæˆ

ä½ å·²ç»å®Œæˆäº†ï¼š
- [x] æ¶ˆæ¯æ¨¡å‹æŒä¹…åŒ–ï¼ˆMySQL + é›ªèŠ± IDï¼‰
- [x] å¤´åƒè·¯å¾„è§„èŒƒåŒ–å¤„ç†
- [x] å•èŠåœ¨çº¿è½¬å‘ä¸å›æ˜¾ï¼ˆsync.Mapï¼‰
- [x] ç¾¤èŠæˆå‘˜å¹¿æ’­ï¼ˆGroupMember è¡¨æŸ¥è¯¢ï¼‰
- [x] Redis ç¼“å­˜å¼‚æ­¥æ›´æ–°
- [x] æ–‡ä»¶å’ŒéŸ³è§†é¢‘æ¶ˆæ¯å¤„ç†

---

## ğŸ“š ä¸‹ä¸€æ­¥

ç»§ç»­å­¦ä¹  [18_Kafkaé›†æˆä¸æ¶ˆæ¯æ¨¡å¼.md](18_Kafkaé›†æˆä¸æ¶ˆæ¯æ¨¡å¼.md)ï¼Œäº†è§£ Kafka æ¨¡å¼çš„å®ç°ã€‚
