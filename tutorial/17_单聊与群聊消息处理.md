# 17. å•èŠä¸ç¾¤èŠæ¶ˆæ¯å¤„ç†

> æœ¬ç« ä»¥å½“å‰ä»£ç ä¸ºå‡†ï¼Œè®²æ¸…æ¥šæ¶ˆæ¯ä» WebSocket è¿›å…¥åï¼Œå¦‚ä½•åœ¨ Broker å†…å®Œæˆï¼šè§£æ â†’ å…¥åº“ â†’ å•èŠ/ç¾¤èŠè½¬å‘ â†’ å¼‚æ­¥æ›´æ–°ç¼“å­˜ã€‚

---

## ğŸ“Œ å­¦ä¹ ç›®æ ‡

- ç†è§£æ¶ˆæ¯å¤„ç†çš„å…¥å£ï¼š`StandaloneServer.Start()` / `MsgConsumer.Start()`
- æŒæ¡æ–‡æœ¬/æ–‡ä»¶/éŸ³è§†é¢‘ä¿¡ä»¤ä¸‰ç±»æ¶ˆæ¯çš„å¤„ç†å·®å¼‚
- ç†è§£å•èŠç‚¹å¯¹ç‚¹æ¨é€ä¸â€œå‘é€è€…å›æ˜¾â€çš„ç›®çš„
- ç†è§£ç¾¤èŠå¹¿æ’­ï¼šé€šè¿‡ GroupMemberRepository æŸ¥è¯¢æˆå‘˜å¹¶åœ¨çº¿æ¨é€
- ç†è§£ Redis ç¼“å­˜æ›´æ–°ï¼šé€šè¿‡æ³¨å…¥çš„ `AsyncCacheService.SubmitTask()` å¼‚æ­¥æ‰§è¡Œ

---

## 1. ä»£ç ä½ç½®è¯´æ˜ï¼ˆä»¥å½“å‰å®ç°ä¸ºå‡†ï¼‰

- Channel æ¨¡å¼ï¼ˆå•æœºï¼‰ï¼š`internal/service/chat/channel_broker.go`
- Kafka æ¨¡å¼ï¼ˆåˆ†å¸ƒå¼ï¼‰ï¼š`internal/service/chat/kafka_broker.go`

ä¸¤ç§æ¨¡å¼çš„â€œä¸šåŠ¡å¤„ç†å‡½æ•°â€ç»“æ„éå¸¸ç›¸è¿‘ï¼š

- `handleTextMessage()` / `handleFileMessage()` / `handleAVMessage()`
- `sendToUser()` / `sendToGroup()`

---

## 2. æ¶ˆæ¯ä¸šåŠ¡æµç¨‹ï¼ˆé«˜å±‚ï¼‰

```mermaid
sequenceDiagram
    participant Sender as å‘é€è€…(WS)
    participant Broker as MessageBroker
    participant Repo as MessageRepo(MySQL)
    participant Cache as AsyncCacheService(Redis)
    participant Receiver as æ¥æ”¶è€…(WS)

    Sender->>Broker: Publish(JSON)
    Broker->>Broker: Unmarshal ChatMessageRequest
    Broker->>Repo: Create(Message)

    alt å•èŠ ReceiveId=U...
        Broker->>Receiver: SendBack æ¨é€(è‹¥åœ¨çº¿)
        Broker->>Sender: SendBack å›æ˜¾(è‹¥åœ¨çº¿)
        Broker->>Cache: SubmitTask æ›´æ–° message_list
    else ç¾¤èŠ ReceiveId=G...
        Broker->>Broker: GroupMemberRepo.FindByGroupUuid
        Broker->>Receiver: éå†æˆå‘˜åœ¨çº¿æ¨é€
        Broker->>Sender: å›æ˜¾
        Broker->>Cache: SubmitTask æ›´æ–° group_messagelist
    end
```

---

## 3. DTOï¼šChatMessageRequestï¼ˆè¯·æ±‚ä½“ï¼‰

> DTO å®šä¹‰åœ¨ï¼š`internal/dto/request/chat_message_request.go`

é‡ç‚¹å­—æ®µï¼ˆåªåˆ—æ ¸å¿ƒï¼‰ï¼š

- `session_id`ï¼šä¼šè¯ID
- `type`ï¼šæ¶ˆæ¯ç±»å‹ï¼ˆæšä¸¾å€¼è§ä¸‹ï¼‰
- `content/url/file_size/file_type/file_name/av_data`ï¼šä¸åŒç±»å‹æ¶ˆæ¯ä½¿ç”¨ä¸åŒå­—æ®µ
- `send_id` / `receive_id`ï¼šå‘é€æ–¹/æ¥æ”¶æ–¹ï¼ˆ`U...` å•èŠç”¨æˆ·ã€`G...` ç¾¤èŠï¼‰

æ¶ˆæ¯ç±»å‹æšä¸¾ï¼ˆä»¥ä»£ç ä¸ºå‡†ï¼‰ï¼š

- `0`ï¼šText
- `1`ï¼šVoice
- `2`ï¼šFile
- `3`ï¼šAudioOrVideo

---

## 4. æ–‡æœ¬æ¶ˆæ¯ï¼šhandleTextMessage

Channel æ¨¡å¼å®ç°ï¼ˆKafka æ¨¡å¼åŒç†ï¼‰ï¼š

```go
// internal/service/chat/channel_broker.go

func (s *StandaloneServer) handleTextMessage(req request.ChatMessageRequest) {
    message := model.Message{
        Uuid:       snowflake.GenerateID(),
        SessionId:  req.SessionId,
        Type:       req.Type,
        Content:    req.Content,
        Url:        "",
        SendId:     req.SendId,
        SendName:   req.SendName,
        SendAvatar: req.SendAvatar,
        ReceiveId:  req.ReceiveId,
        FileSize:   "0B",
        FileType:   "",
        FileName:   "",
        Status:     message_status_enum.Unsent,
        AVdata:     "",
    }

    // è§„èŒƒåŒ–å¤´åƒè·¯å¾„
    message.SendAvatar = normalizePath(message.SendAvatar)

    // é€šè¿‡ Repository å…¥åº“ï¼ˆä¾èµ–å€’ç½®ï¼‰
    if s.messageRepo != nil {
        _ = s.messageRepo.Create(&message)
    }

    // æ ¹æ® ReceiveId å‰ç¼€è·¯ç”±
    if message.ReceiveId[0] == 'U' {
        s.sendToUser(message, req.SendAvatar)
    } else if message.ReceiveId[0] == 'G' {
        s.sendToGroup(message, req.SendAvatar)
    }
}
```

è¦ç‚¹ï¼š

- UUID ä½¿ç”¨é›ªèŠ±ç®—æ³•ç”Ÿæˆ `int64`
- å…¥åº“ä½¿ç”¨ `MessageRepository.Create()`ï¼Œä¸åœ¨ Broker å†…ç›´æ¥è°ƒç”¨ Gorm

---

## 5. å•èŠè½¬å‘ï¼šsendToUserï¼ˆæ¨é€ + å›æ˜¾ + ç¼“å­˜ï¼‰

```go
// internal/service/chat/channel_broker.go

func (s *StandaloneServer) sendToUser(message model.Message, originalAvatar string) {
    rsp := respond.GetMessageListRespond{
        SendId:     message.SendId,
        SendName:   message.SendName,
        SendAvatar: originalAvatar,
        ReceiveId:  message.ReceiveId,
        Type:       message.Type,
        Content:    message.Content,
        Url:        message.Url,
        FileSize:   message.FileSize,
        FileName:   message.FileName,
        FileType:   message.FileType,
        CreatedAt:  message.CreatedAt.Format("2006-01-02 15:04:05"),
    }

    jsonMessage, _ := json.Marshal(rsp)
    back := &MessageBack{Message: jsonMessage, Uuid: message.Uuid}

    // 1) æ¨ç»™æ¥æ”¶è€…ï¼ˆè‹¥åœ¨çº¿ï¼‰
    if v, ok := s.Clients.Load(message.ReceiveId); ok {
        v.(*UserConn).SendBack <- back
    }
    // 2) å›æ˜¾ç»™å‘é€è€…ï¼ˆè‹¥åœ¨çº¿ï¼‰
    if v, ok := s.Clients.Load(message.SendId); ok {
        v.(*UserConn).SendBack <- back
    }

    // 3) å¼‚æ­¥æ›´æ–°ç¼“å­˜
    if s.cacheService != nil {
        s.cacheService.SubmitTask(func() {
            userOne := message.SendId
            userTwo := message.ReceiveId
            if userOne > userTwo {
                userOne, userTwo = userTwo, userOne
            }
            key := "message_list_" + userOne + "_" + userTwo
            // GetOrError -> append -> Set
        })
    }
}
```

ä¸ºä»€ä¹ˆè¦â€œå›æ˜¾â€ï¼š

- å‘é€è€…å¯èƒ½å¤šç«¯åœ¨çº¿ï¼ˆæ‰‹æœº/ç”µè„‘ï¼‰ï¼Œå›æ˜¾èƒ½ä¿è¯è‡ªå·±æ‰€æœ‰ç«¯æ¶ˆæ¯åˆ—è¡¨åŒæ­¥

ç¼“å­˜ Keyï¼ˆä»¥ä»£ç ä¸ºå‡†ï¼‰ï¼š

- å•èŠï¼š`message_list_<userOne>_<userTwo>`ï¼ˆå…ˆæŒ‰å­—ç¬¦ä¸²å¤§å°æ’åºï¼Œä¿è¯åŒä¸€å¯¹ç”¨æˆ·åªæœ‰ä¸€ä¸ª keyï¼‰

---

## 6. ç¾¤èŠå¹¿æ’­ï¼šsendToGroupï¼ˆæˆå‘˜æŸ¥è¯¢ + å¹¿æ’­ + ç¼“å­˜ï¼‰

ç¾¤èŠä¸å•èŠçš„å…³é”®å·®å¼‚ï¼š

1. éœ€è¦å…ˆæŸ¥è¯¢æˆå‘˜åˆ—è¡¨
2. å¯¹æ¯ä¸ªæˆå‘˜åˆ¤æ–­æ˜¯å¦åœ¨çº¿ï¼Œåœ¨çº¿æ‰æ¨é€

```go
// internal/service/chat/channel_broker.go

func (s *StandaloneServer) sendToGroup(message model.Message, originalAvatar string) {
    rsp := respond.GetGroupMessageListRespond{
        SendId:     message.SendId,
        SendName:   message.SendName,
        SendAvatar: originalAvatar,
        ReceiveId:  message.ReceiveId,
        Type:       message.Type,
        Content:    message.Content,
        Url:        message.Url,
        FileSize:   message.FileSize,
        FileName:   message.FileName,
        FileType:   message.FileType,
        CreatedAt:  message.CreatedAt.Format("2006-01-02 15:04:05"),
    }
    jsonMessage, _ := json.Marshal(rsp)
    back := &MessageBack{Message: jsonMessage, Uuid: message.Uuid}

    // é€šè¿‡ Repository æŸ¥è¯¢ç¾¤æˆå‘˜
    var members []model.GroupMember
    if s.groupMemberRepo != nil {
        members, _ = s.groupMemberRepo.FindByGroupUuid(message.ReceiveId)
    }

    // åœ¨çº¿æ¨é€
    for _, gm := range members {
        if gm.UserUuid != message.SendId {
            if v, ok := s.Clients.Load(gm.UserUuid); ok {
                v.(*UserConn).SendBack <- back
            }
        } else {
            // å›æ˜¾ç»™è‡ªå·±
            if v, ok := s.Clients.Load(message.SendId); ok {
                v.(*UserConn).SendBack <- back
            }
        }
    }

    // å¼‚æ­¥æ›´æ–°ç¾¤èŠç¼“å­˜
    if s.cacheService != nil {
        s.cacheService.SubmitTask(func() {
            key := "group_messagelist_" + message.ReceiveId
            // GetOrError -> append -> Set
        })
    }
}
```

ç¼“å­˜ Keyï¼ˆä»¥ä»£ç ä¸ºå‡†ï¼‰ï¼š

- ç¾¤èŠï¼š`group_messagelist_<groupUuid>`ï¼ˆæ³¨æ„è¿™é‡Œçš„ `<groupUuid>` å®é™…æ˜¯ `ReceiveId`ï¼Œå½¢å¦‚ `Gxxxx`ï¼‰

---

## 7. æ–‡ä»¶æ¶ˆæ¯ä¸éŸ³è§†é¢‘ä¿¡ä»¤

### 7.1 æ–‡ä»¶æ¶ˆæ¯ï¼šhandleFileMessage

ä¸æ–‡æœ¬æ¶ˆæ¯ä¸»è¦å·®å¼‚ï¼š

- `Content` ä¸ºç©º
- `Url/FileSize/FileType/FileName` ä¼šè¢«å†™å…¥

### 7.2 éŸ³è§†é¢‘ä¿¡ä»¤ï¼šhandleAVMessage

ä»¥å½“å‰å®ç°ä¸ºå‡†ï¼š

- `av_data` ä¼šè¢«ååºåˆ—åŒ–ä¸º `AVData`
- åªæœ‰å½“ `MessageId == "PROXY"` ä¸” `Type` å±äº `start_call/receive_call/reject_call` æ—¶æ‰ä¼šå…¥åº“
- ä¿¡ä»¤ä¸€èˆ¬åªè½¬å‘ç»™æ¥æ”¶è€…ï¼Œä¸å›æ˜¾ç»™å‘é€è€…ï¼ˆé¿å…å‰ç«¯é‡å¤è§¦å‘ï¼‰

---

## 8. æµ‹è¯•æ¶ˆæ¯æ”¶å‘ï¼ˆæ³¨æ„å­—æ®µæ˜¯ snake_caseï¼‰

### 8.1 æµ‹è¯•å•èŠæ–‡æœ¬

```json
{
  "session_id": "S_123",
  "type": 0,
  "content": "Hello B",
  "send_id": "U_AAAA",
  "send_name": "å¼ ä¸‰",
  "send_avatar": "/static/avatars/xxx.jpg",
  "receive_id": "U_BBBB"
}
```

### 8.2 æµ‹è¯•ç¾¤èŠæ–‡æœ¬

```json
{
  "session_id": "S_456",
  "type": 0,
  "content": "Hello Group",
  "send_id": "U_AAAA",
  "send_name": "å¼ ä¸‰",
  "send_avatar": "/static/avatars/xxx.jpg",
  "receive_id": "G_CCCC"
}
```

---

## âœ… æœ¬ç« å°ç»“

- æ¶ˆæ¯å¤„ç†å‘ç”Ÿåœ¨ Broker å†…ï¼šè§£æ â†’ å…¥åº“ â†’ è·¯ç”±æ¨é€ â†’ å¼‚æ­¥ç¼“å­˜æ›´æ–°
- å•èŠï¼šæ¨é€ç»™æ¥æ”¶è€… + å›æ˜¾ç»™å‘é€è€…ï¼›ç¼“å­˜ key ä¼šå¯¹ä¸¤ç«¯ç”¨æˆ· id æ’åº
- ç¾¤èŠï¼šé€šè¿‡ `GroupMemberRepository` æŸ¥è¯¢æˆå‘˜ï¼Œåœ¨çº¿å¹¿æ’­ï¼›ç¼“å­˜ key ä¸º `group_messagelist_<groupUuid>`

ä¸‹ä¸€ç« è¿›å…¥ Kafka æ¨¡å¼ï¼šæ¶ˆæ¯å¦‚ä½•å‘å¸ƒåˆ° Kafkaã€æ¶ˆè´¹å¹¶è·¯ç”±åˆ°æœ¬æœºåœ¨çº¿ç”¨æˆ·ã€‚
