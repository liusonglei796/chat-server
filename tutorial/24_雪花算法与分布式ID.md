# 24. é›ªèŠ±ç®—æ³•ä¸åˆ†å¸ƒå¼ ID

> æœ¬æ•™ç¨‹å°†ä»‹ç»é›ªèŠ±ç®—æ³•çš„åŸç†å’Œå®ç°ï¼Œç”¨äºç”Ÿæˆæ¶ˆæ¯ç­‰å®ä½“çš„å”¯ä¸€ IDã€‚

---

## ğŸ“Œ å­¦ä¹ ç›®æ ‡

- ç†è§£é›ªèŠ±ç®—æ³•åŸç†
- é›†æˆ bwmarrin/snowflake åº“
- åœ¨æ¶ˆæ¯ç³»ç»Ÿä¸­åº”ç”¨é›ªèŠ± ID
- é¿å… JavaScript å¤§æ•°ç²¾åº¦ä¸¢å¤±

---

## 1. ä¸ºä»€ä¹ˆéœ€è¦é›ªèŠ±ç®—æ³•?

### 1.1 ä¼ ç»Ÿ ID æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|-----|------|------|
| MySQL è‡ªå¢ ID | ç®€å•ã€æœ‰åº | å•ç‚¹ç“¶é¢ˆã€åˆ†åº“åˆ†è¡¨å›°éš¾ |
| UUID | æ— ä¸­å¿ƒåŒ– | æ— åºã€36å­—ç¬¦è¿‡é•¿ã€ç´¢å¼•æ•ˆç‡ä½ |
| é›ªèŠ±ç®—æ³• | æœ‰åºã€é«˜æ€§èƒ½ã€åˆ†å¸ƒå¼ | ä¾èµ–æ—¶é’Ÿï¼Œéœ€é…ç½®æœºå™¨ ID |

### 1.2 é›ªèŠ± ID ç»“æ„

```
|  1 bit  |     41 bit      |  10 bit  |  12 bit  |
|   ç¬¦å·  |     æ—¶é—´æˆ³      |  æœºå™¨ID  |   åºåˆ—å·  |
|    0    |  69å¹´æ—¶é—´èŒƒå›´   |  1024å°  |  4096/ms |
```

- **æ€»é•¿åº¦**ï¼š64 bit (int64)
- **å®¹é‡**ï¼šæ¯æ¯«ç§’æ¯å°æœºå™¨å¯ç”Ÿæˆ 4096 ä¸ª ID
- **æœ‰åºæ€§**ï¼šID æŒ‰æ—¶é—´é€’å¢ï¼Œé€‚åˆæ•°æ®åº“ç´¢å¼•

---

## 2. å®‰è£…ä¾èµ–

```bash
go get github.com/bwmarrin/snowflake
```

---

## 3. é…ç½®æ–‡ä»¶

### 3.1 configs/config.toml

```toml
[snowflakeConfig]
machineID = 1  # æœºå™¨IDï¼ŒèŒƒå›´ 0-1023ï¼Œåˆ†å¸ƒå¼éƒ¨ç½²æ—¶æ¯å°æœºå™¨éœ€è¦ä¸åŒ
```

### 3.2 internal/config/config.go

```go
type SnowflakeConfig struct {
	MachineID int64 `toml:"machineID"`
}

type Config struct {
	// ...
	SnowflakeConfig SnowflakeConfig `toml:"snowflakeConfig"`
}
```

---

## 4. é›ªèŠ±ç®—æ³•å°è£…

### 4.1 pkg/util/snowflake/snowflake.go

```go
package snowflake

import (
	"sync"

	"github.com/bwmarrin/snowflake"
	"go.uber.org/zap"

	"kama_chat_server/internal/config"
)

var (
	node     *snowflake.Node
	nodeOnce sync.Once
)

// Init åˆå§‹åŒ–é›ªèŠ±ç®—æ³•èŠ‚ç‚¹
func Init() {
	nodeOnce.Do(func() {
		machineID := config.GetConfig().SnowflakeConfig.MachineID
		if machineID < 0 || machineID > 1023 {
			machineID = 1
			zap.L().Warn("Invalid MachineID, using default value 1")
		}
		var err error
		node, err = snowflake.NewNode(machineID)
		if err != nil {
			zap.L().Fatal("Failed to initialize snowflake node", zap.Error(err))
		}
		zap.L().Info("Snowflake node initialized", zap.Int64("machineID", machineID))
	})
}

// GenerateID ç”Ÿæˆé›ªèŠ± ID (int64)
func GenerateID() int64 {
	if node == nil {
		Init()
	}
	return node.Generate().Int64()
}

// GenerateIDString ç”Ÿæˆé›ªèŠ± ID (string)
// ç”¨äº JSON åºåˆ—åŒ–ï¼Œé¿å… JavaScript ç²¾åº¦ä¸¢å¤±
func GenerateIDString() string {
	if node == nil {
		Init()
	}
	return node.Generate().String()
}
```

---

## 5. åœ¨æ¶ˆæ¯æ¨¡å‹ä¸­ä½¿ç”¨

### 5.1 internal/model/message.go

```go
type Message struct {
	Uuid       int64     `gorm:"column:uuid;primaryKey"`  // é›ªèŠ± ID
	SessionId  string    `gorm:"column:session_id"`
	Type       int8      `gorm:"column:type"`
	Content    string    `gorm:"column:content"`
	// ...
	CreatedAt  time.Time `gorm:"column:created_at"`
}
```

### 5.2 æ¶ˆæ¯å¤„ç†ä¸­ä½¿ç”¨

```go
// internal/service/chat/channel_server.go

func (s *StandaloneServer) handleTextMessage(req request.ChatMessageRequest) {
	message := model.Message{
		Uuid:      snowflake.GenerateID(), // ä½¿ç”¨é›ªèŠ± ID
		SessionId: req.SessionId,
		// ...
	}
	dao.GormDB.Create(&message)
}
```

---

## 6. JavaScript ç²¾åº¦é—®é¢˜

### 6.1 é—®é¢˜æè¿°

JavaScript çš„ `Number` ç±»å‹æœ€å¤§å®‰å…¨æ•´æ•°ä¸º `2^53 - 1`ï¼š
- **æœ€å¤§å®‰å…¨å€¼**ï¼š9007199254740991
- **é›ªèŠ± ID ç¤ºä¾‹**ï¼š7452851789231923200 (è¶…å‡º)

### 6.2 è§£å†³æ–¹æ¡ˆ

**åç«¯**ï¼šJSON åºåˆ—åŒ–æ—¶å°† int64 è½¬ä¸º string

```go
type MessageBack struct {
	Message []byte
	Uuid    int64 // åœ¨ JSON å“åº”ä¸­è½¬ä¸º string
}

type GetMessageListRespond struct {
	Uuid    string `json:"uuid"` // ä½¿ç”¨ string ç±»å‹
	// ...
}
```

**å‰ç«¯**ï¼šä½¿ç”¨ BigInt æˆ–å­—ç¬¦ä¸²å¤„ç†

```javascript
// æ–¹æ¡ˆ1ï¼šä½¿ç”¨ BigInt
const id = BigInt("7452851789231923200");

// æ–¹æ¡ˆ2ï¼šä¿æŒå­—ç¬¦ä¸²
const message = JSON.parse(response);
const messageId = message.uuid; // å­—ç¬¦ä¸²ç±»å‹
```

---

## 7. åˆå§‹åŒ–é¡ºåº

### 7.1 main.go

```go
func main() {
	// 1. åŠ è½½é…ç½®
	config.LoadConfig()

	// 2. åˆå§‹åŒ–é›ªèŠ±ç®—æ³•
	snowflake.Init()

	// 3. åˆå§‹åŒ–æ•°æ®åº“ã€Redis ç­‰
	dao.Init()
	myredis.Init()

	// ...
}
```

---

## 8. åˆ†å¸ƒå¼éƒ¨ç½²æ³¨æ„äº‹é¡¹

### 8.1 æœºå™¨ ID åˆ†é…

| éƒ¨ç½²æ–¹å¼ | æœºå™¨ ID ç®¡ç† |
|---------|-------------|
| å•æœº | å›ºå®šä¸º 1 |
| Docker | ä½¿ç”¨ç¯å¢ƒå˜é‡æ³¨å…¥ |
| K8s | ä½¿ç”¨ StatefulSet åºå· |
| å¤šæœºæˆ¿ | å‰ç¼€åŒºåˆ†æœºæˆ¿ + æœºå™¨åºå· |

### 8.2 Docker é…ç½®ç¤ºä¾‹

```yaml
# docker-compose.yml
services:
  chat-server-1:
    environment:
      - MACHINE_ID=1
  chat-server-2:
    environment:
      - MACHINE_ID=2
```

```go
// è¯»å–ç¯å¢ƒå˜é‡
machineID, _ := strconv.ParseInt(os.Getenv("MACHINE_ID"), 10, 64)
```

---

## 9. æ—¶é’Ÿå›æ‹¨é—®é¢˜

### 9.1 é—®é¢˜æè¿°

é›ªèŠ±ç®—æ³•ä¾èµ–ç³»ç»Ÿæ—¶é’Ÿï¼Œå¦‚æœæ—¶é’Ÿå›æ‹¨ä¼šå¯¼è‡´ ID é‡å¤ã€‚

### 9.2 è§£å†³æ–¹æ¡ˆ

1. **NTP åŒæ­¥**ï¼šä½¿ç”¨ NTP æœåŠ¡ä¿æŒæ—¶é’ŸåŒæ­¥
2. **æ£€æµ‹å›æ‹¨**ï¼šbwmarrin/snowflake åº“ä¼šåœ¨æ—¶é’Ÿå›æ‹¨æ—¶é˜»å¡ç›´åˆ°è¿½ä¸Š

```go
// bwmarrin/snowflake å†…éƒ¨å®ç°
if now < n.time {
    // ç­‰å¾…æ—¶é’Ÿè¿½ä¸Š
    time.Sleep(time.Duration(n.time-now) * time.Millisecond)
}
```

---

## âœ… æœ¬èŠ‚å®Œæˆ

ä½ å·²ç»å®Œæˆäº†ï¼š
- [x] é›ªèŠ±ç®—æ³•åŸç†ç†è§£
- [x] bwmarrin/snowflake é›†æˆ
- [x] æ¶ˆæ¯ ID ç”Ÿæˆåº”ç”¨
- [x] JavaScript ç²¾åº¦é—®é¢˜è§£å†³
- [x] åˆ†å¸ƒå¼éƒ¨ç½²é…ç½®

---

## ğŸ“š ä¸‹ä¸€æ­¥

ç»§ç»­å­¦ä¹  [25_åç«¯æœåŠ¡ä¼˜åŒ–æŒ‡å—.md](25_åç«¯æœåŠ¡ä¼˜åŒ–æŒ‡å—.md)ï¼Œäº†è§£æ€§èƒ½ä¼˜åŒ–æŠ€å·§ã€‚
